<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>SQL TOURNAMENT PRO - ULTIMATE PRODUCTION</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --accent: #00ff88; 
            --gold: #ffd700; 
            --bg: #050505; 
            --card: #121212; 
            --border: #222; 
            --red: #ff4444; 
            --muted: #888; 
            --waiting: #ffae00; 
            --glass: rgba(20,20,20,0.95); 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        /* Anti-Copy System but allow-select for Room IDs */
        body { 
            margin: 0; 
            background: var(--bg); 
            color: #fff; 
            font-family: 'Poppins', sans-serif; 
            overflow-x: hidden;
            user-select: none; 
        }

        .allow-select, .room-data b, .utr-text { user-select: text !important; cursor: text; }

        /* --- HEADER --- */
        header { 
            background: #000; 
            padding: 15px; 
            border-bottom: 2px solid var(--gold); 
            text-align: center; 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.1); 
        }
        .header-title { color: var(--gold); font-weight: 800; font-size: 1.1rem; margin: 0; letter-spacing: 1px; text-transform: uppercase; }
        .header-sub { color: var(--accent); font-size: 0.75rem; display: block; margin-top: 2px; font-weight: 600; }
        .menu-btn { position: absolute; right: 20px; top: 18px; color: var(--gold); font-size: 1.4rem; cursor: pointer; }

        /* --- TABS --- */
        .tabs { display: flex; gap: 8px; margin: 12px; background: #111; border-radius: 12px; border: 1px solid var(--border); padding: 6px; }
        .tab { flex: 1; padding: 12px; border: none; background: none; color: var(--muted); font-weight: 700; font-size: 0.85rem; cursor: pointer; transition: 0.3s; text-align: center; border-radius: 10px; }
        .tab.active { background: var(--accent); color: #000; box-shadow: 0 0 15px rgba(0, 255, 136, 0.3); }

        /* --- APP CONTENT & GRID --- */
        #app-content { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); 
            gap: 15px; 
            padding: 10px 15px 100px 15px; 
        }
        @media (min-width: 768px) {
            #app-content { grid-template-columns: 1fr 1fr; }
        }

        /* --- MATCH CARDS --- */
        .card { background: var(--card); border-radius: 20px; border: 1px solid var(--border); overflow: hidden; position: relative; transition: 0.3s; }
        .card:hover { border-color: var(--accent); transform: translateY(-3px); }
        .m-tag { position: absolute; top: 12px; right: 15px; font-size: 0.7rem; background: #000; padding: 5px 10px; border: 1px solid var(--accent); border-radius: 8px; color: var(--accent); font-weight: 800; }
        
        .card-body { padding: 18px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: center; }
        .item { display: flex; gap: 12px; align-items: center; }
        .item i { color: var(--gold); font-size: 1.1rem; width: 22px; text-align: center; }
        .item div span { display: block; font-size: 0.65rem; color: var(--muted); text-transform: uppercase; font-weight: 600; }
        .item div b { font-size: 0.95rem; color: #fff; }

        .timer-box { background: #080808; padding: 12px; text-align: center; border-top: 1px solid #222; border-bottom: 1px solid #222; }
        .countdown { font-family: 'Courier New', monospace; font-size: 1.2rem; color: var(--waiting); font-weight: 900; letter-spacing: 1.5px; }

        .card-footer { padding: 16px; }
        .slots { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 10px; font-weight: 800; }
        .bar { height: 10px; background: #222; border-radius: 20px; overflow: hidden; margin-bottom: 15px; }
        .fill { height: 100%; background: linear-gradient(90deg, var(--accent), #008f4c); transition: 1.5s cubic-bezier(0.1, 0, 0.1, 1); }

        .btn-main { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: 900; font-size: 1rem; cursor: pointer; transition: 0.2s; text-transform: uppercase; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-join { background: var(--accent); color: #000; box-shadow: 0 4px 15px rgba(0, 255, 136, 0.2); }
        .btn-dis { background: #1a1a1a; color: #555; cursor: not-allowed; border: 1px solid #333; }

        /* --- ROOM DETAILS BOX --- */
        .room-box { background: rgba(0, 255, 136, 0.08); border: 2px dashed var(--accent); padding: 15px; border-radius: 15px; text-align: center; margin-bottom: 15px; animation: glow 2s infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 5px rgba(0, 255, 136, 0.1); } to { box-shadow: 0 0 15px rgba(0, 255, 136, 0.3); } }
        .room-data { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
        .room-data div { background: #000; padding: 10px; border-radius: 10px; border: 1px solid #333; }
        .room-data div b { font-size: 1.1rem; color: #fff; font-family: monospace; }

        /* --- SIDE MENU --- */
        #side-menu { position: fixed; top: 0; right: -100%; width: 310px; height: 100%; background: #0a0a0a; z-index: 5000; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); border-left: 1px solid var(--gold); }
        #side-menu.active { right: 0; box-shadow: -15px 0 50px rgba(0,0,0,0.9); }
        .menu-header { padding: 25px 20px; border-bottom: 1px solid #222; display: flex; align-items: center; gap: 15px; background: #000; }
        .menu-dp { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; border: 2px solid var(--gold); }
        .menu-link { display: flex; align-items: center; gap: 18px; padding: 18px 20px; color: #eee; text-decoration: none; border-bottom: 1px solid #161616; font-weight: 600; transition: 0.3s; }
        .menu-link i { color: var(--gold); width: 25px; text-align: center; }
        .menu-link:hover { background: #111; color: var(--accent); padding-left: 25px; }

        /* --- PROFILE SECTION --- */
        .profile-head { background: linear-gradient(180deg, #1a1a1a, #050505); padding: 25px; border-radius: 20px; text-align: center; border: 1px solid #333; margin-bottom: 20px; }
        .stats-box { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin: 20px 0; }
        .stat-item { background: #0b0b0b; padding: 15px 5px; border-radius: 15px; border: 1px solid #222; }
        .stat-lbl { font-size: 0.65rem; color: #888; font-weight: 800; display: block; margin-bottom: 5px; }
        .stat-val { font-size: 1.1rem; font-weight: 800; }

        /* --- RESULTS --- */
        .result-card { background: #121212; border-radius: 20px; border: 1px solid #222; margin-bottom: 20px; overflow: hidden; }
        .r-img { width: 100%; height: 220px; object-fit: cover; border-bottom: 1px solid #222; }
        .winner-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; background: rgba(255, 215, 0, 0.05); }
        .win-info { font-size: 0.8rem; }
        .win-info b { color: var(--gold); display: block; font-size: 1rem; }

        /* --- MODALS --- */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 6000; display: none; align-items: center; justify-content: center; padding: 15px; backdrop-filter: blur(10px); }
        .modal-ui { background: #111; width: 100%; max-width: 450px; padding: 30px; border-radius: 25px; border: 1px solid var(--gold); position: relative; max-height: 90vh; overflow-y: auto; }
        input { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; font-size: 1rem; outline: none; }
        input:focus { border-color: var(--accent); box-shadow: 0 0 10px rgba(0,255,136,0.1); }

        /* --- LOADER --- */
        .loader { width: 40px; height: 40px; border: 4px solid #222; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 40px auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>

<body>

<header>
    <p class="header-title">SQL TOURNAMENT PRO</p>
    <span class="header-sub">V2.0 ULTIMATE PRODUCTION UNIT</span>
    <div class="menu-btn" onclick="toggleMenu(true)"><i class="fas fa-bars-staggered"></i></div>
</header>

<div class="tabs">
    <button class="tab active" id="tab-live" onclick="switchTab('live')">LIVE MATCHES</button>
    <button class="tab" id="tab-my" onclick="switchTab('my')">MY PROFILE</button>
    <button class="tab" id="tab-result" onclick="switchTab('result')">RESULTS</button>
</div>

<main id="app-content"></main>

<div id="side-menu">
    <div style="position:absolute; top:20px; left:20px; font-size:1.5rem; color:var(--red);" onclick="toggleMenu(false)">&times;</div>
    <div class="menu-header">
        <img id="menu-user-dp" src="https://img.icons8.com/color/96/user-male-circle.png" class="menu-dp">
        <div>
            <div id="menu-user-name" style="font-weight:800; color:#fff; font-size:1.1rem;">Guest User</div>
            <div id="menu-user-bal-side" style="font-size:0.85rem; color:var(--accent); font-weight:600;">Wallet: ₹0.00</div>
        </div>
    </div>
    <div class="menu-items" style="padding: 10px 0;">
        <a href="#" class="menu-link" onclick="location.reload()"><i class="fas fa-rotate"></i> Refresh App</a>
        <a href="#" class="menu-link" onclick="openWalletModal('add'); toggleMenu(false)"><i class="fas fa-wallet"></i> Add Funds</a>
        <a href="#" class="menu-link" onclick="openHistoryModal()"><i class="fas fa-receipt"></i> Payment History</a>
        <a href="https://chat.whatsapp.com/JR7wAllMf4SAyILFHDQClQ" target="_blank" class="menu-link"><i class="fab fa-whatsapp"></i> WhatsApp Support</a>
        <a href="#" class="menu-link" onclick="showRules(); toggleMenu(false)"><i class="fas fa-file-contract"></i> Fair Play Rules</a>
        <div id="auth-section-menu">
            <a href="#" class="menu-link" onclick="openAuthModal('login'); toggleMenu(false)"><i class="fas fa-sign-in-alt"></i> Login / Register</a>
        </div>
        <button id="logout-btn" onclick="handleLogout()" class="btn-main" style="background:#1a1a1a; color:var(--red); width:90%; margin:20px auto; display:none;">LOGOUT</button>
    </div>
</div>

<div id="auth-modal" class="modal">
    <div class="modal-ui">
        <h2 id="auth-title" style="color:var(--gold); text-align:center; margin-bottom:25px;">LOGIN</h2>
        <div id="auth-form-container"></div>
        <button id="auth-main-btn" class="btn-main btn-join" onclick="processAuthStep()">CONTINUE</button>
        <p id="auth-toggle-text" style="text-align:center; color:#666; margin-top:20px; font-size:0.9rem; cursor:pointer;" onclick="toggleAuthMode()">
            Don't have an account? <span style="color:var(--accent); font-weight:bold;">Register</span>
        </p>
        <p style="text-align:center; color:var(--gold); font-size:0.8rem; margin-top:10px; cursor:pointer;" onclick="showRecovery()">Forgot Password?</p>
    </div>
</div>

<div id="pay-modal" class="modal">
    <div class="modal-ui">
        <h3 style="color:var(--gold); text-align:center; margin-top:0;">CONFIRM JOINING</h3>
        <div style="text-align:center; padding:20px 0;">
            <span style="color:#888; display:block; font-size:0.9rem;">Amount to Pay</span>
            <h1 id="pay-amt-display" style="font-size:3rem; color:var(--accent); margin:5px 0;">₹0</h1>
        </div>
        
        <div id="wallet-pay-box" style="display:none; background:#000; border:1px solid var(--accent); padding:15px; border-radius:15px; margin-bottom:20px; text-align:center;">
            <p style="margin:0; font-size:0.8rem; color:#888;">Wallet Balance: <b id="modal-wallet-bal" style="color:#fff;">₹0</b></p>
            <button class="btn-main btn-join" style="margin-top:10px;" onclick="payUsingWallet()">PAY FROM WALLET</button>
        </div>

        <div style="text-align:center; color:#444; margin-bottom:15px; font-size:0.8rem;">--- OR PAY VIA UPI ---</div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:20px;">
            <a id="upi-gpay" href="#" class="btn-main" style="background:#1a1a1a; padding:10px;"><img src="https://img.icons8.com/color/48/google-pay.png" width="30"></a>
            <a id="upi-phonepe" href="#" class="btn-main" style="background:#1a1a1a; padding:10px;"><img src="https://img.icons8.com/color/48/phone-pe.png" width="30"></a>
            <a id="upi-paytm" href="#" class="btn-main" style="background:#1a1a1a; padding:10px;"><img src="https://img.icons8.com/color/48/paytm.png" width="30"></a>
        </div>

        <input type="number" id="utr-input" placeholder="Enter 12 Digit UTR/Ref No" maxlength="12">
        <button class="btn-main btn-join" onclick="submitManualPayment()">SUBMIT PAYMENT</button>
        <button onclick="closeModal('pay-modal')" style="width:100%; background:none; border:none; color:#555; margin-top:15px; font-weight:bold; cursor:pointer;">CANCEL</button>
    </div>
</div>

<div id="wallet-modal" class="modal">
    <div class="modal-ui">
        <h3 id="wallet-title" style="color:var(--gold); text-align:center;">ADD MONEY</h3>
        <div id="add-fund-ui">
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:20px;">
                <button class="small-btn" onclick="setAmt(50)" style="background:#1a1a1a; color:#fff; padding:10px; border:1px solid #333; border-radius:8px;">₹50</button>
                <button class="small-btn" onclick="setAmt(100)" style="background:#1a1a1a; color:#fff; padding:10px; border:1px solid #333; border-radius:8px;">₹100</button>
                <button class="small-btn" onclick="setAmt(500)" style="background:#1a1a1a; color:#fff; padding:10px; border:1px solid #333; border-radius:8px;">₹500</button>
            </div>
            <input type="number" id="wallet-amt-input" placeholder="Enter Custom Amount">
            <button class="btn-main btn-join" onclick="initWalletDeposit()">PROCEED TO PAY</button>
        </div>
        <div id="withdraw-ui" style="display:none;">
            <input type="number" id="with-amt" placeholder="Minimum ₹50">
            <input type="text" id="with-upi" placeholder="Your UPI ID (e.g. name@apl)">
            <button class="btn-main" style="background:var(--gold); color:#000;" onclick="handleWithdraw()">REQUEST WITHDRAW</button>
        </div>
        <button onclick="closeModal('wallet-modal')" style="width:100%; background:none; border:none; color:#555; margin-top:15px; font-weight:bold; cursor:pointer;">CLOSE</button>
    </div>
</div>

<div id="history-modal" class="modal">
    <div class="modal-ui">
        <h3 style="color:var(--gold); text-align:center;">TRANSACTION HISTORY</h3>
        <div id="history-content" style="margin-top:20px;"></div>
        <button onclick="closeModal('history-modal')" class="btn-main" style="margin-top:20px; background:#222;">CLOSE</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getFirestore, collection, doc, setDoc, getDoc, updateDoc, 
        onSnapshot, query, where, orderBy, limit, increment, runTransaction, arrayUnion, addDoc 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyBvObxADcAior6R_or9O6UmWsFT8do1GkI",
        authDomain: "sqladmin-ff04d.firebaseapp.com",
        projectId: "sqladmin-ff04d",
        storageBucket: "sqladmin-ff04d.firebasestorage.app",
        messagingSenderId: "539086978850",
        appId: "1:539086978850:web:261e6a0cf3c9a2aa29ef7b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- STATE ---
    let activeTab = 'live';
    let currentUser = JSON.parse(localStorage.getItem('sql_pro_user')) || null;
    let currentAuthMode = 'login'; // login, register, otp, recovery
    let pendingAuthData = null;
    let walletUnsub = null;
    let matchUnsub = null;

    // --- CORE INITIALIZATION ---
    window.onload = () => {
        if(currentUser) {
            startWalletSync();
            updateMenuUI();
        }
        renderUI();
    };

    // --- TAB SYSTEM ---
    window.switchTab = (tab) => {
        activeTab = tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        
        // Cleanup old listeners
        if(matchUnsub) matchUnsub();
        renderUI();
    };

    async function renderUI() {
        const container = document.getElementById('app-content');
        container.innerHTML = '<div class="loader"></div>';

        if(activeTab === 'live') fetchMatches(container);
        else if(activeTab === 'my') renderProfile(container);
        else if(activeTab === 'result') fetchResults(container);
    }

    // --- MATCHES ENGINE ---
    function fetchMatches(container) {
        matchUnsub = onSnapshot(collection(db, "matches"), (snap) => {
            if(activeTab !== 'live') return;
            container.innerHTML = "";
            if(snap.empty) {
                container.innerHTML = "<div style='text-align:center; grid-column:1/-1; padding:50px; color:#555;'>No live matches available.</div>";
                return;
            }

            snap.forEach(d => {
                const m = d.data();
                const mid = d.id;
                const isFull = (m.joined || 0) >= (m.total || 48);
                const isJoined = currentUser && m.participants?.includes(currentUser.phone);
                const startTime = m.startTime || Date.now();
                const isStarted = Date.now() > startTime;

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="m-tag">${m.map || 'Bermuda'}</div>
                    <div class="card-body">
                        <div class="item"><i class="fas fa-trophy"></i><div><span>Win Prize</span><b style="color:var(--accent)">₹${m.win}</b></div></div>
                        <div class="item"><i class="fas fa-ticket"></i><div><span>Entry Fee</span><b style="color:var(--gold)">₹${m.entry}</b></div></div>
                        <div class="item"><i class="fas fa-users"></i><div><span>Team</span><b>${m.type || 'Solo'}</b></div></div>
                        <div class="item"><i class="fas fa-clock"></i><div><span>Start Time</span><b>${new Date(startTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</b></div></div>
                    </div>
                    <div class="timer-box">
                        <div class="countdown" data-time="${startTime}">00:00:00</div>
                    </div>
                    <div class="card-footer">
                        <div class="slots"><span>Slots: ${m.joined || 0}/${m.total || 48}</span><span style="color:var(--waiting)">${(m.total||48)-(m.joined||0)} Left</span></div>
                        <div class="bar"><div class="fill" style="width:${((m.joined||0)/(m.total||48))*100}%"></div></div>
                        ${isJoined ? renderRoomBox(m) : renderJoinButton(mid, m.entry, isFull, isStarted)}
                    </div>
                `;
                container.appendChild(card);
            });
        });
    }

    function renderRoomBox(m) {
        if(m.roomId && m.roomId !== "") {
            return `
                <div class="room-box">
                    <span style="font-size:0.7rem; color:var(--accent); font-weight:800;">MATCH SECURED - ROOM LIVE</span>
                    <div class="room-data">
                        <div><span>ID</span><b class="allow-select">${m.roomId}</b></div>
                        <div><span>PASS</span><b class="allow-select">${m.password}</b></div>
                    </div>
                </div>
                <button class="btn-main btn-dis">ALREADY JOINED</button>`;
        }
        return `
            <div class="room-box" style="border-color:#555;">
                <span style="font-size:0.7rem; color:#888;">ROOM ID WILL APPEAR 15 MINS BEFORE</span>
            </div>
            <button class="btn-main btn-dis">JOINED & WAITING</button>`;
    }

    function renderJoinButton(id, entry, full, started) {
        if(started) return `<button class="btn-main btn-dis">MATCH STARTED</button>`;
        if(full) return `<button class="btn-main btn-dis">HOUSE FULL</button>`;
        return `<button class="btn-main btn-join" onclick="openPaymentModal('${id}', ${entry})"><i class="fas fa-plus-circle"></i> JOIN NOW ₹${entry}</button>`;
    }

    // --- PROFILE ENGINE ---
    async function renderProfile(container) {
        if(!currentUser) {
            container.innerHTML = `<div style="text-align:center; grid-column:1/-1; padding:50px;">
                <i class="fas fa-user-lock" style="font-size:4rem; color:#222; margin-bottom:20px;"></i>
                <h3>Login Required</h3>
                <button class="btn-main btn-join" onclick="openAuthModal('login')" style="width:200px; margin:20px auto;">GO TO LOGIN</button>
            </div>`;
            return;
        }

        container.innerHTML = `
            <div class="profile-head" style="grid-column: 1/-1;">
                <div style="position:relative; width:90px; height:90px; margin:0 auto 15px;">
                    <img src="${currentUser.dpUrl || 'https://img.icons8.com/color/96/user-male-circle.png'}" class="menu-dp" style="width:100%; height:100%;">
                    <div onclick="document.getElementById('dp-input').click()" style="position:absolute; bottom:0; right:0; background:var(--gold); border:2px solid #000; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                        <i class="fas fa-camera" style="font-size:0.7rem; color:#000;"></i>
                    </div>
                    <input type="file" id="dp-input" hidden onchange="uploadDP(this)">
                </div>
                <h2 style="margin:0;">${currentUser.name}</h2>
                <span style="color:var(--muted); font-size:0.8rem;">+91 ${currentUser.phone} | UID: ${currentUser.gamingName || 'Not Set'}</span>
                
                <div class="stats-box">
                    <div class="stat-item">
                        <span class="stat-lbl">WALLET</span>
                        <div class="stat-val" style="color:var(--gold)">₹${(currentUser.balance || 0).toFixed(2)}</div>
                    </div>
                    <div class="stat-item" onclick="showActiveGames()" style="cursor:pointer; border-color:var(--accent);">
                        <span class="stat-lbl">JOINED GAMES</span>
                        <div class="stat-val" style="color:var(--accent)" id="active-count">0</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-lbl">TOTAL WON</span>
                        <div class="stat-val" style="color:var(--accent)">₹${currentUser.totalWon || 0}</div>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button class="btn-main btn-join" onclick="openWalletModal('add')"><i class="fas fa-plus"></i> ADD CASH</button>
                    <button class="btn-main" style="background:#222;" onclick="openWalletModal('with')"><i class="fas fa-arrow-up"></i> WITHDRAW</button>
                </div>
            </div>
            <div id="active-games-list" style="grid-column:1/-1;"></div>
        `;
        
        // Load active count
        const qCount = query(collection(db, "matches"), where("participants", "array-contains", currentUser.phone));
        const qSnap = await getDoc(qCount); // This is simplified, real logic below
        showActiveGames();
    }

    window.showActiveGames = async () => {
        const listDiv = document.getElementById('active-games-list');
        listDiv.innerHTML = '<div class="loader"></div>';
        
        const q = query(collection(db, "matches"), where("participants", "array-contains", currentUser.phone));
        const snap = await getDocs(q);
        
        document.getElementById('active-count').innerText = snap.size;
        listDiv.innerHTML = `<h4 style="margin:20px 0 10px; color:var(--gold);">MY ACTIVE / JOINED MATCHES</h4>`;
        
        if(snap.empty) {
            listDiv.innerHTML += `<div style="padding:30px; background:#111; border-radius:15px; text-align:center; color:#555;">You haven't joined any matches yet.</div>`;
            return;
        }

        snap.forEach(d => {
            const m = d.data();
            listDiv.innerHTML += `
                <div class="card" style="margin-bottom:15px; border-style:dashed;">
                    <div class="card-body">
                        <div><b style="color:var(--accent)">${m.type} - ${m.map}</b><br><small style="color:#666">${new Date(m.startTime).toLocaleString()}</small></div>
                        <div style="text-align:right">${m.roomId ? '<span style="color:var(--accent)">Room Ready</span>' : '<span style="color:var(--waiting)">Pending Room</span>'}</div>
                    </div>
                </div>
            `;
        });
    }

    // --- RESULTS ENGINE ---
    function fetchResults(container) {
        const q = query(collection(db, "results"), orderBy("timestamp", "desc"), limit(15));
        onSnapshot(q, (snap) => {
            if(activeTab !== 'result') return;
            container.innerHTML = "";
            
            snap.forEach(d => {
                const r = d.data();
                container.innerHTML += `
                    <div class="result-card">
                        <div style="padding:15px; border-bottom:1px solid #222; display:flex; justify-content:space-between; align-items:center;">
                            <b>${r.matchTitle || 'Tournament Finished'}</b>
                            <small style="color:#666;">${new Date(r.timestamp).toLocaleDateString()}</small>
                        </div>
                        ${r.image ? `<img src="${r.image}" class="r-img">` : ''}
                        <div class="winner-grid">
                            <div class="win-info">WINNER NAME<b>${r.winnerName || 'Unknown'}</b></div>
                            <div class="win-info">WINNER UID<b>${r.winnerUID || '0000000'}</b></div>
                            <div class="win-info">TOTAL KILLS<b>${r.kills || 0}</b></div>
                            <div class="win-info">WINNINGS<b>₹${r.prize || 0}</b></div>
                        </div>
                        <div style="padding:15px; background:#080808; font-size:0.85rem; color:#aaa; line-height:1.5;">
                            <i class="fas fa-quote-left" style="color:var(--gold); margin-right:8px;"></i>
                            ${r.message || 'Well played to everyone who participated! Official results are updated.'}
                        </div>
                    </div>
                `;
            });
        });
    }

    // --- AUTHENTICATION & OTP LOGIC ---
    window.openAuthModal = (mode) => {
        currentAuthMode = mode;
        document.getElementById('auth-modal').style.display = 'flex';
        renderAuthUI();
    };

    function renderAuthUI() {
        const container = document.getElementById('auth-form-container');
        const title = document.getElementById('auth-title');
        const btn = document.getElementById('auth-main-btn');
        const toggle = document.getElementById('auth-toggle-text');

        if(currentAuthMode === 'login') {
            title.innerText = "WELCOME BACK";
            btn.innerText = "LOGIN";
            toggle.innerHTML = `New here? <span style="color:var(--accent)">Register</span>`;
            container.innerHTML = `
                <input type="number" id="auth-phone" placeholder="Phone Number">
                <input type="password" id="auth-pass" placeholder="Password">
            `;
        } else if(currentAuthMode === 'register') {
            title.innerText = "CREATE ACCOUNT";
            btn.innerText = "SEND OTP";
            toggle.innerHTML = `Have an account? <span style="color:var(--accent)">Login</span>`;
            container.innerHTML = `
                <input type="text" id="auth-name" placeholder="Full Name">
                <input type="number" id="auth-phone" placeholder="10-Digit Phone Number">
                <input type="text" id="auth-gaming" placeholder="Free Fire UID (Optional)">
                <input type="password" id="auth-pass" placeholder="Create Password">
            `;
        } else if(currentAuthMode === 'otp') {
            title.innerText = "VERIFY OTP";
            btn.innerText = "VERIFY & FINISH";
            toggle.innerText = "Resend OTP in 30s";
            container.innerHTML = `
                <p style="text-align:center; color:#888;">Enter 4-digit OTP sent to your phone</p>
                <input type="number" id="auth-otp" placeholder="0000" style="text-align:center; letter-spacing:10px; font-size:1.5rem;">
            `;
        }
    }

    window.processAuthStep = async () => {
        const btn = document.getElementById('auth-main-btn');
        btn.disabled = true;
        btn.innerText = "PLEASE WAIT...";

        try {
            if(currentAuthMode === 'login') {
                const phone = document.getElementById('auth-phone').value;
                const pass = document.getElementById('auth-pass').value;
                const snap = await getDoc(doc(db, "users", phone));
                
                if(!snap.exists() || snap.data().password !== pass) throw "Invalid Credentials!";
                
                currentUser = snap.data();
                saveAndInit();
            } 
            else if(currentAuthMode === 'register') {
                const phone = document.getElementById('auth-phone').value;
                if(phone.length !== 10) throw "Valid 10-digit phone required";
                
                // Duplicate Check
                const snap = await getDoc(doc(db, "users", phone));
                if(snap.exists()) throw "User already exists!";

                pendingAuthData = {
                    name: document.getElementById('auth-name').value,
                    phone: phone,
                    gamingName: document.getElementById('auth-gaming').value,
                    password: document.getElementById('auth-pass').value,
                    balance: 0,
                    totalWon: 0,
                    otp: Math.floor(1000 + Math.random() * 9000).toString()
                };

                // Store OTP in temp DB for verification
                await setDoc(doc(db, "temp_otps", phone), { otp: pendingAuthData.otp });
                alert("DEBUG: Your OTP is " + pendingAuthData.otp); // Real production uses SMS API here
                currentAuthMode = 'otp';
                renderAuthUI();
            }
            else if(currentAuthMode === 'otp') {
                const userOtp = document.getElementById('auth-otp').value;
                if(userOtp === pendingAuthData.otp) {
                    await setDoc(doc(db, "users", pendingAuthData.phone), pendingAuthData);
                    currentUser = pendingAuthData;
                    saveAndInit();
                } else {
                    throw "Wrong OTP!";
                }
            }
        } catch(e) {
            alert(e);
        } finally {
            btn.disabled = false;
            btn.innerText = "CONTINUE";
        }
    };

    function saveAndInit() {
        localStorage.setItem('sql_pro_user', JSON.stringify(currentUser));
        document.getElementById('auth-modal').style.display = 'none';
        startWalletSync();
        updateMenuUI();
        renderUI();
    }

    // --- WALLET & ATOMIC TRANSACTIONS ---
    function startWalletSync() {
        if(walletUnsub) walletUnsub();
        walletUnsub = onSnapshot(doc(db, "users", currentUser.phone), (snap) => {
            if(snap.exists()) {
                currentUser = snap.data();
                localStorage.setItem('sql_pro_user', JSON.stringify(currentUser));
                document.getElementById('menu-user-bal-side').innerText = `Wallet: ₹${currentUser.balance.toFixed(2)}`;
                if(activeTab === 'my') document.getElementById('active-count')?.parentElement.querySelector('.stat-val').innerText = `₹${currentUser.balance.toFixed(2)}`;
            }
        });
    }

    window.payUsingWallet = async () => {
        const mid = window.activeMatchId;
        const entry = window.activeEntryFee;

        if(currentUser.balance < entry) return alert("Low Balance! Add funds first.");

        if(confirm(`Confirm joining for ₹${entry}?`)) {
            try {
                await runTransaction(db, async (transaction) => {
                    const matchRef = doc(db, "matches", mid);
                    const userRef = doc(db, "users", currentUser.phone);
                    
                    const mSnap = await transaction.get(matchRef);
                    const uSnap = await transaction.get(userRef);

                    if(mSnap.data().joined >= mSnap.data().total) throw "Match just got full!";
                    if(uSnap.data().balance < entry) throw "Insufficient Balance!";

                    transaction.update(userRef, { balance: increment(-entry) });
                    transaction.update(matchRef, { 
                        joined: increment(1),
                        participants: arrayUnion(currentUser.phone)
                    });
                });
                alert("Successfully Joined!");
                closeModal('pay-modal');
            } catch(e) {
                alert(e);
            }
        }
    };

    window.submitManualPayment = async () => {
        const utr = document.getElementById('utr-input').value;
        if(utr.length !== 12) return alert("Enter 12-digit UTR");

        try {
            const utrRef = doc(db, "payments", utr);
            const utrSnap = await getDoc(utrRef);
            if(utrSnap.exists()) throw "This UTR is already used!";

            await setDoc(utrRef, {
                utr: utr,
                userId: currentUser.phone,
                userName: currentUser.name,
                matchId: window.activeMatchId,
                amount: window.activeEntryFee,
                status: 'pending',
                timestamp: Date.now()
            });
            alert("Payment submitted! Admin will verify and add you to the match.");
            closeModal('pay-modal');
        } catch(e) {
            alert(e);
        }
    };

    // --- HELPERS ---
    window.toggleMenu = (s) => document.getElementById('side-menu').classList.toggle('active', s);
    window.closeModal = (id) => document.getElementById(id).style.display = 'none';
    window.openPaymentModal = (id, amt) => {
        if(!currentUser) return openAuthModal('login');
        window.activeMatchId = id;
        window.activeEntryFee = amt;
        document.getElementById('pay-amt-display').innerText = `₹${amt}`;
        document.getElementById('pay-modal').style.display = 'flex';
        document.getElementById('wallet-pay-box').style.display = 'block';
        document.getElementById('modal-wallet-bal').innerText = `₹${currentUser.balance.toFixed(2)}`;
        
        const upiStr = `upi://pay?pa=rizwanhasan90122778623@ybl&am=${amt}&tn=Match_${id}`;
        document.getElementById('upi-gpay').href = upiStr;
        document.getElementById('upi-phonepe').href = upiStr;
        document.getElementById('upi-paytm').href = upiStr;
    };

    window.openWalletModal = (type) => {
        document.getElementById('wallet-modal').style.display = 'flex';
        if(type === 'add') {
            document.getElementById('wallet-title').innerText = "ADD MONEY";
            document.getElementById('add-fund-ui').style.display = 'block';
            document.getElementById('withdraw-ui').style.display = 'none';
        } else {
            document.getElementById('wallet-title').innerText = "WITHDRAW CASH";
            document.getElementById('add-fund-ui').style.display = 'none';
            document.getElementById('withdraw-ui').style.display = 'block';
        }
    };

    window.handleLogout = () => {
        localStorage.removeItem('sql_pro_user');
        location.reload();
    };

    window.showRecovery = () => {
        const ph = prompt("Enter registered phone for recovery:");
        if(ph) alert("If account exists, recovery OTP will be sent.");
    };

    function updateMenuUI() {
        if(!currentUser) return;
        document.getElementById('menu-user-name').innerText = currentUser.name;
        document.getElementById('menu-user-dp').src = currentUser.dpUrl || 'https://img.icons8.com/color/96/user-male-circle.png';
        document.getElementById('logout-btn').style.display = 'block';
        document.getElementById('auth-section-menu').style.display = 'none';
    }

    // --- TIMERS ---
    setInterval(() => {
        document.querySelectorAll('.countdown').forEach(el => {
            const target = parseInt(el.dataset.time);
            const diff = target - Date.now();
            if(diff <= 0) {
                el.innerText = "MATCH LIVE";
                el.style.color = "var(--accent)";
            } else {
                const h = Math.floor(diff/3600000), m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000);
                el.innerText = `${h}h : ${m}m : ${s}s`;
            }
        });
    }, 1000);

</script>

</body>
    </html>

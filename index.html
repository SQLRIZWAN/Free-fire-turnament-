<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SQL TOURNAMENT PRO - ADVANCE EDITION</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root { 
            --accent: #00ff88; --gold: #ffd700; --bg: #050505; 
            --card: #121212; --border: #222; --red: #ff4444; 
            --profit: #00ff66; --loss: #ff3333; --ai-bg: #1a1a1a;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: 'Poppins', sans-serif; overflow-x: hidden; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 0; display: none; }

        /* Header Section */
        header { 
            background: #000; padding: 12px 15px; border-bottom: 2px solid var(--gold);
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 1000;
        }
        .header-info h1 { font-size: 0.9rem; color: var(--gold); margin: 0; letter-spacing: 1px; font-weight: 800; }
        .pfp-nav { width: 38px; height: 38px; border-radius: 50%; border: 2px solid var(--gold); object-fit: cover; cursor: pointer; background: #222; }

        /* Navigation Tabs */
        .nav-scroll { display: flex; gap: 10px; padding: 15px; overflow-x: auto; background: #080808; border-bottom: 1px solid #111; }
        .nav-btn { 
            padding: 10px 20px; border-radius: 25px; background: #111; border: 1px solid var(--border);
            color: #888; font-size: 0.75rem; font-weight: 700; white-space: nowrap; cursor: pointer; transition: 0.3s;
        }
        .nav-btn.active { background: var(--accent); color: #000; border-color: var(--accent); box-shadow: 0 0 15px rgba(0,255,136,0.3); }

        /* Tournament Cards Grid */
        .match-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 15px 12px 100px; }
        .m-card { background: var(--card); border-radius: 18px; border: 1px solid var(--border); overflow: hidden; position: relative; transition: 0.3s; }
        .m-card:active { transform: scale(0.97); }
        .m-type-tag { position: absolute; top: 8px; right: 10px; font-size: 0.55rem; color: var(--gold); font-weight: 800; z-index: 2; background: rgba(0,0,0,0.7); padding: 2px 6px; border-radius: 4px; }
        .m-img { width: 100%; height: 75px; object-fit: cover; opacity: 0.5; background: #333; }
        
        .m-content { padding: 10px; text-align: center; }
        .m-title { font-size: 0.75rem; font-weight: 800; display: block; margin-bottom: 8px; color: #fff; text-transform: uppercase; }
        
        .m-stats { display: flex; justify-content: space-around; background: #000; padding: 6px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #1a1a1a; }
        .stat-item span { display: block; font-size: 0.5rem; color: #777; font-weight: 600; }
        .stat-item b { font-size: 0.7rem; }
        .win-amt { color: var(--profit); }
        .entry-amt { color: var(--gold); }

        .slot-box { padding: 0 5px 10px; }
        .slot-bar { height: 5px; background: #222; border-radius: 10px; overflow: hidden; margin-bottom: 5px; }
        .slot-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #00ccff); transition: 1.5s cubic-bezier(0.1, 0, 0.3, 1); }
        .slot-info { display: flex; justify-content: space-between; font-size: 0.55rem; font-weight: 800; }
        .waiting-text { color: var(--red); animation: blink 1.5s infinite; }
        @keyframes blink { 50% { opacity: 0.4; } }

        .btn-join { width: 100%; padding: 10px; border: none; background: var(--accent); color: #000; font-weight: 900; font-size: 0.75rem; cursor: pointer; border-radius: 8px; text-transform: uppercase; }

        /* Sidebar Profile Menu */
        #sidebar { 
            position: fixed; top: 0; left: -100%; width: 85%; height: 100%; 
            background: #000; z-index: 2000; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); padding: 40px 25px;
            border-right: 2px solid var(--gold); overflow-y: auto;
        }
        .profile-section { text-align: center; margin-bottom: 35px; }
        .pfp-container { position: relative; display: inline-block; }
        .pfp-main { width: 110px; height: 110px; border-radius: 50%; border: 3px solid var(--gold); object-fit: cover; background: #111; box-shadow: 0 0 20px rgba(255,215,0,0.2); }
        .pfp-upload-btn { 
            position: absolute; bottom: 5px; right: 5px; background: var(--gold); 
            color: #000; width: 32px; height: 32px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; border: 3px solid #000;
        }

        .balance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 25px 0; }
        .bal-card { padding: 15px; border-radius: 15px; background: #0c0c0c; border: 1px solid #1a1a1a; text-align: center; }
        .bal-card span { font-size: 0.65rem; color: #888; font-weight: 600; text-transform: uppercase; }
        .bal-card b { font-size: 1.1rem; display: block; margin-top: 5px; }
        .bal-card.profit { color: var(--profit); border-color: rgba(0,255,102,0.3); }
        .bal-card.loss { color: var(--red); border-color: rgba(255,68,68,0.3); }

        /* Modals Design */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 5000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
        .modal-box { background: #111; width: 100%; max-width: 400px; padding: 30px; border-radius: 24px; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        input { width: 100%; padding: 14px; margin-bottom: 15px; background: #000; border: 1px solid #333; color: #fff; border-radius: 12px; font-family: 'Poppins'; font-size: 0.9rem; }
        input:focus { border-color: var(--gold); }

        /* AI Chat Modal */
        #aiModal .modal-box { max-width: 450px; height: 80vh; display: flex; flex-direction: column; padding: 20px; }
        #chatBox { flex-grow: 1; overflow-y: auto; padding: 10px; margin-bottom: 15px; background: #080808; border-radius: 15px; border: 1px solid #222; }
        .msg { margin: 10px 0; max-width: 85%; padding: 10px 15px; border-radius: 15px; font-size: 0.85rem; line-height: 1.4; }
        .msg.user { background: var(--accent); color: #000; margin-left: auto; border-bottom-right-radius: 2px; }
        .msg.ai { background: #222; color: #fff; margin-right: auto; border-bottom-left-radius: 2px; border: 1px solid #333; }

        /* Floating AI Button */
        .ai-fab { 
            position: fixed; bottom: 25px; right: 25px; width: 55px; height: 55px; 
            background: var(--gold); color: #000; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.5rem; cursor: pointer; z-index: 999; box-shadow: 0 5px 20px rgba(255,215,0,0.4);
        }
    </style>
</head>
<body>

    <header>
        <div class="header-info">
            <h1>SQL TOURNAMENT PRO</h1>
        </div>
        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" class="pfp-nav" id="nav-pfp-icon" onclick="openSidebar()">
    </header>

    <div class="nav-scroll">
        <button class="nav-btn active" onclick="setFilter('ALL', this)">LIVE MATCHES</button>
        <button class="nav-btn" onclick="setFilter('CS', this)">CS MODE</button>
        <button class="nav-btn" onclick="setFilter('BR', this)">BR FULL MAP</button>
        <button class="nav-btn" onclick="setFilter('LONE', this)">LONE WOLF</button>
        <button class="nav-btn" onclick="showHistory()">MY HISTORY</button>
    </div>

    <main class="match-grid" id="match-list"></main>

    <div class="ai-fab" onclick="openAI()"><i class="fas fa-robot"></i></div>

    <div id="sidebar">
        <div class="profile-section">
            <div class="pfp-container">
                <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" id="main-pfp" class="pfp-main">
                <label for="pfp-file" class="pfp-upload-btn"><i class="fas fa-camera"></i></label>
                <input type="file" id="pfp-file" hidden accept="image/*" onchange="uploadToCloudinary(this, 'profile')">
            </div>
            <h2 id="profile-name" style="margin:15px 0 5px; font-size: 1.2rem;">Guest User</h2>
            <p id="profile-uid" style="font-size:0.7rem; color:#666; margin:0;">Not Logged In</p>

            <div class="balance-grid">
                <div class="bal-card profit"><span>PROFIT</span><b id="val-profit">₹0</b></div>
                <div class="bal-card loss"><span>LOSS</span><b id="val-loss">₹0</b></div>
            </div>
        </div>
        <button class="btn-join" id="auth-btn" style="margin-bottom:15px" onclick="openAuth()">LOGIN / REGISTER</button>
        <button class="btn-join" style="background:#222; color:#fff" onclick="closeSidebar()">CLOSE MENU</button>
    </div>

    <div id="modal-auth" class="modal">
        <div class="modal-box" id="step-register">
            <h3 style="text-align:center; color:var(--gold); margin-top:0;">REGISTRATION</h3>
            <input type="text" id="in-name" placeholder="Full Name">
            <input type="text" id="in-gameid" placeholder="Free Fire UID">
            <input type="text" id="in-phone" placeholder="+91 Phone Number">
            <div id="recaptcha-container"></div>
            <button class="btn-join" onclick="actionSendOTP()">SEND VERIFICATION CODE</button>
        </div>
        <div class="modal-box" id="step-otp" style="display:none;">
            <h3 style="text-align:center; color:var(--accent); margin-top:0;">VERIFY OTP</h3>
            <p style="text-align:center; font-size:0.7rem; color:#888;">Enter 6-digit code sent to your phone</p>
            <input type="number" id="in-otp" placeholder="0 0 0 0 0 0" style="text-align:center; letter-spacing:10px; font-size:1.5rem; font-weight:800;">
            <button class="btn-join" onclick="actionVerifyOTP()">COMPLETE LOGIN</button>
        </div>
    </div>

    <div id="aiModal" class="modal">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; color:var(--gold);"><i class="fas fa-magic"></i> SQL AI ASSISTANT</h3>
                <i class="fas fa-times" onclick="closeAI()" style="cursor:pointer; padding:5px;"></i>
            </div>
            <div id="chatBox"></div>
            <div style="display:flex; gap:10px;">
                <input id="aiInput" placeholder="Ask anything about matches..." style="margin-bottom:0;">
                <button class="btn-join" style="width:60px;" onclick="sendToAI()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div id="modal-pay" class="modal">
        <div class="modal-box">
            <h3 style="text-align:center; margin-top:0;">MATCH ENTRY</h3>
            <div style="background:#000; padding:15px; border-radius:15px; text-align:center; border:1px dashed var(--gold); margin-bottom:20px;">
                <span style="font-size:0.6rem; color:#888;">SEND ENTRY FEE TO UPI</span><br>
                <b style="color:var(--accent); font-size:1rem;">rizwanhasan90122778623@ybl</b>
            </div>
            <input type="text" id="p-utr" placeholder="12 Digit Transaction UTR">
            <label style="font-size:0.65rem; color:#888; display:block; margin-bottom:8px;">Payment Screenshot:</label>
            <input type="file" id="p-ss" accept="image/*">
            <button class="btn-join" id="p-submit-btn" onclick="submitMatchPayment()">SUBMIT ENTRY</button>
            <button class="btn-join" style="background:none; color:var(--red); margin-top:10px;" onclick="closeModals()">CANCEL</button>
        </div>
    </div>

    <script type="module">
        // ================= FIREBASE & CLOUDINARY CONFIG =================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, getDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getAI, getGenerativeModel } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-ai.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBvObxADcAior6R_or9O6UmWsFT8do1GkI",
            authDomain: "sqladmin-ff04d.firebaseapp.com",
            projectId: "sqladmin-ff04d",
            appId: "1:539086978850:web:261e6a0cf3c9a2aa29ef7b"
        };

        // Cloudinary Config
        const cloudName = "debp1kjtm";
        const uploadPreset = "sql_admin"; 

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Gemini AI Setup
        const ai = getAI(app);
        const model = getGenerativeModel(ai, { model: "gemini-1.5-flash" });

        let currentUser = JSON.parse(localStorage.getItem('sql_pro_user')) || null;
        let activeMatchId = null;
        let otpResult = null;

        // ================= OTP AUTHENTICATION =================
        window.actionSendOTP = async () => {
            const phone = document.getElementById('in-phone').value;
            if(!phone.includes('+91')) return alert("Use +91 Country Code!");
            
            window.recaptcha = new RecaptchaVerifier(auth, 'recaptcha-container', {size: 'invisible'});
            try {
                otpResult = await signInWithPhoneNumber(auth, phone, window.recaptcha);
                document.getElementById('step-register').style.display = 'none';
                document.getElementById('step-otp').style.display = 'block';
            } catch(e) { alert("Error: " + e.message); }
        };

        window.actionVerifyOTP = async () => {
            const code = document.getElementById('in-otp').value;
            try {
                const res = await otpResult.confirm(code);
                const userData = {
                    uid: res.user.uid,
                    name: document.getElementById('in-name').value,
                    gameId: document.getElementById('in-gameid').value,
                    pfp: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png',
                    profit: 0, loss: 0
                };
                await setDoc(doc(db, "users", res.user.uid), userData);
                localStorage.setItem('sql_pro_user', JSON.stringify(userData));
                location.reload();
            } catch(e) { alert("Invalid OTP!"); }
        };

        // ================= CLOUDINARY UPLOAD =================
        window.uploadToCloudinary = async (input, type) => {
            const file = input.files[0];
            if(!file) return;

            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", uploadPreset);

            // UI Loading State
            if(type === 'profile') document.getElementById('main-pfp').style.opacity = "0.4";

            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
                    method: "POST",
                    body: formData
                });
                const data = await res.json();
                const imageURL = data.secure_url;

                if(type === 'profile') {
                    currentUser.pfp = imageURL;
                    await setDoc(doc(db, "users", currentUser.uid), { pfp: imageURL }, { merge: true });
                    localStorage.setItem('sql_pro_user', JSON.stringify(currentUser));
                    document.getElementById('main-pfp').src = imageURL;
                    document.getElementById('nav-pfp-icon').src = imageURL;
                    document.getElementById('main-pfp').style.opacity = "1";
                } else if(type === 'payment') {
                    return imageURL;
                }
            } catch(e) { alert("Upload Failed!"); }
        };

        // ================= MATCH LOGIC =================
        function loadMatches() {
            onSnapshot(collection(db, "matches"), snap => {
                const box = document.getElementById('match-list');
                box.innerHTML = "";
                snap.forEach(d => {
                    const m = d.data();
                    const left = m.total - m.joined;
                    box.innerHTML += `
                    <div class="m-card">
                        <div class="m-type-tag">${m.type}</div>
                        <img src="https://staticg.sportskeeda.com/editor/2022/03/f305e-16475141042780-1920.jpg" class="m-img">
                        <div class="m-content">
                            <b class="m-title">${m.map} - #${d.id.slice(-4)}</b>
                            <div class="m-stats">
                                <div class="stat-item"><span>WIN</span><b class="win-amt">₹${m.win}</b></div>
                                <div class="stat-item"><span>ENTRY</span><b class="entry-amt">₹${m.entry}</b></div>
                            </div>
                            <div class="slot-box">
                                <div class="slot-bar"><div class="slot-fill" style="width:${(m.joined/m.total)*100}%"></div></div>
                                <div class="slot-info"><span>${m.joined}/${m.total}</span><span class="waiting-text">${left} Waiting</span></div>
                            </div>
                            <button class="btn-join" onclick="openPay('${d.id}')">JOIN NOW</button>
                        </div>
                    </div>`;
                });
            });
        }

        window.submitMatchPayment = async () => {
            const utr = document.getElementById('p-utr').value;
            const file = document.getElementById('p-ss').files[0];
            if(utr.length < 10 || !file) return alert("Fill all details!");

            const btn = document.getElementById('p-submit-btn');
            btn.disabled = true; btn.innerText = "Processing...";

            // Upload SS to Cloudinary
            const ssUrl = await window.uploadToCloudinary(document.getElementById('p-ss'), 'payment');

            await addDoc(collection(db, "payments"), {
                uid: currentUser.uid,
                matchId: activeMatchId,
                utr: utr,
                ss: ssUrl,
                status: 'pending',
                timestamp: Date.now()
            });

            alert("Payment Submitted! Wait for Admin Approval.");
            location.reload();
        };

        // ================= GEMINI AI LOGIC =================
        window.sendToAI = async () => {
            const input = document.getElementById('aiInput');
            const chatBox = document.getElementById('chatBox');
            const text = input.value.trim();
            if(!text) return;

            addMsg(text, 'user');
            input.value = "";

            try {
                const prompt = `You are SQL Tournament Assistant. Help users with: ${text}. Keep it short.`;
                const result = await model.generateContent(prompt);
                addMsg(result.response.text(), 'ai');
            } catch(e) { addMsg("AI is busy, try later.", 'ai'); }
        };

        function addMsg(text, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerText = text;
            const chatBox = document.getElementById('chatBox');
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // ================= UI HELPERS =================
        window.openSidebar = () => {
            document.getElementById('sidebar').style.left = '0';
            if(currentUser) {
                document.getElementById('profile-name').innerText = currentUser.name;
                document.getElementById('profile-uid').innerText = "UID: " + currentUser.gameId;
                document.getElementById('val-profit').innerText = "₹" + currentUser.profit;
                document.getElementById('val-loss').innerText = "₹" + currentUser.loss;
                document.getElementById('main-pfp').src = currentUser.pfp;
                document.getElementById('nav-pfp-icon').src = currentUser.pfp;
                document.getElementById('auth-btn').style.display = 'none';
            }
        };

        window.openPay = (id) => { if(!currentUser) return openAuth(); activeMatchId = id; document.getElementById('modal-pay').style.display='flex'; };
        window.openAuth = () => document.getElementById('modal-auth').style.display='flex';
        window.closeSidebar = () => document.getElementById('sidebar').style.left = '-100%';
        window.closeModals = () => document.querySelectorAll('.modal').forEach(m => m.style.display='none');
        window.openAI = () => document.getElementById('aiModal').style.display='flex';
        window.closeAI = () => document.getElementById('aiModal').style.display='none';

        loadMatches();
    </script>
</body>
        </html>

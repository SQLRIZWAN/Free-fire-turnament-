<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>SQL TOURNAMENT PRO - ULTIMATE v2.0</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* --- FULL CSS RESTORED & OPTIMIZED --- */
        :root { 
            --accent: #00ff88; 
            --gold: #ffd700; 
            --bg: #050505; 
            --card: #121212; 
            --border: #222; 
            --red: #ff4444; 
            --muted:#888; 
            --waiting:#ffae00; 
            --glass: rgba(20,20,20,0.95); 
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: 'Poppins', sans-serif; overflow-x: hidden; }
        
        /* Text Selection Control */
        .allow-select, .room-data b, .utr-display { user-select: text !important; cursor: text; }
        * { user-select: none; }

        /* Header */
        header { 
            background: #000; padding: 15px; border-bottom: 2px solid var(--gold); 
            text-align: center; position: sticky; top: 0; z-index: 1000; 
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.1); 
        }
        .header-title { color: var(--gold); font-weight: 800; font-size: 0.95rem; margin: 0; letter-spacing: 0.5px; text-transform: uppercase; }
        .header-sub { color: var(--accent); font-size: 0.7rem; display: block; margin-top: 2px; }
        .menu-btn { position: absolute; right: 20px; top: 18px; color: var(--gold); font-size: 1.4rem; cursor: pointer; }

        /* Tabs */
        .tabs { display: flex; gap:8px; margin: 12px; background: #111; border-radius: 12px; border:1px solid var(--border); padding:6px; align-items:center; }
        .tab { flex: 1; padding: 10px; border: none; background: none; color: var(--muted); font-weight: 700; font-size: 0.75rem; cursor: pointer; transition: 0.2s; text-align:center; border-radius:10px; }
        .tab.active { background: var(--accent); color: #000; box-shadow: 0 0 10px var(--accent); }

        /* App Grid - UPDATED TO 2 COLUMNS PER LINE */
        #app-content { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 10px; 
            padding: 10px 10px 90px 10px; 
        }

        /* Responsive Results (Full Width) */
        .results-container #app-content { 
            grid-template-columns: 1fr; 
        }

        /* Match Card - Compact 2-Column Design */
        .card { 
            background: var(--card); border-radius: 14px; border:1px solid var(--border); 
            overflow: hidden; position: relative; transition: transform 0.2s; 
            display: flex; flex-direction: column;
        }
        .m-tag { 
            position: absolute; top: 8px; right: 8px; font-size: 0.55rem; 
            background:#000; padding:3px 6px; border:1px solid var(--accent); 
            border-radius:4px; color:var(--accent); font-weight:800; z-index: 10;
        }
        .card-body { padding: 10px; display: grid; grid-template-columns: 1fr; gap: 8px; flex-grow: 1; }
        .item { display:flex; gap:8px; align-items:center; }
        .item i { color: var(--gold); font-size:0.8rem; width:15px; text-align:center; }
        .item div span { display:block; font-size:0.5rem; color:var(--muted); text-transform:uppercase; }
        .item div b { font-size:0.75rem; color:#fff; }
        .win-green { color: var(--accent); }
        .entry-gold { color: var(--gold); }

        .timer-box { background:#080808; padding:6px; text-align:center; border-top:1px solid #222; }
        .countdown { font-family: monospace; font-size:0.7rem; color:var(--waiting); font-weight:bold; }

        .card-footer { padding:8px; background: #0c0c0c; }
        .slots { display:flex; justify-content:space-between; font-size:0.6rem; margin-bottom:4px; font-weight:800; }
        .bar { height:6px; background:#222; border-radius:10px; overflow:hidden; margin-bottom:8px; }
        .fill { height:100%; background:linear-gradient(90deg, var(--accent), #008f4c); transition:1s ease; }

        .btn-main { 
            width:100%; padding:10px 5px; border-radius:8px; border:none; 
            font-weight:900; font-size:0.65rem; cursor:pointer; 
            transition:0.2s; text-transform:uppercase; letter-spacing:0.5px; 
            display:flex; align-items:center; justify-content:center; gap:4px; 
        }
        .btn-join { background:var(--accent); color:#000; box-shadow:0 0 10px rgba(0,255,136,0.1); }
        .btn-dis { background:#222; color:var(--muted); cursor:not-allowed; border:1px solid #333; }

        /* Room Box */
        .room-box { background: rgba(0, 255, 136, 0.05); border:1px dashed var(--accent); padding:8px; border-radius:8px; text-align:center; margin-bottom:5px; }
        .room-data { display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-top:5px; }
        .room-data div { background:#000; padding:4px; border-radius:4px; border:1px solid #333; }
        .room-data div b { font-size:0.7rem; color:#fff; font-family:monospace; }

        /* Results Card (Updated Detailed View) */
        .result-card { background:#121212; border-radius:16px; margin-bottom:20px; overflow:hidden; border: 1px solid #222; }
        .r-img { width:100%; height:200px; object-fit:cover; display:block; border-bottom: 1px solid #222; }
        .r-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; background: #0c0c0c; }
        .rd-item { border-left: 2px solid var(--gold); padding-left: 10px; }
        .rd-label { font-size: 0.6rem; color: var(--muted); text-transform: uppercase; display: block; }
        .rd-value { font-size: 0.85rem; font-weight: 700; color: #fff; }
        .rd-winner { color: var(--accent) !important; }
        .r-message { padding: 12px 15px; font-size: 0.8rem; color: #ccc; border-top: 1px solid #222; background: #121212; line-height: 1.4; }

        /* Stats Box */
        .stats-box { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:20px; }
        .stat-item { background:#0b0b0b; padding:12px 5px; border-radius:12px; border:1px solid #222; text-align:center; transition: 0.3s; }
        .stat-item:active { transform: scale(0.95); background: #151515; }
        .stat-lbl { font-size:0.55rem; color:#888; text-transform:uppercase; display:block; margin-bottom:4px; font-weight:700; }
        .stat-val { font-size:0.9rem; font-weight:800; }
        
        /* Side Menu */
        #side-menu { position: fixed; top:0; right:-100%; width:280px; height:100%; background:#0a0a0a; z-index:5000; transition:0.4s cubic-bezier(0.4, 0, 0.2, 1); border-left:1px solid var(--gold); }
        #side-menu.active { right:0; box-shadow: -10px 0 50px rgba(0,0,0,0.8); }
        .menu-link { display:flex; align-items:center; gap:15px; padding:16px; color:#ddd; text-decoration:none; border-bottom:1px solid #1a1a1a; font-weight:600; font-size:0.9rem; }
        
        /* Modals */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 6000; display:none; align-items:center; justify-content:center; padding:15px; backdrop-filter: blur(5px); }
        .modal-ui { background:#111; width:100%; max-width:480px; padding:25px; border-radius:20px; border:1px solid var(--gold); position:relative; max-height: 90vh; overflow-y: auto; }
        input { width:100%; background:#050505; border:1px solid #333; color:#fff; padding:12px; border-radius:10px; font-family:'Poppins'; outline:none; margin-bottom:12px; }

        .loader { width: 40px; height: 40px; border: 4px solid #222; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 40px auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="matches-container">

<header>
    <p class="header-title">FREE FIRE TOURNAMENT PRO</p>
    <span class="header-sub">JOIN PLAY & WIN REAL MONEY ðŸ’°</span>
    <div class="menu-btn" onclick="toggleMenu(true)"><i class="fas fa-bars-staggered"></i></div>
</header>

<div class="tabs">
    <button class="tab active" id="tab-live" onclick="switchTab('live')">LIVE MATCHES</button>
    <button class="tab" id="tab-my" onclick="switchTab('my')">MY PROFILE</button>
    <button class="tab" id="tab-result" onclick="switchTab('result')">RESULTS</button>
</div>

<main id="app-content"></main>

<div id="side-menu">
    <div style="padding: 20px; text-align: right;">
        <i class="fas fa-times" style="color:var(--red); font-size: 1.5rem; cursor: pointer;" onclick="toggleMenu(false)"></i>
    </div>
    <div style="padding: 0 20px 20px; border-bottom: 1px solid #222; text-align: center;">
        <img id="menu-user-dp" src="https://img.icons8.com/color/96/user-male-circle.png" style="width:70px; height:70px; border-radius:50%; border:2px solid var(--gold); object-fit: cover;">
        <div id="menu-user-name" style="font-weight:bold; color:#fff; margin-top:10px;">Guest User</div>
        <div id="menu-user-bal-side" style="font-size:0.8rem; color:var(--accent);">Bal: â‚¹0.00</div>
    </div>
    <div class="menu-items">
        <a href="#" class="menu-link" onclick="location.reload();"><i class="fas fa-home" style="color:var(--gold)"></i> Home</a>
        <a href="#" class="menu-link" onclick="openHistoryModal()"><i class="fas fa-history" style="color:var(--gold)"></i> My History</a>
        <a href="https://chat.whatsapp.com/JR7wAllMf4SAyILFHDQClQ" target="_blank" class="menu-link"><i class="fab fa-whatsapp" style="color:var(--gold)"></i> WhatsApp Group</a>
        <a href="#" class="menu-link" onclick="alert('1. No Hacks\n2. Teaming is ban\n3. Result takes 24h');"><i class="fas fa-shield-halved" style="color:var(--gold)"></i> Rules</a>
        <button id="menu-logout-btn" onclick="logout()" style="width:100%; background:none; border:none; display:none;" class="menu-link"><i class="fas fa-sign-out-alt" style="color:var(--red)"></i> Logout</button>
        <a href="#" id="menu-auth-btn" class="menu-link" onclick="openAuthModal('login')"><i class="fas fa-sign-in-alt" style="color:var(--gold)"></i> Login / Register</a>
    </div>
</div>

<div id="auth-modal" class="modal">
    <div class="modal-ui">
        <h2 id="auth-title" style="color:var(--gold); text-align:center; margin-bottom:20px;">LOGIN</h2>
        <div id="auth-forms"></div>
        <button id="auth-submit-btn" class="btn-main btn-join" style="margin-top:10px; padding:15px; font-size:0.9rem;" onclick="submitAuth()">LOGIN</button>
        <p id="auth-toggle-msg" style="text-align:center; font-size:0.8rem; margin-top:15px; color:#888; cursor:pointer;" onclick="toggleAuthMode()">New user? Register Here</p>
        <button onclick="closeModal('auth-modal')" style="position:absolute; top:15px; right:15px; background:none; border:none; color:#555; font-size:1.5rem;">&times;</button>
    </div>
</div>

<div id="pay-modal" class="modal">
    <div class="modal-ui">
        <h3 style="color:var(--gold); margin:0 0 15px 0; text-align:center;">CONFIRM JOIN</h3>
        <h1 id="modal-amt" style="color:var(--accent); margin:0 0 20px 0; text-align:center; font-size:2.5rem;">â‚¹0</h1>
        <div id="wallet-pay-box" style="background:#000; border:1px solid var(--accent); padding:15px; border-radius:12px; margin-bottom:15px; text-align:center;">
            <span style="font-size:0.8rem; color:var(--accent);">Your Balance: <b id="pay-modal-bal">â‚¹0</b></span>
            <button class="btn-main btn-join" style="margin-top:10px;" onclick="payViaWallet()">JOIN WITH WALLET</button>
        </div>
        <div style="text-align:center; color:#444; font-size:0.7rem; margin-bottom:15px;">--- OR MANUAL PAYMENT ---</div>
        <input type="text" id="utr-input" placeholder="Enter 12 Digit UTR / Ref No" maxlength="12">
        <button class="btn-main btn-join" style="padding:14px;" onclick="processManualPayment()">SUBMIT PAYMENT</button>
        <button onclick="closeModal('pay-modal')" style="width:100%; background:none; border:none; color:#555; margin-top:15px; cursor:pointer;">CANCEL</button>
    </div>
</div>

<div id="active-games-modal" class="modal">
    <div class="modal-ui">
        <h3 style="color:var(--gold); text-align:center;">MY ACTIVE GAMES</h3>
        <div id="active-games-list"></div>
        <button onclick="closeModal('active-games-modal')" style="width:100%; background:var(--border); border:none; color:#fff; padding:10px; border-radius:10px; margin-top:15px; cursor:pointer;">CLOSE</button>
    </div>
</div>

<div id="history-modal" class="modal">
    <div class="modal-ui">
        <h3 style="color:var(--gold); text-align:center;">TRANSACTION HISTORY</h3>
        <div id="history-content" style="font-size: 0.85rem;"></div>
        <button onclick="closeModal('history-modal')" style="width:100%; background:none; border:none; color:#555; margin-top:15px;">CLOSE</button>
    </div>
</div>

<div id="wallet-action-modal" class="modal">
    <div class="modal-ui">
        <h3 id="wa-title" style="color:var(--gold); text-align:center;">ADD MONEY</h3>
        <div id="wa-content"></div>
        <button onclick="closeModal('wallet-action-modal')" style="width:100%; background:none; border:none; color:#555; margin-top:15px;">CLOSE</button>
    </div>
</div>

<input type="file" id="dp-input" style="display:none;" onchange="uploadProfilePic(this)">

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
        getFirestore, collection, onSnapshot, addDoc, query, where,
        orderBy, limit, getDocs, doc, setDoc, getDoc, updateDoc, increment, runTransaction, arrayUnion
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyBvObxADcAior6R_or9O6UmWsFT8do1GkI",
        authDomain: "sqladmin-ff04d.firebaseapp.com",
        projectId: "sqladmin-ff04d",
        storageBucket: "sqladmin-ff04d.firebasestorage.app",
        messagingSenderId: "539086978850",
        appId: "1:539086978850:web:261e6a0cf3c9a2aa29ef7b"
    };

    const CLOUDINARY_CLOUD_NAME = "debp1kjtm";
    const CLOUDINARY_UPLOAD_PRESET = "sql_admin";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- APP STATE ---
    let currentUser = null;
    let activeTab = 'live';
    let currentAuthMode = 'login';
    let selectedMatch = null;

    // --- INITIALIZE ---
    function init() {
        const saved = localStorage.getItem('sql_session');
        if (saved) {
            currentUser = JSON.parse(saved);
            syncUserData(currentUser.phone);
        }
        renderUI();
    }

    async function syncUserData(phone) {
        onSnapshot(doc(db, "users", phone), (snapshot) => {
            if (snapshot.exists()) {
                currentUser = snapshot.data();
                localStorage.setItem('sql_session', JSON.stringify(currentUser));
                updateMenuUI();
                if (activeTab === 'my') renderProfileView();
            }
        });
    }

    function updateMenuUI() {
        const dp = document.getElementById('menu-user-dp');
        const nm = document.getElementById('menu-user-name');
        const bal = document.getElementById('menu-user-bal-side');
        const logoutBtn = document.getElementById('menu-logout-btn');
        const authBtn = document.getElementById('menu-auth-btn');

        if (currentUser) {
            dp.src = currentUser.dpUrl || "https://img.icons8.com/color/96/user-male-circle.png";
            nm.innerText = currentUser.name;
            bal.innerText = `Bal: â‚¹${(currentUser.balance || 0).toFixed(2)}`;
            logoutBtn.style.display = 'flex';
            authBtn.style.display = 'none';
        } else {
            dp.src = "https://img.icons8.com/color/96/user-male-circle.png";
            nm.innerText = "Guest User";
            bal.innerText = "Bal: â‚¹0.00";
            logoutBtn.style.display = 'none';
            authBtn.style.display = 'flex';
        }
    }

    // --- UI ROUTER ---
    window.switchTab = (tab) => {
        activeTab = tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        
        // Layout shift for Results
        if(tab === 'result') {
            document.body.className = "results-container";
        } else {
            document.body.className = "matches-container";
        }
        renderUI();
    };

    function renderUI() {
        const content = document.getElementById('app-content');
        content.innerHTML = '<div class="loader"></div>';

        if (activeTab === 'live') renderLiveMatches();
        else if (activeTab === 'my') renderProfileView();
        else if (activeTab === 'result') renderResultsView();
    }

    // --- TAB 1: LIVE MATCHES (2-COLUMN) ---
    function renderLiveMatches() {
        const content = document.getElementById('app-content');
        onSnapshot(collection(db, "matches"), (snapshot) => {
            if (activeTab !== 'live') return;
            content.innerHTML = "";
            
            const matches = [];
            snapshot.forEach(d => matches.push({id: d.id, ...d.data()}));
            
            if (matches.length === 0) {
                content.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:50px; color:#555;">No matches available</div>';
                return;
            }

            matches.forEach(m => {
                const isJoined = currentUser && m.participants?.includes(currentUser.phone);
                const isFull = (m.joined || 0) >= (m.total || 48);
                const fill = Math.min(100, ((m.joined || 0) / (m.total || 48)) * 100);

                let actionBtn = '';
                let roomSection = '';

                if (isJoined) {
                    if (m.roomId && m.roomId.length > 2) {
                        roomSection = `
                            <div class="room-box">
                                <span style="font-size:0.6rem; color:var(--accent); font-weight:bold;">ROOM DETAILS LIVE</span>
                                <div class="room-data">
                                    <div><b>${m.roomId}</b></div>
                                    <div><b>${m.password}</b></div>
                                </div>
                            </div>
                        `;
                    } else {
                        roomSection = `<div class="room-box"><span style="font-size:0.6rem; color:var(--waiting);">Room ID at Match Time</span></div>`;
                    }
                    actionBtn = `<button class="btn-main btn-dis">ALREADY JOINED</button>`;
                } else if (isFull) {
                    actionBtn = `<button class="btn-main btn-dis">HOUSE FULL</button>`;
                } else {
                    actionBtn = `<button class="btn-main btn-join" onclick="openJoinModal('${m.id}', ${m.entry})">JOIN NOW â‚¹${m.entry}</button>`;
                }

                content.innerHTML += `
                    <div class="card">
                        <div class="m-tag">${m.map || 'Bermuda'}</div>
                        <div class="card-body">
                            <div class="item"><i class="fas fa-trophy"></i><div><span>Prizepool</span><b class="win-green">â‚¹${m.win}</b></div></div>
                            <div class="item"><i class="fas fa-coins"></i><div><span>Entry</span><b class="entry-gold">â‚¹${m.entry}</b></div></div>
                            <div class="item"><i class="fas fa-gamepad"></i><div><span>Type</span><b>${m.type}</b></div></div>
                        </div>
                        <div class="timer-box"><span class="countdown" data-time="${m.startTime}">${m.startTime}</span></div>
                        <div class="card-footer">
                            <div class="slots"><span>Slots: ${m.joined}/${m.total}</span></div>
                            <div class="bar"><div class="fill" style="width:${fill}%"></div></div>
                            ${roomSection}
                            ${actionBtn}
                        </div>
                    </div>
                `;
            });
        });
    }

    // --- TAB 2: PROFILE & ACTIVE GAMES ---
    function renderProfileView() {
        const content = document.getElementById('app-content');
        if (!currentUser) {
            content.innerHTML = `
                <div style="grid-column:1/-1; text-align:center; padding:50px;">
                    <i class="fas fa-user-lock" style="font-size:3rem; color:#222; margin-bottom:15px;"></i><br>
                    Login to see Profile<br>
                    <button class="btn-main btn-join" style="width:auto; margin:20px auto; padding:10px 30px;" onclick="openAuthModal('login')">LOGIN</button>
                </div>`;
            return;
        }

        content.innerHTML = `
            <div style="grid-column: 1/-1;">
                <div style="background: linear-gradient(180deg, #151515, #0a0a0a); border:1px solid #222; border-radius:20px; padding:20px; text-align:center; margin-bottom:20px;">
                    <div style="position:relative; width:90px; height:90px; margin:0 auto 15px;">
                        <img src="${currentUser.dpUrl || 'https://img.icons8.com/color/96/user-male-circle.png'}" style="width:100%; height:100%; border-radius:50%; border:3px solid var(--accent); object-fit:cover;">
                        <div onclick="document.getElementById('dp-input').click()" style="position:absolute; bottom:0; right:0; background:var(--gold); color:#000; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; border:2px solid #000;">
                            <i class="fas fa-camera" style="font-size:0.8rem;"></i>
                        </div>
                    </div>
                    <h2 style="margin:0;">${currentUser.name}</h2>
                    <p style="color:#666; font-size:0.8rem; margin:5px 0 20px;">+91 ${currentUser.phone}</p>

                    <div class="stats-box">
                        <div class="stat-item">
                            <span class="stat-lbl">My Balance</span>
                            <div class="stat-val" style="color:var(--accent)">â‚¹${(currentUser.balance || 0).toFixed(2)}</div>
                        </div>
                        <div class="stat-item" onclick="openActiveGames()">
                            <span class="stat-lbl">Active Joined</span>
                            <div class="stat-val" style="color:var(--gold)">VIEW</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-lbl">Total Spent</span>
                            <div class="stat-val" style="color:var(--red)">â‚¹${currentUser.totalSpent || 0}</div>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <button class="btn-main btn-join" onclick="openAddMoney()">ADD MONEY</button>
                        <button class="btn-main" style="background:#222; color:#fff;" onclick="openWithdraw()">WITHDRAW</button>
                    </div>
                </div>
            </div>
        `;
    }

    // --- TAB 3: RESULTS (DETAILED) ---
    async function renderResultsView() {
        const content = document.getElementById('app-content');
        const q = query(collection(db, "results"), orderBy("timestamp", "desc"), limit(20));
        const snapshot = await getDocs(q);
        
        content.innerHTML = "";
        if (snapshot.empty) {
            content.innerHTML = '<div style="text-align:center; padding:50px; color:#555;">Results will be posted soon</div>';
            return;
        }

        snapshot.forEach(doc => {
            const r = doc.data();
            content.innerHTML += `
                <div class="result-card">
                    <img src="${r.image}" class="r-img" onerror="this.src='https://via.placeholder.com/400x200?text=Match+Result'">
                    <div class="r-details-grid">
                        <div class="rd-item"><span class="rd-label">Winner Name</span><b class="rd-value rd-winner">${r.winnerName || 'Unknown'}</b></div>
                        <div class="rd-item"><span class="rd-label">Winner ID</span><b class="rd-value allow-select">${r.winnerId || '00000'}</b></div>
                        <div class="rd-item"><span class="rd-label">Winner No.</span><b class="rd-value">${r.winnerNumber || 'N/A'}</b></div>
                        <div class="rd-item"><span class="rd-label">Match ID</span><b class="rd-value allow-select">#${r.matchId || '00'}</b></div>
                        <div class="rd-item"><span class="rd-label">Amount Won</span><b class="rd-value" style="color:var(--gold)">â‚¹${r.amount || 0}</b></div>
                        <div class="rd-item"><span class="rd-label">Total Players</span><b class="rd-value">${r.totalPlayers || 0}</b></div>
                        <div class="rd-item" style="grid-column: 1/-1;"><span class="rd-label">Opponent UID</span><b class="rd-value allow-select">${r.opponentUid || 'N/A'}</b></div>
                    </div>
                    <div class="r-message">
                        <i class="fas fa-quote-left" style="color:var(--gold); margin-right:8px;"></i>${r.message || 'GG! Keep playing to win more.'}
                    </div>
                </div>
            `;
        });
    }

    // --- JOIN LOGIC (ATOMIC TRANSACTIONS) ---
    window.openJoinModal = (id, entry) => {
        if (!currentUser) return openAuthModal('login');
        selectedMatch = { id, entry };
        document.getElementById('modal-amt').innerText = `â‚¹${entry}`;
        document.getElementById('pay-modal-bal').innerText = `â‚¹${(currentUser.balance || 0).toFixed(2)}`;
        document.getElementById('pay-modal').style.display = 'flex';
    };

    window.payViaWallet = async () => {
        if (!currentUser || !selectedMatch) return;
        if (currentUser.balance < selectedMatch.entry) return alert("Low Balance! Please add money.");

        const btn = event.target;
        btn.disabled = true;
        btn.innerText = "Processing...";

        try {
            await runTransaction(db, async (transaction) => {
                const userRef = doc(db, "users", currentUser.phone);
                const matchRef = doc(db, "matches", selectedMatch.id);

                const uSnap = await transaction.get(userRef);
                const mSnap = await transaction.get(matchRef);

                if (!mSnap.exists()) throw "Match Deleted!";
                if (mSnap.data().joined >= mSnap.data().total) throw "Match Full!";
                if (mSnap.data().participants?.includes(currentUser.phone)) throw "Already Joined!";
                if (uSnap.data().balance < selectedMatch.entry) throw "Insufficient Balance!";

                // 1. Deduct Balance & Update totalSpent
                transaction.update(userRef, { 
                    balance: increment(-selectedMatch.entry),
                    totalSpent: increment(selectedMatch.entry)
                });

                // 2. Update Match Joined Count & Participants
                transaction.update(matchRef, {
                    joined: increment(1),
                    participants: arrayUnion(currentUser.phone)
                });
            });

            alert("Joined Successfully!");
            closeModal('pay-modal');
        } catch (e) {
            alert("Error: " + e);
        } finally {
            btn.disabled = false;
            btn.innerText = "JOIN WITH WALLET";
        }
    };

    window.processManualPayment = async () => {
        const utr = document.getElementById('utr-input').value.trim();
        if (utr.length < 10) return alert("Enter 12 digit valid UTR");

        try {
            // Check Duplicate UTR
            const dupCheck = await getDocs(query(collection(db, "payments"), where("utr", "==", utr)));
            if (!dupCheck.empty) throw "UTR already used!";

            await addDoc(collection(db, "payments"), {
                userId: currentUser.phone,
                userName: currentUser.name,
                matchId: selectedMatch.id,
                amount: selectedMatch.entry,
                utr: utr,
                status: 'pending',
                timestamp: Date.now()
            });

            alert("Payment Submitted! Wait for Admin approval.");
            closeModal('pay-modal');
        } catch (e) {
            alert(e);
        }
    };

    // --- MY ACTIVE GAMES LOGIC ---
    window.openActiveGames = async () => {
        const list = document.getElementById('active-games-list');
        document.getElementById('active-games-modal').style.display = 'flex';
        list.innerHTML = '<div class="loader"></div>';

        const q = query(collection(db, "matches"), where("participants", "array-contains", currentUser.phone));
        const snapshot = await getDocs(q);
        
        list.innerHTML = "";
        if (snapshot.empty) {
            list.innerHTML = '<div style="text-align:center; padding:20px; color:#555;">No joined matches found.</div>';
            return;
        }

        snapshot.forEach(doc => {
            const m = doc.data();
            list.innerHTML += `
                <div style="background:#000; border:1px solid #333; padding:12px; border-radius:12px; margin-bottom:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <b style="color:var(--accent)">${m.type} - ${m.map}</b>
                        <span style="font-size:0.7rem; color:var(--waiting)">${m.startTime}</span>
                    </div>
                    <div class="room-data" style="margin-top:10px;">
                        <div style="background:#111; padding:10px;">
                            <span style="font-size:0.5rem; color:#666; display:block;">ROOM ID</span>
                            <b style="font-family:monospace;">${m.roomId || 'Wait...'}</b>
                        </div>
                        <div style="background:#111; padding:10px;">
                            <span style="font-size:0.5rem; color:#666; display:block;">PASSWORD</span>
                            <b style="font-family:monospace;">${m.password || 'Wait...'}</b>
                        </div>
                    </div>
                </div>
            `;
        });
    };

    // --- TRANSACTION HISTORY LOGIC ---
    window.openHistoryModal = async () => {
        if(!currentUser) return openAuthModal('login');
        const cont = document.getElementById('history-content');
        document.getElementById('history-modal').style.display = 'flex';
        cont.innerHTML = '<div class="loader"></div>';

        const q = query(collection(db, "payments"), where("userId", "==", currentUser.phone), orderBy("timestamp", "desc"));
        const snapshot = await getDocs(q);
        
        cont.innerHTML = "";
        if (snapshot.empty) {
            cont.innerHTML = "No history found.";
            return;
        }

        snapshot.forEach(doc => {
            const h = doc.data();
            const date = new Date(h.timestamp).toLocaleDateString();
            cont.innerHTML += `
                <div style="border-bottom:1px solid #222; padding:10px 0; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <b style="display:block;">${h.matchId === 'DEPOSIT' ? 'Add Cash' : 'Join Match'}</b>
                        <span style="font-size:0.65rem; color:#555;">${date} | UTR: ${h.utr}</span>
                    </div>
                    <div style="text-align:right;">
                        <b style="color:${h.status==='approved'?'var(--accent)':'var(--waiting)'}">â‚¹${h.amount}</b>
                        <span style="display:block; font-size:0.6rem; color:#666;">${h.status.toUpperCase()}</span>
                    </div>
                </div>
            `;
        });
    };

    // --- WALLET ACTIONS (ADD/WITHDRAW) ---
    window.openAddMoney = () => {
        const cont = document.getElementById('wa-content');
        document.getElementById('wa-title').innerText = "ADD MONEY";
        document.getElementById('wallet-action-modal').style.display = 'flex';
        selectedMatch = { id: 'DEPOSIT', entry: 0 }; // Temporary for UTR
        cont.innerHTML = `
            <div style="background:#000; padding:15px; border-radius:15px; border:1px solid #333; margin-bottom:15px; text-align:center;">
                <span style="color:#888; font-size:0.75rem;">Pay to UPI ID</span>
                <div style="background:#111; padding:10px; margin:10px 0; border-radius:10px;" class="allow-select">
                    <b style="color:var(--gold)">rizwanhasan90122778623@ybl</b>
                </div>
                <p style="font-size:0.6rem; color:#555;">Pay using PhonePe, GPay or Paytm and enter UTR below.</p>
            </div>
            <input type="number" id="deposit-amt" placeholder="Enter Amount (Min â‚¹10)">
            <input type="text" id="deposit-utr" placeholder="Enter 12 Digit UTR">
            <button class="btn-main btn-join" style="padding:15px;" onclick="submitDeposit()">SUBMIT REQUEST</button>
        `;
    };

    window.submitDeposit = async () => {
        const amt = document.getElementById('deposit-amt').value;
        const utr = document.getElementById('deposit-utr').value.trim();
        if(amt < 10 || utr.length < 10) return alert("Fill details correctly");

        await addDoc(collection(db, "payments"), {
            userId: currentUser.phone,
            userName: currentUser.name,
            matchId: 'DEPOSIT',
            amount: parseFloat(amt),
            utr: utr,
            status: 'pending',
            timestamp: Date.now()
        });
        alert("Deposit request sent!");
        closeModal('wallet-action-modal');
    };

    window.openWithdraw = () => {
        const cont = document.getElementById('wa-content');
        document.getElementById('wa-title').innerText = "WITHDRAW MONEY";
        document.getElementById('wallet-action-modal').style.display = 'flex';
        cont.innerHTML = `
            <div style="background:rgba(255,68,68,0.05); padding:10px; border:1px solid var(--red); border-radius:10px; margin-bottom:15px; font-size:0.7rem; color:#ff9999;">
                Min Withdrawal: â‚¹50 | Time: 24-48 Hours
            </div>
            <input type="number" id="wd-amt" placeholder="Amount (Available: â‚¹${currentUser.balance})">
            <input type="text" id="wd-upi" placeholder="Enter UPI ID (e.g. name@upi)">
            <button class="btn-main" style="background:var(--gold); color:#000; padding:15px;" onclick="submitWithdrawal()">WITHDRAW NOW</button>
        `;
    };

    window.submitWithdrawal = async () => {
        const amt = parseFloat(document.getElementById('wd-amt').value);
        const upi = document.getElementById('wd-upi').value.trim();

        if(amt < 50 || !upi.includes('@')) return alert("Enter valid details");
        if(amt > currentUser.balance) return alert("Insufficient balance!");

        try {
            await runTransaction(db, async (t) => {
                const uRef = doc(db, "users", currentUser.phone);
                const uSnap = await t.get(uRef);
                if(uSnap.data().balance < amt) throw "Low Balance!";
                
                t.update(uRef, { balance: increment(-amt) });
                const wdRef = doc(collection(db, "withdrawals"));
                t.set(wdRef, {
                    userId: currentUser.phone,
                    userName: currentUser.name,
                    amount: amt,
                    upi: upi,
                    status: 'pending',
                    timestamp: Date.now()
                });
            });
            alert("Withdrawal request submitted!");
            closeModal('wallet-action-modal');
        } catch(e) { alert(e); }
    };

    // --- AUTH LOGIC ---
    window.openAuthModal = (mode) => {
        currentAuthMode = mode;
        document.getElementById('auth-modal').style.display = 'flex';
        renderAuthFields();
    };

    function renderAuthFields() {
        const div = document.getElementById('auth-forms');
        const title = document.getElementById('auth-title');
        const btn = document.getElementById('auth-submit-btn');
        const toggle = document.getElementById('auth-toggle-msg');

        if (currentAuthMode === 'login') {
            title.innerText = "LOGIN";
            btn.innerText = "LOGIN NOW";
            toggle.innerHTML = 'New user? <span style="color:var(--accent); font-weight:bold;">Register Here</span>';
            div.innerHTML = `
                <input type="number" id="auth-phone" placeholder="Phone Number">
                <input type="password" id="auth-pass" placeholder="Password">
            `;
        } else {
            title.innerText = "REGISTER";
            btn.innerText = "CREATE ACCOUNT";
            toggle.innerHTML = 'Already have account? <span style="color:var(--accent); font-weight:bold;">Login Here</span>';
            div.innerHTML = `
                <input type="text" id="auth-name" placeholder="Full Name">
                <input type="number" id="auth-phone" placeholder="Phone Number">
                <input type="text" id="auth-uid" placeholder="Gaming UID/Name">
                <input type="password" id="auth-pass" placeholder="Password">
            `;
        }
    }

    window.toggleAuthMode = () => {
        currentAuthMode = currentAuthMode === 'login' ? 'register' : 'login';
        renderAuthFields();
    };

    window.submitAuth = async () => {
        const phone = document.getElementById('auth-phone').value.trim();
        const pass = document.getElementById('auth-pass').value.trim();
        if (phone.length !== 10) return alert("Valid 10 digit phone required");

        const btn = document.getElementById('auth-submit-btn');
        btn.disabled = true; btn.innerText = "Please wait...";

        try {
            if (currentAuthMode === 'register') {
                const name = document.getElementById('auth-name').value.trim();
                const uid = document.getElementById('auth-uid').value.trim();
                const snap = await getDoc(doc(db, "users", phone));
                if (snap.exists()) throw "User already registered!";

                const userData = {
                    name, phone, gamingName: uid, password: pass,
                    balance: 0, totalSpent: 0, dpUrl: "", timestamp: Date.now()
                };
                await setDoc(doc(db, "users", phone), userData);
                currentUser = userData;
            } else {
                const snap = await getDoc(doc(db, "users", phone));
                if (!snap.exists()) throw "User not found!";
                if (snap.data().password !== pass) throw "Wrong Password!";
                currentUser = snap.data();
            }
            localStorage.setItem('sql_session', JSON.stringify(currentUser));
            location.reload();
        } catch (e) { alert(e); btn.disabled = false; btn.innerText = "SUBMIT"; }
    };

    // --- HELPERS ---
    window.logout = () => {
        localStorage.removeItem('sql_session');
        location.reload();
    };

    window.uploadProfilePic = async (input) => {
        if(!currentUser) return;
        const file = input.files[0];
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

        try {
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                method: 'POST', body: formData
            });
            const data = await res.json();
            await updateDoc(doc(db, "users", currentUser.phone), { dpUrl: data.secure_url });
        } catch(e) { alert("Upload failed!"); }
    };

    window.toggleMenu = (s) => document.getElementById('side-menu').classList.toggle('active', s);
    window.closeModal = (id) => document.getElementById(id).style.display = 'none';

    // Start
    init();

</script>
</body>
        </html>

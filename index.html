<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SQL TOURNAMENT PRO | ADMIN PANEL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    /* =============================
       BASIC ADMIN PANEL STYLING
       ============================= */
    body {
      margin: 0;
      background: #050505;
      color: #fff;
      font-family: Arial, sans-serif;
    }

    header {
      background: #000;
      padding: 12px;
      border-bottom: 2px solid gold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      margin: 0;
      font-size: 18px;
      color: gold;
    }

    .container {
      padding: 12px;
      max-width: 1200px;
      margin: auto;
    }

    .card {
      background: #121212;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 12px;
      border: 1px solid #222;
    }

    input, button, select {
      padding: 8px;
      border-radius: 6px;
      border: none;
      margin-top: 6px;
    }

    button {
      cursor: pointer;
      background: gold;
      color: #000;
      font-weight: bold;
    }

    button.danger {
      background: #ff4444;
      color: #fff;
    }

    button.secondary {
      background: #444;
      color: #fff;
    }

    img {
      max-width: 100%;
      border-radius: 6px;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>

<header>
  <h1>SQL TOURNAMENT PRO — ADMIN</h1>
  <div id="adminStatus">NOT LOGGED IN</div>
</header>

<div class="container">

  <!-- =============================
       ADMIN LOGIN SECTION
       ============================= -->
  <div class="card" id="adminLoginBox">
    <h3>Admin Login</h3>
    <input id="adminId" placeholder="Admin ID (email / uid)" />
    <input id="adminPass" type="password" placeholder="Password" />
    <button onclick="adminLogin()">LOGIN</button>
  </div>

  <!-- =============================
       MAIN ADMIN PANEL
       ============================= -->
  <div id="adminPanel" class="hidden">

    <!-- MATCH MANAGEMENT -->
    <div class="card">
      <h3>Add Match</h3>
      <input id="m_map" placeholder="Map Name" />
      <input id="m_type" placeholder="Match Type (Solo / Duo)" />
      <input id="m_entry" type="number" placeholder="Entry Fee" />
      <input id="m_prize" type="number" placeholder="Winning Prize" />
      <input id="m_total" type="number" placeholder="Total Slots" />
      <input id="m_time" type="datetime-local" />
      <button onclick="addMatch()">ADD MATCH</button>
    </div>

    <div class="card">
      <h3>All Matches</h3>
      <div id="matchList">Loading...</div>
    </div>

    <!-- PAYMENTS -->
    <div class="card">
      <h3>Pending Payments</h3>
      <div id="paymentList">Loading...</div>
    </div>

    <!-- WITHDRAWALS -->
    <div class="card">
      <h3>Withdraw Requests</h3>
      <div id="withdrawList">Loading...</div>
    </div>

    <!-- RESULTS -->
    <div class="card">
      <h3>Upload Result</h3>
      <input id="r_matchId" placeholder="Match ID" />
      <input id="r_name" placeholder="Winner Name" />
      <input id="r_phone" placeholder="Winner Phone" />
      <input id="r_amount" type="number" placeholder="Winning Amount" />
      <input id="r_img" type="file" />
      <button onclick="uploadResult()">UPLOAD RESULT</button>
    </div>

  </div>
</div>

<!-- =============================
     FIREBASE + ADMIN LOGIC
     ============================= -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, getDoc, doc,
    updateDoc, deleteDoc, onSnapshot, runTransaction,
    increment, arrayUnion
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  /* =============================
     FIREBASE CONFIG (SAME PROJECT)
     ============================= */
  const firebaseConfig = {
    apiKey: "AIzaSyBvObxADcAior6R_or9O6UmWsFT8do1GkI",
    authDomain: "sqladmin-ff04d.firebaseapp.com",
    projectId: "sqladmin-ff04d",
    storageBucket: "sqladmin-ff04d.appspot.com",
    messagingSenderId: "539086978850",
    appId: "1:539086978850:web:261e6a0cf3c9a2aa29ef7b"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let adminSession = null;

  /* =============================
     SIMPLE SHA-256 PASSWORD CHECK
     ============================= */
  async function sha256(text) {
    const enc = new TextEncoder().encode(text);
    const hash = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(hash))
      .map(b => b.toString(16).padStart(2, "0"))
      .join("");
  }

  /* =============================
     ADMIN LOGIN
     ============================= */
  window.adminLogin = async () => {
    const id = adminId.value.trim();
    const pass = adminPass.value.trim();
    if (!id || !pass) return alert("Enter admin credentials");

    const snap = await getDoc(doc(db, "admins", id));
    if (!snap.exists()) return alert("Admin not found");

    const hash = await sha256(pass);
    if (snap.data().passwordHash !== hash) {
      return alert("Wrong password");
    }

    adminSession = { id };
    adminLoginBox.classList.add("hidden");
    adminPanel.classList.remove("hidden");
    adminStatus.innerText = "LOGGED IN AS ADMIN";

    loadMatches();
    loadPayments();
    loadWithdrawals();
  };

  /* =============================
     MATCH MANAGEMENT
     ============================= */
  async function addMatch() {
    await addDoc(collection(db, "matches"), {
      map: m_map.value,
      type: m_type.value,
      entry: Number(m_entry.value),
      win: Number(m_prize.value),
      total: Number(m_total.value),
      joined: 0,
      joinedUsers: [],
      startTime: new Date(m_time.value).getTime(),
      createdAt: Date.now()
    });
    alert("Match added");
  }

  function loadMatches() {
    onSnapshot(collection(db, "matches"), snap => {
      matchList.innerHTML = "";
      snap.forEach(d => {
        const m = d.data();
        matchList.innerHTML += `
          <div class="card">
            <b>${m.map}</b> | Entry ₹${m.entry} | Joined ${m.joined}/${m.total}
            <br/>
            <button class="danger" onclick="deleteMatch('${d.id}')">DELETE</button>
          </div>`;
      });
    });
  }

  async function deleteMatch(id) {
    if (!confirm("Delete match?")) return;
    await deleteDoc(doc(db, "matches", id));
  }

  /* =============================
     PAYMENT APPROVAL (NO DOUBLE CREDIT)
     ============================= */
  function loadPayments() {
    onSnapshot(collection(db, "payments"), snap => {
      paymentList.innerHTML = "";
      snap.forEach(d => {
        const p = d.data();
        if (p.status !== "pending") return;

        paymentList.innerHTML += `
          <div class="card">
            <b>${p.userName}</b> | ₹${p.amount} | ${p.type}
            <br/>UTR: ${p.utr}
            <br/><img src="${p.ss}" />
            <br/>
            <button onclick="approvePayment('${d.id}')">APPROVE</button>
            <button class="danger" onclick="rejectPayment('${d.id}')">REJECT</button>
          </div>`;
      });
    });
  }

  window.approvePayment = async (pid) => {
    const pref = doc(db, "payments", pid);

    await runTransaction(db, async tx => {
      const ps = await tx.get(pref);
      if (!ps.exists()) return;
      if (ps.data().status !== "pending") return;

      const p = ps.data();
      const userRef = doc(db, "users", p.userId);

      // ADD FUND → wallet credit
      if (p.type === "add_fund") {
        tx.update(userRef, { balance: increment(p.amount) });
      }

      // MATCH JOIN → joined++
      if (p.type === "match") {
        const mref = doc(db, "matches", p.matchId);
        tx.update(mref, {
          joined: increment(1),
          joinedUsers: arrayUnion(p.userId)
        });
      }

      tx.update(pref, { status: "approved" });
    });

    alert("Payment approved safely");
  };

  window.rejectPayment = async (pid) => {
    await updateDoc(doc(db, "payments", pid), { status: "rejected" });
  };

  /* =============================
     WITHDRAW APPROVAL
     ============================= */
  function loadWithdrawals() {
    onSnapshot(collection(db, "withdrawals"), snap => {
      withdrawList.innerHTML = "";
      snap.forEach(d => {
        const w = d.data();
        if (w.status !== "pending") return;

        withdrawList.innerHTML += `
          <div class="card">
            <b>${w.userName}</b> | ₹${w.amount}
            <br/>UPI: ${w.upi}
            <br/>
            <button onclick="approveWithdraw('${d.id}')">APPROVE</button>
            <button class="danger" onclick="rejectWithdraw('${d.id}')">REJECT</button>
          </div>`;
      });
    });
  }

  window.approveWithdraw = async (id) => {
    const wref = doc(db, "withdrawals", id);

    await runTransaction(db, async tx => {
      const ws = await tx.get(wref);
      if (!ws.exists()) return;
      if (ws.data().status !== "pending") return;

      const uref = doc(db, "users", ws.data().userId);
      tx.update(uref, { balance: increment(-ws.data().amount) });
      tx.update(wref, { status: "approved" });
    });

    alert("Withdrawal approved");
  };

  window.rejectWithdraw = async (id) => {
    await updateDoc(doc(db, "withdrawals", id), { status: "rejected" });
  };

  /* =============================
     RESULT UPLOAD (NO DOUBLE PRIZE)
     ============================= */
  async function uploadResult() {
    const file = r_img.files[0];
    if (!file) return alert("Upload image");

    const imgUrl = await uploadToCloudinary(file);

    await addDoc(collection(db, "results"), {
      matchId: r_matchId.value,
      winnerName: r_name.value,
      winnerPhone: r_phone.value,
      winningAmount: Number(r_amount.value),
      image: imgUrl,
      paidTo: [],
      timestamp: Date.now()
    });

    alert("Result uploaded");
  }

  async function uploadToCloudinary(file) {
    const fd = new FormData();
    fd.append("file", file);
    fd.append("upload_preset", "sql_admin");
    fd.append("folder", "results");

    const res = await fetch("https://api.cloudinary.com/v1_1/debp1kjtm/image/upload", {
      method: "POST",
      body: fd
    });

    const data = await res.json();
    return data.secure_url;
  }
</script>

</body>
</html>

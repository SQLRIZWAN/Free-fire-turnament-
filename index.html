<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>SQL TOURNAMENT PRO</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --accent:#00ff88; --gold:#ffd700; --bg:#050505; --card:#111; --border:#222; --red:#ff4444; --muted:#777; --waiting:#ffae00;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{margin:0;background:var(--bg);color:#fff;font-family:'Poppins',sans-serif;overflow-x:hidden}
.allow-select{user-select:text!important}

/* Header */
header{background:#000;padding:14px;border-bottom:2px solid var(--gold);position:sticky;top:0;z-index:1200;display:flex;align-items:center;justify-content:space-between}
.header-left{display:flex;flex-direction:column}
.header-title{color:var(--gold);font-weight:800;font-size:0.95rem;letter-spacing:0.6px;text-transform:uppercase}
.header-sub{color:var(--accent);font-size:0.68rem;margin-top:4px}
.menu-btn{color:var(--gold);font-size:1.4rem;cursor:pointer}

/* Tabs */
.tabs{display:flex;margin:14px;gap:8px;background:#111;border-radius:12px;border:1px solid var(--border);padding:6px}
.tab{flex:1;padding:10px;border-radius:8px;background:none;border:none;color:var(--muted);font-weight:800;cursor:pointer;text-align:center}
.tab.active{background:var(--accent);color:#000}

/* Grid for cards */
#app-content{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:12px;padding:10px 12px 120px}

/* Card */
.card{background:var(--card);border-radius:16px;border:1px solid var(--border);overflow:hidden;position:relative}
.m-tag{position:absolute;top:12px;right:15px;font-size:0.65rem;background:#121212;padding:6px 9px;border-radius:9px;color:var(--accent);font-weight:800}
.card-body{padding:16px;display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:center}
.item{display:flex;gap:10px;align-items:center}
.item i{color:var(--gold);font-size:0.95rem;width:18px}
.item div span{display:block;font-size:0.6rem;color:var(--muted);text-transform:uppercase}
.item div b{font-size:0.9rem;color:#fff}
.win-green{color:var(--accent);font-weight:900}
.entry-gold{color:var(--gold);font-weight:900}

/* Timer */
.timer-box{background:#0c0c0c;padding:12px;text-align:center;border-top:1px solid #141414;border-bottom:1px solid #141414}
.timer-label{font-size:0.62rem;color:var(--muted);display:block;margin-bottom:4px}
.countdown{font-family:monospace;font-size:1.05rem;color:var(--gold);font-weight:900}

/* Footer */
.card-footer{padding:14px}
.slots{display:flex;justify-content:space-between;font-size:0.75rem;margin-bottom:8px;font-weight:800}
.bar{height:10px;background:#222;border-radius:12px;overflow:hidden;margin-bottom:12px}
.fill{height:100%;background:var(--accent);transition:1s ease}
.btn-main{width:100%;padding:12px;border-radius:12px;border:none;font-weight:900;font-size:0.9rem;cursor:pointer;transition:0.2s}
.btn-join{background:var(--accent);color:#000;box-shadow:0 6px 18px rgba(0,255,136,0.12)}
.btn-dis{background:#222;color:var(--muted);cursor:not-allowed}

/* Room box */
.room-box{background:#001a0d;border:1px dashed var(--accent);padding:12px;border-radius:12px;text-align:center}
.room-data{display:flex;justify-content:space-around;background:#000;padding:8px;border-radius:8px}

/* Modal, side menu & small UI */
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:6000;display:none;align-items:center;justify-content:center;padding:18px}
.modal-ui{background:#111;width:100%;max-width:520px;padding:18px;border-radius:12px;border:1px solid var(--gold);text-align:center}
.pay-grid{display:grid;gap:10px;margin:12px 0}
.pay-opt{display:flex;align-items:center;gap:12px;padding:10px;background:#1a1a1a;border-radius:10px;text-decoration:none;color:#fff;border:1px solid #333;font-weight:600}
.pay-opt img{width:28px}
#side-menu{position:fixed;top:0;right:-100%;width:320px;height:100%;background:#000;z-index:7000;transition:0.36s;border-left:2px solid var(--gold);padding:18px}
#side-menu.active{right:0}
.menu-link{display:flex;align-items:center;gap:12px;padding:12px;color:#fff;text-decoration:none;border-bottom:1px solid #111;font-weight:700;border-radius:8px}
.close-menu{color:var(--red);font-size:2rem;text-align:right;cursor:pointer;margin-bottom:10px}
.menu-footer{position:absolute;bottom:12px;left:18px;right:18px;display:flex;justify-content:space-between;align-items:center}

/* Results feed */
.result-card{background:#0f0f0f;padding:12px;border-radius:12px;border:1px solid #222;margin-bottom:12px}
.result-meta{font-size:0.75rem;color:var(--muted);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.result-img{width:100%;border-radius:8px;max-height:260px;object-fit:cover;margin-bottom:8px}

/* small */
.muted{color:var(--muted)}
.waiting{color:var(--waiting);font-weight:800}

/* profile dp */
.profile-wrap{display:flex;gap:12px;align-items:center}
.dp{width:64px;height:64px;border-radius:12px;object-fit:cover;border:1px solid #222}
.dp-wrap{position:relative;width:64px;height:64px}
.dp-pencil{position:absolute;right:-6px;bottom:-6px;background:var(--gold);color:#000;padding:6px;border-radius:999px;cursor:pointer;border:2px solid #000;font-size:12px}

/* responsive */
@media(max-width:720px){
  .card-body{grid-template-columns:1fr}
  #app-content{padding-bottom:160px}
  .dp{width:52px;height:52px}
}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:#111;border:1px solid #222;padding:10px 14px;border-radius:999px;color:var(--accent);z-index:9000;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
</style>
</head>
<body>

<header>
  <div class="header-left">
    <div class="header-title">FREE FIRE DAILY TOURNAMENT LIVE</div>
    <div class="header-sub">JOIN PLAY &amp; WIN REAL MONEY üí∞</div>
  </div>
  <div style="display:flex;align-items:center;gap:12px">
    <div class="menu-btn" onclick="toggleMenu(true)"><i class="fas fa-bars-staggered"></i></div>
  </div>
</header>

<div class="tabs" role="tablist" aria-label="main-tabs">
  <button class="tab active" id="tab-live" onclick="switchTab('live')">LIVE MATCHES</button>
  <button class="tab" id="tab-my" onclick="switchTab('my')">MY HISTORY</button>
  <button class="tab" id="tab-result" onclick="switchTab('result')">RESULTS</button>
  <button class="tab" id="tab-start" onclick="switchTab('started')">START MATCH</button>
</div>

<div id="side-menu" aria-hidden="true">
  <div class="close-menu" onclick="toggleMenu(false)">&times;</div>
  <!-- Profile area inside menu -->
  <div style="display:flex;align-items:center;gap:12px;padding:12px 6px 18px 6px;border-radius:10px;margin-bottom:8px;background:#090909">
    <div class="dp-wrap">
      <img id="menu-dp" src="https://img.icons8.com/ios-filled/50/user.png" class="dp" alt="dp">
    </div>
    <div>
      <div id="menu-name" style="font-weight:800">Guest</div>
      <div id="menu-phone" class="muted" style="font-size:0.85rem">Not logged in</div>
    </div>
  </div>

  <a href="#" class="menu-link" onclick="location.reload()"><i class="fas fa-home"></i> Home</a>
  <a href="https://chat.whatsapp.com/JR7wAllMf4SAyILFHDQClQ" class="menu-link"><i class="fab fa-whatsapp"></i> WhatsApp Group</a>
  <a href="#" class="menu-link" onclick="showPolicy()"><i class="fas fa-shield-halved"></i> Rules & Policy</a>
  <a href="#" class="menu-link" onclick="openAuthModal()"><i class="fas fa-user-circle"></i> Login / Register</a>
  <!-- removed ADMIN stub per request -->
  <div style="height:8px"></div>
  <div style="font-size:0.9rem;color:var(--muted);padding:8px;">¬© by SQL ‚Äî Built with care. All rights reserved.</div>

  <div class="menu-footer">
    <div style="display:flex;gap:8px;align-items:center">
      <img id="menu-dp-bottom" src="https://img.icons8.com/ios-filled/50/user.png" style="width:36px;height:36px;border-radius:8px;border:1px solid #222">
      <div class="muted" style="font-size:0.8rem">Account</div>
    </div>
    <div>
      <button onclick="logoutConfirm()" style="background:var(--red);color:#fff;border:none;padding:8px 10px;border-radius:8px;font-weight:800">Logout</button>
    </div>
  </div>
</div>

<main id="app-content" aria-live="polite"></main>

<!-- Payment Modal -->
<div id="pay-modal" class="modal" aria-hidden="true">
  <div class="modal-ui">
    <h3 style="color:var(--gold);margin:0">CHECKOUT</h3>
    <h2 id="modal-amt" style="color:var(--accent);margin:8px 0">‚Çπ0</h2>

    <div class="pay-grid">
      <a id="g-link" href="#" class="pay-opt"><img src="https://img.icons8.com/color/48/google-pay.png"> Google Pay / UPI</a>
      <a id="p-link" href="#" class="pay-opt"><img src="https://img.icons8.com/color/48/phone-pe.png"> PhonePe</a>
      <a id="y-link" href="#" class="pay-opt"><img src="https://img.icons8.com/color/48/paytm.png"> Paytm / UPI</a>
    </div>

    <input type="text" id="utr-input" class="allow-select" placeholder="Enter 12 Digit UTR" style="width:100%;padding:12px;background:#000;border:1px solid #333;color:var(--accent);border-radius:10px;text-align:center;font-weight:800;margin-bottom:10px">
    <input type="file" id="utr-ss" accept="image/*" style="width:100%;margin-bottom:10px">
    <hr style="border:0;border-top:1px solid #151515;margin:10px 0">
    <div style="display:grid;gap:8px">
      <input id="payer-name" placeholder="Your Name" style="padding:10px;background:#000;border:1px solid #222;border-radius:8px;color:#fff">
      <input id="payer-phone" placeholder="Phone Number" style="padding:10px;background:#000;border:1px solid #222;border-radius:8px;color:#fff">
      <input id="payer-gamingid" placeholder="Gaming ID (optional)" style="padding:10px;background:#000;border:1px solid #222;border-radius:8px;color:#fff">
      <input type="file" id="payer-dp" accept="image/*" style="padding:6px;background:#000;border-radius:8px;color:#fff">
    </div>

    <button class="btn-main btn-join" id="submit-btn" onclick="processPayment()">SUBMIT TRANSACTION</button>
    <button onclick="closeModal()" style="background:none;border:none;color:var(--red);margin-top:12px;font-weight:bold;cursor:pointer">CLOSE</button>
  </div>
</div>

<!-- Auth Modal (toggle login/register) -->
<div id="auth-modal" class="modal" aria-hidden="true">
  <div class="modal-ui">
    <h3 id="auth-title" style="color:var(--gold);margin:0">AUTH</h3>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:center">
      <button id="auth-tab-login" class="small" style="background:#111;color:var(--muted);border-radius:8px;padding:8px 10px" onclick="setAuthTab('login')">Login</button>
      <button id="auth-tab-register" class="small" style="background:#111;color:var(--muted);border-radius:8px;padding:8px 10px" onclick="setAuthTab('register')">Register</button>
    </div>
    <div id="auth-body" style="margin-top:12px"></div>
    <div style="display:flex;gap:10px;margin-top:12px;justify-content:center">
      <button id="auth-action" class="btn-main btn-join" onclick="submitAuth()">SUBMIT</button>
      <button class="btn-main btn-dis" onclick="closeAuthModal()">CANCEL</button>
    </div>
  </div>
</div>

<!-- Payment Detail Modal -->
<div id="payview-modal" class="modal" aria-hidden="true">
  <div class="modal-ui" id="payview-ui">
    <!-- filled dynamically -->
  </div>
</div>

<!-- Comment Modal -->
<div id="comment-modal" class="modal" aria-hidden="true">
  <div class="modal-ui">
    <h3 style="color:var(--gold);margin:0">Post Comment</h3>
    <div style="margin-top:12px">
      <textarea id="comment-text" placeholder="Write a comment..." style="width:100%;min-height:80px;background:#000;border:1px solid #222;color:#fff;padding:8px;border-radius:8px"></textarea>
      <div style="display:flex;gap:8px;margin-top:10px;justify-content:center">
        <button class="btn-main btn-join" onclick="submitComment()">POST</button>
        <button class="btn-main btn-dis" onclick="closeComment()">CANCEL</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast-root" style="display:none"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore, collection, onSnapshot, addDoc, query, where, orderBy, limit, getDocs, doc,
    setDoc, getDoc, updateDoc, deleteDoc, arrayUnion, increment
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // ---------- Config ----------
  const firebaseConfig = {
    apiKey: "AIzaSyBvObxADcAior6R_or9O6UmWsFT8do1GkI",
    authDomain: "sqladmin-ff04d.firebaseapp.com",
    projectId: "sqladmin-ff04d",
    storageBucket: "sqladmin-ff04d.firebasestorage.app",
    messagingSenderId: "539086978850",
    appId: "1:539086978850:web:261e6a0cf3c9a2aa29ef7b"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ---------- Cloudinary ----------
  async function uploadToCloudinary(file){
    if(!file) return "";
    const fd = new FormData();
    fd.append("file", file);
    fd.append("upload_preset", "sql_admin");
    fd.append("folder", "sql_free");
    try{
      const res = await fetch("https://api.cloudinary.com/v1_1/debp1kjtm/image/upload", { method: "POST", body: fd });
      const j = await res.json();
      return j.secure_url || "";
    }catch(e){
      console.error("cloud upload fail", e);
      return "";
    }
  }

  // ---------- Toast ----------
  function showToast(msg, time = 2400){
    const root = document.getElementById('toast-root');
    root.innerHTML = `<div class="toast">${msg}</div>`;
    root.style.display = 'block';
    setTimeout(()=>{ root.style.display = 'none'; root.innerHTML = ''; }, time);
  }

  // ---------- PBKDF2 for client-side hashing ----------
  function toBase64(buf){ const b = new Uint8Array(buf); let s=''; for(let i=0;i<b.length;i++) s+=String.fromCharCode(b[i]); return btoa(s); }
  function fromBase64(b64){ const bin = atob(b64); const arr = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i); return arr.buffer; }
  function generateSaltBase64(){ const arr = crypto.getRandomValues(new Uint8Array(16)); return toBase64(arr.buffer); }
  async function derivePasswordHash(password, saltBase64){
    const enc = new TextEncoder();
    const key = await crypto.subtle.importKey('raw', enc.encode(password), { name: 'PBKDF2' }, false, ['deriveBits']);
    const salt = fromBase64(saltBase64);
    const bits = await crypto.subtle.deriveBits({ name:'PBKDF2', salt, iterations: 150000, hash:'SHA-256' }, key, 256);
    return toBase64(bits);
  }

  // ---------- Session (store minimal) ----------
  function saveSessionProfile(profile){ localStorage.setItem('sql_session', JSON.stringify(profile)); updateMenuProfile(profile); }
  function loadSessionProfile(){ try{ return JSON.parse(localStorage.getItem('sql_session')||'null') }catch(e){return null} }
  function clearSession(){ localStorage.removeItem('sql_session'); updateMenuProfile(null); }

  function updateMenuProfile(p){
    const nameEl = document.getElementById('menu-name');
    const phoneEl = document.getElementById('menu-phone');
    const dp = document.getElementById('menu-dp');
    const dp2 = document.getElementById('menu-dp-bottom');
    if(p){
      nameEl.innerText = p.name || 'User';
      phoneEl.innerText = p.phone || '';
      dp.src = p.dpUrl || 'https://img.icons8.com/ios-filled/50/user.png';
      dp2.src = p.dpUrl || 'https://img.icons8.com/ios-filled/50/user.png';
    } else {
      nameEl.innerText = 'Guest';
      phoneEl.innerText = 'Not logged in';
      dp.src = 'https://img.icons8.com/ios-filled/50/user.png';
      dp2.src = 'https://img.icons8.com/ios-filled/50/user.png';
    }
  }

  // ---------- UI helpers ----------
  function toggleMenu(s){ document.getElementById('side-menu').classList.toggle('active', !!s); }
  function closeModalById(id){ document.getElementById(id).style.display = 'none'; }
  function openModalById(id){ document.getElementById(id).style.display = 'flex'; }

  // ---------- Policies ----------
  function showPolicy(){
    // Non-blocking modal-like via showToast plus confirm dialogs
    const msg = "HACKS NOT ALLOWED ‚Äî If hacker pakda gaya, account will be PERMANENTLY banned.";
    alert(msg + "\n\nRefund policy: Refund requests accepted within 30 minutes of payment.");
    // Using alert for clarity of two critical messages (this is acceptable for policy)
  }

  // ---------- AUTH modal logic (combined login/register) ----------
  let authTab = 'login';
  function openAuthModal(){ setAuthTab('login'); document.getElementById('auth-modal').style.display = 'flex'; }
  function closeAuthModal(){ document.getElementById('auth-modal').style.display = 'none'; }
  function setAuthTab(t){
    authTab = t;
    document.getElementById('auth-tab-login').style.opacity = t==='login'?1:0.6;
    document.getElementById('auth-tab-register').style.opacity = t==='register'?1:0.6;
    const body = document.getElementById('auth-body');
    if(t==='login'){
      body.innerHTML = `<div style="display:grid;gap:8px">
        <input id="login_phone" placeholder="Phone (e.g. +9190...)" style="padding:10px;background:#000;border:1px solid #222;border-radius:8px">
        <input id="login_password" type="password" placeholder="Password" style="padding:10px;background:#000;border:1px solid #222;border-radius:8px">
      </div>`;
      document.getElementById('auth-action').innerText = 'LOGIN';
    } else {
      body.innerHTML = `<div style="display:grid;gap:8px">
        <input id="reg_name" placeholder="Full Name" style="padding:10px;background:#000;border:1px solid #222;border-radius:8px">
        <input id="reg_email" placeholder="Email (optional)" style="padding:10px;background:#000;border:1px solid #222;border-radius:8px">
        <input id="reg_phone" placeholder="Phone (e.g. +9190...)" style="padding:10px;background:#000;border:1px solid #222;border-radius:8px">
        <input id="reg_gamingid" placeholder="Gaming UID (optional)" style="padding:10px;background:#000;border:1px solid #222;border-radius:8px">
        <input id="reg_gamingname" placeholder="Gaming Name" style="padding:10px;background:#000;border:1px solid #222;border-radius:8px">
        <input id="reg_password" type="password" placeholder="Password" style="padding:10px;background:#000;border:1px solid #222;border-radius:8px">
        <input id="reg_confirm" type="password" placeholder="Confirm Password" style="padding:10px;background:#000;border:1px solid #222;border-radius:8px">
        <input type="file" id="reg_dp" accept="image/*">
        <div class="muted" style="font-size:0.8rem">Password is hashed client-side. Phase-2 server auth (OTP) will be added later.</div>
      </div>`;
      document.getElementById('auth-action').innerText = 'REGISTER';
    }
  }

  async function submitAuth(){
    if(authTab==='register'){
      const name = (document.getElementById('reg_name').value||'').trim();
      const email = (document.getElementById('reg_email').value||'').trim();
      const phone = (document.getElementById('reg_phone').value||'').trim();
      const gamingId = (document.getElementById('reg_gamingid').value||'').trim();
      const gamingName = (document.getElementById('reg_gamingname').value||'').trim();
      const password = (document.getElementById('reg_password').value||'');
      const confirm = (document.getElementById('reg_confirm').value||'');
      const dpFile = document.getElementById('reg_dp').files[0];

      if(!name||!phone||!password||!confirm) return showToast("Fill required fields");
      if(password!==confirm) return showToast("Password mismatch");

      // check if user exists
      try{
        const uSnap = await getDoc(doc(db,"users",phone));
        if(uSnap.exists()) return showToast("Phone already registered. Login.");
      }catch(e){ console.error(e) }

      const dpUrl = dpFile? await uploadToCloudinary(dpFile) : "";
      const salt = generateSaltBase64();
      const hash = await derivePasswordHash(password, salt);

      const payload = { name, email, phone, gamingId, gamingName, dpUrl, salt, passwordHash: hash, createdAt: Date.now() };
      try{
        await setDoc(doc(db,"users", phone), payload);
        saveSessionProfile({ id: phone, name, phone, email, gamingId, gamingName, dpUrl });
        closeAuthModal();
        showToast("Registered & logged in");
        renderUI();
      }catch(e){ console.error(e); showToast("Register failed") }
    } else {
      const phone = (document.getElementById('login_phone').value||'').trim();
      const password = (document.getElementById('login_password').value||'');
      if(!phone||!password) return showToast("Enter phone & password");
      try{
        const uSnap = await getDoc(doc(db,"users", phone));
        if(!uSnap.exists()) return showToast("Account not found. Register.");
        const u = uSnap.data();
        const check = await derivePasswordHash(password, u.salt);
        if(check !== u.passwordHash) return showToast("Invalid credentials");
        saveSessionProfile({ id: phone, name: u.name, phone: u.phone, email: u.email, gamingId: u.gamingId, gamingName: u.gamingName, dpUrl: u.dpUrl || "", upiId: u.upiId || "", upiQr: u.upiQr || "" });
        closeAuthModal();
        showToast("Login successful");
        renderUI();
      }catch(e){ console.error(e); showToast("Login error") }
    }
  }

  // ---------- Profile DP change (menu) ----------
  document.getElementById('menu-dp').addEventListener('click', async ()=>{ // also clickable
    const s = loadSessionProfile();
    if(!s) return openAuthModal();
    const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*';
    inp.onchange = async ()=> {
      const f = inp.files[0];
      if(!f) return;
      showToast("Uploading...");
      const url = await uploadToCloudinary(f);
      try{
        await updateDoc(doc(db,"users", s.id), { dpUrl: url });
      }catch(e){ console.warn("update user dp failed", e) }
      s.dpUrl = url; saveSessionProfile(s);
      showToast("Profile photo updated");
      renderUI();
    };
    inp.click();
  });

  // logout with double confirm
  function logoutConfirm(){
    if(!confirm("Are you sure you want to logout?")) return;
    if(!confirm("Confirm logout ‚Äî this will clear local session.")) return;
    clearSession();
    showToast("Logged out");
    location.reload();
  }

  // ---------- Render UI (Matches + History + Results) ----------
  let activeTab = 'live';
  let activeMatchId = null;
  let commentTargetId = null;

  function switchTab(t){
    activeTab = t;
    document.getElementById('tab-live').classList.toggle('active', t==='live');
    document.getElementById('tab-my').classList.toggle('active', t==='my');
    document.getElementById('tab-result').classList.toggle('active', t==='result');
    document.getElementById('tab-start').classList.toggle('active', t==='started');
    renderUI();
  }

  // Utility: safe HTML escape
  function esc(s){ return (s===undefined||s===null)?'':String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

  // Render UI main
  function renderUI(){
    const container = document.getElementById('app-content');
    container.innerHTML = '';
    // Listen to matches realtime and render appropriate view
    onSnapshot(collection(db,"matches"), snap => {
      container.innerHTML = '';
      if(activeTab === 'result'){ renderResults(container); return; }
      if(activeTab === 'my'){ renderMyHistory(container); return; }

      snap.forEach(d => {
        const m = d.data(); const mid = d.id;
        if(activeTab === 'started'){
          const startTime = Number(m.startTime || 0);
          if(Date.now() < startTime) return;
        }

        const record = JSON.parse(localStorage.getItem(`pay_record_${mid}`) || 'null');
        const startTime = Number(m.startTime || 0);
        const isStarted = Date.now() >= startTime;
        const isExpired = Date.now() > (startTime + 3600000);
        const total = Number(m.total||0);
        const joined = Number(m.joined||0);
        const waiting = Math.max(0, total-joined);
        const fill = total>0?Math.min(100,(joined/total)*100):0;

        // IMPORTANT FIX: show room details ONLY if both conditions met:
        // payment record status === 'approved' AND match.approvedUtrs includes the utr
        let actionHtml = '';
        if(record && record.status === 'approved' && m.approvedUtrs && m.approvedUtrs.includes(record.utr)){
          // only now show room details
          if(isExpired){
            actionHtml = `<button class="btn-main btn-dis">MATCH EXPIRED</button>`;
          } else {
            actionHtml = `<div class="room-box"><h4>‚úÖ JOINED SUCCESSFULLY</h4><div class="room-data allow-select"><div><span>ROOM ID</span><b>${esc(m.roomId||'Wait...')}</b></div><div><span>PASSWORD</span><b>${esc(m.password||'Wait...')}</b></div></div></div>`;
          }
        } else if(record && record.status === 'rejected'){
          actionHtml = `<button class="btn-main" style="background:var(--red);color:#fff" disabled>PAYMENT REJECTED</button>`;
        } else if(record && record.status === 'pending'){
          // verifying state
          checkRealtimeApproval(mid, record.utr);
          actionHtml = `<button class="btn-main btn-dis" style="color:var(--gold)">VERIFYING UTR: ${esc(record.utr)}</button>`;
        } else if(isStarted){
          actionHtml = `<button class="btn-main btn-dis">MATCH STARTED</button>`;
        } else if(joined >= total){
          actionHtml = `<button class="btn-main btn-dis">MATCH FULL</button>`;
        } else {
          actionHtml = `<button class="btn-main btn-join" onclick="openPayment('${mid}', ${m.entry||0})">JOIN NOW</button>`;
        }

        container.innerHTML += `
          <div class="card">
            <div class="m-tag">${esc((m.map||'NA').toUpperCase())}</div>
            <div class="card-body">
              <div class="item"><i class="fas fa-gamepad"></i><div><span>Mode</span><b>${esc(m.type||'---')}</b></div></div>
              <div class="item"><i class="fas fa-trophy"></i><div><span>Win Prize</span><b class="win-green">‚Çπ${esc(m.win||0)}</b></div></div>
              <div class="item"><i class="fas fa-wallet"></i><div><span>Entry Fee</span><b class="entry-gold">‚Çπ${esc(m.entry||0)}</b></div></div>
              <div class="item"><i class="fas fa-id-badge"></i><div><span>Match ID</span><b>#${mid.slice(-6)}</b></div></div>
            </div>
            <div class="timer-box">
              <span class="timer-label">MATCH STARTS IN</span>
              <span class="countdown" data-time="${startTime}">--:--:--</span>
            </div>
            <div class="card-footer">
              <div class="slots"><span>Filled: ${joined}/${total}</span><span class="waiting">Waiting: ${waiting}</span></div>
              <div class="bar"><div class="fill" style="width:${fill}%"></div></div>
              ${actionHtml}
            </div>
          </div>`;
      });
    }, err => console.error('matches snapshot error', err));
  }

  // ---------- Realtime approval check ----------
  function checkRealtimeApproval(mid, utr){
    const q = query(collection(db,"payments"), where("matchId","==",mid), where("utr","==",utr));
    onSnapshot(q, snap => {
      snap.forEach(d => {
        const p = d.data();
        if(p.status === 'approved'){
          // update local record
          const local = JSON.parse(localStorage.getItem(`pay_record_${mid}`) || 'null');
          if(local){ local.status = 'approved'; localStorage.setItem(`pay_record_${mid}`, JSON.stringify(local)); }
        }
      });
    });
  }

  // ---------- Timer update ----------
  setInterval(()=>{
    document.querySelectorAll('.countdown').forEach(el=>{
      const target = Number(el.dataset.time || 0);
      const diff = target - Date.now();
      if(diff <= 0){ el.innerText = "STARTED"; el.style.color = "var(--accent)"; }
      else{
        const h = Math.floor(diff/3600000);
        const m = Math.floor((diff%3600000)/60000);
        const s = Math.floor((diff%60000)/1000);
        el.innerText = `${h}h : ${m}m : ${s}s`;
      }
    });
  },1000);

  // ---------- Payment flow ----------
  window.openPayment = (id, amt) => {
    const session = loadSessionProfile();
    if(!session) { openAuthModal(); showToast("Please login to join"); return; }
    activeMatchId = id;
    document.getElementById('modal-amt').innerText = "‚Çπ" + amt;
    const upi = `upi://pay?pa=rizwanhasan90122778623@ybl&am=${amt}&cu=INR&tn=SQL_ARENA_${id}`;
    document.getElementById('g-link').href = upi;
    document.getElementById('p-link').href = upi;
    document.getElementById('y-link').href = upi;
    document.getElementById('payer-name').value = session.name || "";
    document.getElementById('payer-phone').value = session.phone || "";
    document.getElementById('payer-gamingid').value = session.gamingId || session.gamingid || "";
    document.getElementById('pay-modal').style.display = 'flex';
  };

  window.closeModal = ()=>{ document.getElementById('pay-modal').style.display = 'none' };

  window.processPayment = async ()=>{
    const session = loadSessionProfile(); if(!session) return showToast("Please login");
    const utr = (document.getElementById('utr-input').value||'').trim();
    if(utr.length !== 12) return showToast("Enter valid 12-digit UTR");
    const btn = document.getElementById('submit-btn'); btn.disabled=true; btn.innerText="Processing...";
    const ssFile = document.getElementById('utr-ss').files[0];
    const dpFile = document.getElementById('payer-dp').files[0];
    const name = (document.getElementById('payer-name').value||'').trim();
    const phone = (document.getElementById('payer-phone').value||'').trim();
    const gamingid = (document.getElementById('payer-gamingid').value||'').trim();
    if(!name||!phone){ btn.disabled=false; btn.innerText="SUBMIT TRANSACTION"; return showToast("Enter name & phone"); }

    const ssUrl = ssFile? await uploadToCloudinary(ssFile):"";
    const dpUrl = dpFile? await uploadToCloudinary(dpFile): session.dpUrl || "";

    const record = { utr, matchId: activeMatchId, status: 'pending', date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString(), payer: { name, phone, gamingid, dpUrl }, timestamp: Date.now() };
    localStorage.setItem(`pay_record_${activeMatchId}`, JSON.stringify(record));

    try{
      await addDoc(collection(db,"payments"), { ...record, ss: ssUrl });
    }catch(e){ console.error("payments add failed", e) }

    // local log
    const logs = JSON.parse(localStorage.getItem('sql_paylogs') || '[]');
    logs.unshift({ matchId: activeMatchId, utr, ss: ssUrl, name, phone, gamingid, date: new Date().toLocaleString(), status: 'pending' });
    localStorage.setItem('sql_paylogs', JSON.stringify(logs.slice(0,200)));

    // update user profile with dp/gamingid if changed and save to DB
    const existing = loadSessionProfile() || {};
    existing.name = name; existing.phone = phone; existing.gamingId = gamingid || existing.gamingId;
    if(dpUrl) existing.dpUrl = dpUrl;
    saveSessionProfile(existing);
    try{ await updateDoc(doc(db,"users", existing.id || existing.phone), { dpUrl: existing.dpUrl || "", gamingId: existing.gamingId || "" }); }catch(e){ /* tolerate */ }

    showToast("UTR submitted ‚Äî waiting admin approval");
    closeModal();
    btn.disabled=false; btn.innerText="SUBMIT TRANSACTION";
    renderUI();
  };

  // ---------- My History (improved) ----------
  function renderMyHistory(container){
    const session = loadSessionProfile();
    const wrapper = document.createElement('div'); wrapper.style.gridColumn="1/-1"; wrapper.style.padding="6px 0 20px 0";
    if(!session){
      wrapper.innerHTML = `<div class="card"><div class="muted">Not logged in. Please login/register to see your history.</div><div style="display:flex;gap:8px;margin-top:8px"><button class="small" onclick="openAuthModal()">Login/Register</button></div></div>`; container.appendChild(wrapper); return;
    }

    // Profile UI (without logout here per request)
    wrapper.innerHTML = `
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="display:flex;gap:12px;align-items:center">
            <div class="dp-wrap">
              <img id="profile-dp" class="dp" src="${esc(session.dpUrl||'https://img.icons8.com/ios-filled/50/user.png')}" alt="dp">
              <div class="dp-pencil" id="dp-pencil" title="Change avatar"><i class="fas fa-pencil"></i></div>
            </div>
            <div>
              <div style="font-weight:800">${esc(session.name)}</div>
              <div class="muted">${esc(session.phone)} ‚Ä¢ Gaming ID: ${esc(session.gamingId||'‚Äî')}</div>
            </div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="small" onclick="showHistory('active')">Active Joined</button>
            <button class="small" onclick="showHistory('past')">Past Matches</button>
            <button class="small" onclick="openProfileEdit()">Edit Profile</button>
          </div>
        </div>
        <div id="history-list" style="margin-top:12px"></div>
      </div>
    `;
    container.appendChild(wrapper);

    // DP pencil handler
    document.getElementById('dp-pencil').onclick = async ()=>{
      const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*';
      inp.onchange = async ()=>{
        const f = inp.files[0]; if(!f) return;
        showToast("Uploading dp...");
        const url = await uploadToCloudinary(f);
        const s = loadSessionProfile(); s.dpUrl = url; saveSessionProfile(s);
        try{ await updateDoc(doc(db,"users", s.id || s.phone), { dpUrl: url }); }catch(e){/*ignore*/ }
        document.getElementById('profile-dp').src = url;
        updateMenuProfile(s);
        showToast("Profile photo updated");
      }; inp.click();
    };

    // default show active
    showHistory('active');
  }

  function openProfileEdit(){
    const s = loadSessionProfile();
    if(!s) return openAuthModal();
    // small profile edit UI using modal (re-use auth modal)
    setAuthTab('register');
    document.getElementById('auth-modal').style.display = 'flex';
    // populate register fields if present
    setTimeout(()=>{ // ensure DOM created
      document.getElementById('reg_name').value = s.name || '';
      document.getElementById('reg_email').value = s.email || '';
      document.getElementById('reg_phone').value = s.phone || '';
      document.getElementById('reg_gamingid').value = s.gamingId || '';
      document.getElementById('reg_gamingname').value = s.gamingName || '';
      document.getElementById('reg_password').value = '';
      document.getElementById('reg_confirm').value = '';
    },100);
  }

  function showHistory(type){
    const list = document.getElementById('history-list');
    list.innerHTML = '';
    const logs = JSON.parse(localStorage.getItem('sql_paylogs')||'[]');
    const s = loadSessionProfile();
    if(!s){ list.innerHTML = '<div class="muted">No profile.</div>'; return; }
    const my = logs.filter(l => l.phone === s.phone);
    if(type==='active'){
      const active = my.filter(l => {
        const rec = JSON.parse(localStorage.getItem(`pay_record_${l.matchId}`) || 'null');
        return rec && rec.status !== 'approved' ? rec : rec;
      });
      if(active.length===0){ list.innerHTML = '<div class="muted">No active joined matches.</div>'; return; }
      active.forEach(a=>{
        const el = document.createElement('div'); el.className='result-card';
        el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><b>Match: ${a.matchId.slice(-6)}</b><div class="muted">UTR: ${a.utr} ‚Ä¢ ${a.date}</div></div><div><button class="small" onclick="viewPaymentModal('${a.matchId}')">View</button></div></div>`;
        list.appendChild(el);
      });
    } else {
      if(my.length===0){ list.innerHTML = '<div class="muted">No past matches yet.</div>'; return; }
      my.forEach(a=>{
        const el = document.createElement('div'); el.className='result-card';
        el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><b>Match: ${a.matchId.slice(-6)}</b><div class="muted">${a.date}</div></div><div><button class="small" onclick="viewPaymentModal('${a.matchId}')">View</button></div></div>`;
        list.appendChild(el);
      });
    }
  }

  // View payment details modal (shows ss, payer dp, utr)
  async function viewPaymentModal(matchId){
    // find payment document for this match and current user
    const s = loadSessionProfile();
    if(!s) return showToast("Login to view payment");
    // find in payments collection by matchId + payer.phone
    const q = query(collection(db,"payments"), where("matchId","==", matchId), where("payer.phone","==", s.phone));
    const snap = await getDocs(q);
    if(snap.empty) return showToast("Payment record not found on server. (Maybe pending)");
    const pDoc = snap.docs[0]; const p = pDoc.data();
    const ui = document.getElementById('payview-ui');
    ui.innerHTML = `<h3 style="color:var(--gold);margin:0">Payment</h3>
      <div style="margin-top:10px;text-align:left">
        <div style="display:flex;gap:12px;align-items:center">
          <img src="${esc(p.payer?.dpUrl||'https://img.icons8.com/ios-filled/50/user.png')}" style="width:72px;height:72px;border-radius:10px;border:1px solid #222">
          <div><b>${esc(p.payer?.name||'‚Äî')}</b><div class="muted">${esc(p.payer?.phone||'‚Äî')}</div></div>
        </div>
        <div style="margin-top:10px"><b>UTR:</b> ${esc(p.utr)}<br><b>Match:</b> ${esc(p.matchId)}</div>
        ${p.ss ? `<img src="${p.ss}" style="width:100%;margin-top:10px;border-radius:8px">` : '<div class="muted" style="margin-top:10px">No screenshot attached</div>'}
        <div style="margin-top:12px" class="muted">Status: ${esc(p.status)}</div>
        <div style="margin-top:10px"><button class="btn-main btn-dis" onclick="closeModalById('payview-modal')">Close</button></div>
      </div>`;
    openModalById('payview-modal');
  }

  // ---------- Results (for user) ----------
  async function renderResults(container){
    // top area (no admin upload button visible on public site)
    const headerCard = document.createElement('div'); headerCard.className='card';
    headerCard.innerHTML = `<div style="display:flex;gap:12px;align-items:center"><div class="muted" style="padding:12px">Results show here. You can like & comment.</div></div>`;
    container.appendChild(headerCard);

    // fetch latest results
    try{
      const q = query(collection(db,"results"), orderBy("timestamp","desc"), limit(100));
      const snap = await getDocs(q);
      if(snap.empty){ const e = document.createElement('div'); e.className='card'; e.innerHTML='<div class="muted">Result Coming Soon ‚åõ</div>'; container.appendChild(e); return; }
      for(const d of snap.docs){
        const r = d.data(); const id = d.id;
        const rc = document.createElement('div'); rc.className='result-card';
        // fetch likes count if present
        const likes = Number(r.likesCount || 0);
        // fetch comments count
        const cQ = query(collection(db,"result_comments"), where("resultId","==", id), orderBy("timestamp","asc"));
        const cSnap = await getDocs(cQ);
        const commentsHtml = cSnap.docs.map(c => `<div style="border-top:1px dashed #222;padding-top:8px;margin-top:8px"><b>${esc(c.data().name||'User')}</b><div class="muted">${new Date(c.data().timestamp||Date.now()).toLocaleString()}</div><div style="margin-top:6px">${esc(c.data().text)}</div></div>`).join('');
        rc.innerHTML = `
          <div class="result-meta">
            <div><b>${esc(r.title || 'Result')}</b><div class="muted">${r.matchId? 'Match: ' + esc(r.matchId): ''}</div></div>
            <div class="muted">${new Date(r.timestamp || Date.now()).toLocaleString()}</div>
          </div>
          ${r.image ? `<img class="result-img" src="${esc(r.image)}" alt="result">` : ''}
          <div style="margin-top:8px">
            <div><b>Winner:</b> ${esc(r.winner||'‚Äî')} ${r.uid? '‚Ä¢ UID: '+esc(r.uid):''}</div>
            <div class="muted" style="margin-top:8px">${esc(r.body||'')}</div>
          </div>
          <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
            <button class="small" onclick="toggleLike('${id}')">üëç <span id="lk-${id}">${likes}</span></button>
            <button class="small" onclick="openCommentModal('${id}')">üí¨ Comment</button>
          </div>
          <div id="comments-${id}" style="margin-top:10px">${commentsHtml}</div>
        `;
        container.appendChild(rc);
      }
    }catch(e){ console.error(e); container.innerHTML += '<div class="card"><div class="muted">Error loading results</div></div>' }
  }

  // Likes - prevent double like by checking result_likes doc id
  async function toggleLike(resultId){
    const session = loadSessionProfile(); if(!session) return openAuthModal();
    const likeDocId = `${resultId}_${session.phone}`;
    try{
      const g = await getDoc(doc(db,"result_likes",likeDocId));
      if(g.exists()) return showToast("You already liked");
      // create like doc and increment count atomically using update on results (best effort)
      await setDoc(doc(db,"result_likes",likeDocId), { id: likeDocId, resultId, phone: session.phone, name: session.name, timestamp: Date.now() });
      try{
        await updateDoc(doc(db,"results", resultId), { likesCount: increment(1) });
      }catch(e){
        // fallback: if update fails, ignore
      }
      // update UI count quickly
      const el = document.getElementById(`lk-${resultId}`);
      if(el) el.innerText = Number(el.innerText||0) + 1;
      showToast("Liked");
    }catch(e){ console.error(e); showToast("Like error") }
  }

  // Comments
  function openCommentModal(resultId){
    const s = loadSessionProfile(); if(!s) return openAuthModal();
    commentTargetId = resultId; document.getElementById('comment-text').value = ''; openModalById('comment-modal');
  }
  function closeComment(){ closeModalById('comment-modal'); commentTargetId = null; }
  async function submitComment(){
    const text = (document.getElementById('comment-text').value||'').trim();
    const s = loadSessionProfile(); if(!s) return showToast("Login to comment");
    if(!text) return showToast("Enter comment");
    try{
      await addDoc(collection(db,"result_comments"), { resultId: commentTargetId, text, name: s.name, phone: s.phone, timestamp: Date.now() });
      showToast("Comment submitted");
      closeComment();
      // re-render results to show new comment
      renderUI();
    }catch(e){ console.error(e); showToast("Comment error") }
  }

  // ---------- Small utilities and initial render ----------
  function closeModal(){ document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); }
  window.closeComment = closeComment; window.openAuthModal = openAuthModal;

  // Expose some helpers globally (for inline handlers)
  window.toggleMenu = toggleMenu;
  window.switchTab = switchTab;
  window.openPayment = openPayment;
  window.processPayment = processPayment;
  window.viewPaymentModal = viewPaymentModal;
  window.openCommentModal = openCommentModal;
  window.toggleLike = toggleLike;
  window.openAuthModal = openAuthModal;

  // Update menu from stored session
  updateMenuProfile(loadSessionProfile());
  // initial render
  renderUI();

  // close modals on outside click
  window.addEventListener('click', (e)=>{
    document.querySelectorAll('.modal').forEach(id=>{
      if(id.style.display === 'flex' && e.target === id) id.style.display = 'none';
    });
  });

  // helper to wrap firebase doc() usage in functions used earlier
  // adding setDoc/getDoc to top-level scope used above
  // (they've already been imported)
</script>
</body>
    </html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>SQL TOURNAMENT PRO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #00ff88; --gold: #ffd700; --bg: #050505; --card: #121212; --border: #222; --red: #ff4444; --muted:#888; --waiting:#ffae00; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: 'Poppins', sans-serif; overflow-x: hidden; }
        .allow-select, .room-data b { user-select: text !important; cursor: text; }

        header { background: #000; padding: 15px; border-bottom: 2px solid var(--gold); text-align: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 20px rgba(255, 215, 0, 0.1); }
        .header-title { color: var(--gold); font-weight: 800; font-size: 0.95rem; margin: 0; letter-spacing: 0.5px; text-transform: uppercase; }
        .header-sub { color: var(--accent); font-size: 0.7rem; display: block; margin-top: 2px; }
        .menu-btn { position: absolute; right: 20px; top: 18px; color: var(--gold); font-size: 1.4rem; cursor: pointer; }

        .tabs { display: flex; gap:8px; margin: 12px; background: #111; border-radius: 12px; border:1px solid var(--border); padding:6px; }
        .tab { flex: 1; padding: 10px; border: none; background: none; color: var(--muted); font-weight: 700; font-size: 0.8rem; cursor: pointer; transition: 0.2s; text-align:center; border-radius:10px; }
        .tab.active { background: var(--accent); color: #000; box-shadow: 0 0 10px var(--accent); }
        .small-btn { padding:6px 12px; font-size:0.75rem; border-radius:8px; border:1px solid #333; background:#0b0b0b; color:#ccc; cursor:pointer; font-weight:600; }

        #app-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 15px; padding: 10px 12px 90px 12px; }

        .card { background: var(--card); border-radius: 18px; border:1px solid var(--border); overflow: hidden; position: relative; }
        .m-tag { position: absolute; top: 12px; right: 15px; font-size: 0.65rem; background:#000; padding:4px 8px; border:1px solid var(--accent); border-radius:6px; color:var(--accent); font-weight:800; }
        .card-body { padding: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .item { display:flex; gap:10px; align-items:center; }
        .item i { color: var(--gold); font-size:1rem; width:20px; text-align:center; }
        .item div span { display:block; font-size:0.6rem; color:var(--muted); text-transform:uppercase; }
        .item div b { font-size:0.95rem; color:#fff; }
        .win-green { color: var(--accent); }
        .entry-gold { color: var(--gold); }

        .timer-box { background:#080808; padding:10px; text-align:center; border-top:1px solid #222; border-bottom:1px solid #222; }
        .countdown { font-family: monospace; font-size:1.2rem; color:var(--waiting); font-weight:900; }

        .card-footer { padding:14px; }
        .slots { display:flex; justify-content:space-between; font-size:0.75rem; margin-bottom:8px; font-weight:800; }
        .bar { height:8px; background:#222; border-radius:12px; overflow:hidden; margin-bottom:12px; }
        .fill { height:100%; background:linear-gradient(90deg, var(--accent), #008f4c); transition:1s ease; }

        .btn-main { width:100%; padding:14px; border-radius:12px; border:none; font-weight:900; font-size:1rem; cursor:pointer; transition:0.2s; text-transform:uppercase; }
        .btn-join { background:var(--accent); color:#000; }
        .btn-dis { background:#222; color:var(--muted); cursor:not-allowed; }

        .room-box { background: rgba(0, 255, 136, 0.05); border:1px dashed var(--accent); padding:15px; border-radius:12px; text-align:center; margin-bottom:10px; }
        .room-box h4 { margin:0 0 10px; font-size:0.8rem; color:var(--accent); }
        .room-data { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
        .room-data div { background:#000; padding:10px; border-radius:8px; border:1px solid #333; }
        .room-data div span { display:block; font-size:0.6rem; color:var(--muted); margin-bottom:4px; }
        .room-data div b { font-size:1rem; color:#fff; font-family:monospace; }

        #side-menu { position: fixed; top:0; right:-100%; width:300px; height:100%; background:#0a0a0a; z-index:5000; transition:0.4s; border-left:1px solid var(--gold); display:flex; flex-direction:column; }
        #side-menu.active { right:0; }
        .menu-header { padding:20px; border-bottom:1px solid #222; display:flex; align-items:center; gap:15px; background:#000; }
        .menu-dp { width:50px; height:50px; border-radius:50%; border:2px solid var(--gold); }
        .menu-items { padding:10px; overflow-y:auto; flex:1; }
        .menu-link { display:flex; align-items:center; gap:15px; padding:16px; color:#ddd; text-decoration:none; border-bottom:1px solid #1a1a1a; font-weight:600; font-size:0.95rem; }
        .menu-link i { width:25px; text-align:center; color:var(--gold); }
        .close-menu { position:absolute; top:15px; right:15px; color:var(--red); font-size:1.8rem; cursor:pointer; }
        .menu-footer { padding:20px; border-top:1px solid #222; text-align:center; background:#000; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 6000; display:none; align-items:center; justify-content:center; padding:15px; }
        .modal-ui { background:#111; width:100%; max-width:480px; padding:25px; border-radius:20px; border:1px solid var(--gold); }
        .pay-opt { display:flex; align-items:center; gap:15px; padding:12px; background:#1a1a1a; border-radius:12px; text-decoration:none; color:#fff; border:1px solid #333; margin-bottom:10px; }
        .pay-opt img { width:32px; }
        input, textarea { width:100%; background:#050505; border:1px solid #333; color:#fff; padding:12px; border-radius:10px; outline:none; margin-bottom:10px; }

        .profile-head { background: linear-gradient(180deg, #1a1a1a, #050505); padding:20px; border-radius:16px; text-align:center; border:1px solid #333; margin-bottom:20px; }
        .p-img-cont { position:relative; width:80px; height:80px; margin:0 auto 10px; }
        .p-img { width:100%; height:100%; border-radius:50%; border:2px solid var(--accent); }
        .p-edit { position:absolute; bottom:0; right:0; background:var(--gold); color:#000; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.8rem; cursor:pointer; border:2px solid #000; }

        .stats-box { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:20px; }
        .stat-item { background:#0b0b0b; padding:10px 5px; border-radius:10px; border:1px solid #222; text-align:center; }
        .stat-lbl { font-size:0.6rem; color:#888; text-transform:uppercase; display:block; margin-bottom:4px; font-weight:700; }
        .stat-val { font-size:1rem; font-weight:800; }
        .st-gold { color:var(--gold); font-size:1.1rem; }
        .st-red { color:var(--red); }
        .st-green { color:var(--accent); }

        .wallet-actions { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px; }
        .w-act-btn { padding:12px; border-radius:12px; border:1px solid #333; background:#111; color:#fff; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; font-size:0.85rem; }
        .pkg-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:15px; }
        .pkg-box { background:#1a1a1a; padding:12px; border-radius:10px; border:1px solid #333; text-align:center; cursor:pointer; font-weight:bold; }
        .pkg-box.active { border-color:var(--gold); color:var(--gold); }

        .result-card { background:#121212; padding:0; border-radius:16px; margin-bottom:15px; overflow:hidden; }
        .r-head { padding:12px; background:#080808; border-bottom:1px solid #222; display:flex; justify-content:space-between; }
        .r-img { width:100%; display:block; max-height:250px; object-fit:cover; }
        .r-body { padding:15px; }
        .winner-box { background: linear-gradient(45deg, #ffd70010, transparent); border-left:3px solid var(--gold); padding:10px; margin-bottom:10px; }
        .winner-row { display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:4px; }
        .r-actions { padding:10px 15px; border-top:1px solid #222; display:flex; gap:20px; }
        .act-btn { background:none; border:none; color:#888; cursor:pointer; font-size:0.9rem; display:flex; align-items:center; gap:6px; }

        #comment-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 7000; display: none; flex-direction: column; }
        .cp-header { padding:15px; border-bottom:1px solid #222; display:flex; align-items:center; gap:15px; background:#080808; }
        .cp-back { color:#fff; font-size:1.2rem; cursor:pointer; }
        .cp-body { flex:1; overflow-y:auto; padding:15px; padding-bottom:80px; }
        .cp-footer { position: absolute; bottom: 0; width: 100%; background: #111; padding: 10px; border-top: 1px solid #333; display: flex; gap: 10px; }
        .cp-item { margin-bottom:15px; display:flex; gap:10px; }
        .cp-dp { width:35px; height:35px; border-radius:50%; background:#222; }
        .cp-box { background:#1a1a1a; padding:8px 12px; border-radius:12px; max-width:85%; }
        .cp-name { font-size:0.75rem; font-weight:bold; color:var(--gold); display:block; margin-bottom:2px; }
        .cp-text { font-size:0.85rem; color:#eee; }
    </style>
</head>
<body>
<header>
    <p class="header-title">FREE FIRE DAILY TOURNAMENT</p>
    <span class="header-sub">JOIN PLAY & WIN REAL MONEY ðŸ’°</span>
    <div class="menu-btn" onclick="toggleMenu(true)"><i class="fas fa-bars-staggered"></i></div>
</header>

<div class="tabs">
    <button class="tab active" id="tab-live" onclick="switchTab('live')">LIVE</button>
    <button class="tab" id="tab-my" onclick="switchTab('my')">PROFILE</button>
    <button class="tab" id="tab-result" onclick="switchTab('result')">RESULTS</button>
</div>

<div id="side-menu">
    <div class="close-menu" onclick="toggleMenu(false)">&times;</div>
    <div class="menu-header">
        <img id="menu-user-dp" src="https://img.icons8.com/color/96/user-male-circle.png" class="menu-dp">
        <div>
            <div id="menu-user-name" style="font-weight:bold; color:#fff;">Guest</div>
            <div id="menu-user-bal-side" style="font-size:0.7rem; color:var(--accent);">â‚¹0.00</div>
        </div>
    </div>
    <div class="menu-items">
        <a href="#" class="menu-link" onclick="location.reload()"><i class="fas fa-home"></i> Home</a>
        <a href="#" id="menu-auth-btn" class="menu-link" onclick="openAuthModal('login')"><i class="fas fa-sign-in-alt"></i> Login</a>
    </div>
    <div class="menu-footer">
        <button id="menu-logout-btn" onclick="confirmLogout()" style="background:#222; color:var(--red); border:none; padding:12px; width:100%; border-radius:10px; display:none; cursor:pointer;">LOGOUT</button>
    </div>
</div>

<main id="app-content"></main>

<div id="wallet-modal" class="modal">
    <div class="modal-ui">
        <h3 id="wallet-modal-title" style="color:var(--gold); text-align:center; margin-bottom:15px;">ADD FUND</h3>
        <div id="add-fund-form">
            <div class="pkg-grid">
                <div class="pkg-box" onclick="setPkg(50)">â‚¹50</div>
                <div class="pkg-box" onclick="setPkg(100)">â‚¹100</div>
                <div class="pkg-box" onclick="setPkg(500)">â‚¹500</div>
                <div class="pkg-box" onclick="setPkg(1000)">â‚¹1000</div>
            </div>
            <input type="number" id="manual-amt" placeholder="Amount" style="text-align:center;">
            <button class="btn-main btn-join" onclick="initWalletDeposit()">DEPOSIT</button>
        </div>
        <div id="withdraw-form" style="display:none;">
            <input type="number" id="with-amt" placeholder="Amount (Min â‚¹50)">
            <input type="text" id="with-upi" placeholder="UPI ID">
            <button class="btn-main" style="background:var(--gold); color:#000;" onclick="submitWithdrawal()">WITHDRAW</button>
        </div>
        <button onclick="document.getElementById('wallet-modal').style.display='none'" style="width:100%; background:none; border:none; color:#555; margin-top:10px; cursor:pointer;">CLOSE</button>
    </div>
</div>

<div id="pay-modal" class="modal">
    <div class="modal-ui">
        <h3 style="color:var(--gold); text-align:center;">PAYMENT</h3>
        <h1 id="modal-amt" style="color:var(--accent); text-align:center; font-size:2.5rem;">â‚¹0</h1>
        <div id="wallet-pay-box" style="display:none; text-align:center; margin:15px 0;">
            <span style="color:var(--accent);">Wallet: <b id="pay-modal-bal">â‚¹0</b></span>
            <button class="btn-main btn-join" style="margin-top:10px;" onclick="payViaWallet()">PAY VIA WALLET</button>
        </div>
        <div id="manual-pay-div">
            <a id="g-link" href="#" class="pay-opt"><img src="https://img.icons8.com/color/48/google-pay.png"> Google Pay</a>
            <input type="text" id="utr-input" placeholder="UTR Number" maxlength="12" style="text-align:center;">
            <input type="file" id="utr-ss" accept="image/*">
            <button class="btn-main btn-join" id="submit-pay-btn" onclick="processPayment()">SUBMIT</button>
        </div>
        <button onclick="closeModal()" class="btn-main" style="background:#222; margin-top:10px;">CANCEL</button>
    </div>
</div>

<div id="auth-modal" class="modal">
    <div class="modal-ui">
        <h2 id="auth-title" style="color:var(--gold); text-align:center;">LOGIN</h2>
        <div id="auth-forms"></div>
        <button id="auth-submit-btn" class="btn-main btn-join" onclick="submitAuth()">LOGIN</button>
        <p style="text-align:center; font-size:0.8rem; margin-top:15px; color:#888; cursor:pointer;" onclick="toggleAuthMode()">
            <span id="auth-toggle-msg">Register?</span>
        </p>
        <button onclick="document.getElementById('auth-modal').style.display='none'" style="position:absolute; top:15px; right:15px; background:none; border:none; color:#555; font-size:1.5rem;">&times;</button>
    </div>
</div>

<div id="comment-page">
    <div class="cp-header">
        <i class="fas fa-arrow-left cp-back" onclick="closeCommentPage()"></i>
        <span style="font-weight:bold;">Comments</span>
    </div>
    <div class="cp-body" id="cp-list"></div>
    <div class="cp-footer">
        <input type="text" id="cp-input" placeholder="Comment..." style="margin:0; border-radius:20px;">
        <button class="small-btn" onclick="postComment()" style="border-radius:20px;"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<div id="history-modal" class="modal">
    <div class="modal-ui" style="max-height:80vh; overflow-y:auto;">
        <h3 id="hist-title" style="color:var(--gold); text-align:center;">HISTORY</h3>
        <div id="hist-content"></div>
        <button onclick="document.getElementById('history-modal').style.display='none'" style="width:100%; background:none; border:none; color:#555; margin-top:15px; cursor:pointer;">CLOSE</button>
    </div>
</div>

<input type="file" id="hidden-dp" accept="image/*" style="display:none;" onchange="updateDP(this)">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, onSnapshot, addDoc, query, where, orderBy, getDocs, doc, getDoc, updateDoc, increment, runTransaction, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
    apiKey: "AIzaSyBvObxADcAior6R_or9O6UmWsFT8do1GkI",
    authDomain: "sqladmin-ff04d.firebaseapp.com",
    projectId: "sqladmin-ff04d"
});
const db = getFirestore(app);

let activeTab = 'live', authMode = 'login', activeMatchId = null, activeFee = 0, currentResultId = null, commentUnsub = null, userBal = 0;

function loadSession(){ try{ return JSON.parse(localStorage.getItem('sql_session')||"null"); }catch{ return null; }}
function saveSession(d){ localStorage.setItem('sql_session', JSON.stringify(d)); updateMenu(); }
function clearSession(){ localStorage.removeItem('sql_session'); updateMenu(); renderUI(); }

function startWalletSync(phone){
    onSnapshot(doc(db,"users",phone), snap => {
        if(snap.exists()){
            const d = snap.data();
            userBal = d.balance||0;
            document.getElementById('menu-user-bal-side').innerText = `â‚¹${userBal.toFixed(2)}`;
            saveSession(d);
        }
    });
}

function updateMenu(){
    const s = loadSession();
    const dp = document.getElementById('menu-user-dp');
    const nm = document.getElementById('menu-user-name');
    const authBtn = document.getElementById('menu-auth-btn');
    const logoutBtn = document.getElementById('menu-logout-btn');
    if(s){
        dp.src = s.dpUrl || "https://img.icons8.com/color/96/user-male-circle.png";
        nm.innerText = s.name;
        authBtn.style.display = 'none';
        logoutBtn.style.display = 'block';
        document.getElementById('menu-user-bal-side').innerText = `â‚¹${(s.balance||0).toFixed(2)}`;
    }else{
        dp.src = "https://img.icons8.com/color/96/user-male-circle.png";
        nm.innerText = "Guest";
        authBtn.style.display = 'flex';
        logoutBtn.style.display = 'none';
        document.getElementById('menu-user-bal-side').innerText = "â‚¹0.00";
    }
}

window.openAuthModal = mode => { document.getElementById('auth-modal').style.display='flex'; authMode=mode; renderAuthForm(); };
window.toggleAuthMode = () => { authMode = authMode==='login'?'register':'login'; renderAuthForm(); };

function renderAuthForm(){
    const ui = document.getElementById('auth-forms');
    const title = document.getElementById('auth-title');
    const msg = document.getElementById('auth-toggle-msg');
    const btn = document.getElementById('auth-submit-btn');
    if(authMode==='login'){
        title.innerText="LOGIN"; btn.innerText="LOGIN";
        msg.innerHTML='New? <span style="color:var(--accent)">Register</span>';
        ui.innerHTML=`<input id="login_phone" type="number" placeholder="Phone" maxlength="10"><input id="login_pass" type="password" placeholder="Password">`;
    }else{
        title.innerText="REGISTER"; btn.innerText="REGISTER";
        msg.innerHTML='Have account? <span style="color:var(--accent)">Login</span>';
        ui.innerHTML=`<input id="reg_name" placeholder="Name"><input id="reg_phone" type="number" placeholder="Phone" maxlength="10"><input id="reg_gaming" placeholder="Gaming UID"><input id="reg_pass" type="password" placeholder="Password">`;
    }
}

window.submitAuth = async () => {
    const btn = document.getElementById('auth-submit-btn');
    btn.disabled=true; btn.innerText="Processing...";
    try{
        if(authMode==='register'){
            const name = document.getElementById('reg_name').value.trim();
            const phone = document.getElementById('reg_phone').value.trim();
            const gaming = document.getElementById('reg_gaming').value.trim();
            const pass = document.getElementById('reg_pass').value.trim();
            if(!name||!phone||phone.length!==10||!gaming||!pass) throw "All fields required";
            const snap = await getDoc(doc(db,"users",phone));
            if(snap.exists()) throw "Phone exists";
            const userData = { name, phone, gamingName:gaming, password:pass, dpUrl:"", upiId:"", balance:0, totalProfit:0, totalLoss:0 };
            await setDoc(doc(db,"users",phone), userData);
            saveSession(userData);
            startWalletSync(phone);
            alert("Registered!");
        }else{
            const phone = document.getElementById('login_phone').value.trim();
            const pass = document.getElementById('login_pass').value.trim();
            if(!phone||!pass) throw "Enter credentials";
            const snap = await getDoc(doc(db,"users",phone));
            if(!snap.exists()) throw "User not found";
            const d = snap.data();
            if(d.password!==pass) throw "Wrong password";
            saveSession(d);
            startWalletSync(phone);
        }
        document.getElementById('auth-modal').style.display='none';
        renderUI();
    }catch(e){ alert(e); }
    finally{ btn.disabled=false; btn.innerText=authMode==='login'?"LOGIN":"REGISTER"; }
};

window.confirmLogout = () => { if(confirm("Logout?")&&confirm("Confirm?")){ clearSession(); toggleMenu(false); }};

window.switchTab = t => {
    activeTab=t;
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    document.getElementById(`tab-${t}`).classList.add('active');
    renderUI();
};

function renderUI(){
    const c = document.getElementById('app-content');
    c.innerHTML="";
    if(activeTab==='live') renderLive(c);
    else if(activeTab==='my') renderProfile(c);
    else if(activeTab==='result') renderResults(c);
}

function renderLive(container){
    onSnapshot(collection(db,"matches"), snap => {
        if(activeTab!=='live') return;
        container.innerHTML="";
        const matches=[];
        snap.forEach(d => matches.push({id:d.id, ...d.data()}));
        matches.sort((a,b)=>a.startTime-b.startTime);
        matches.forEach(m => {
            const now=Date.now(), start=m.startTime||0;
            const isStarted=now>start, isFull=(m.joined||0)>=(m.total||48);
            const fill=Math.min(100,((m.joined||0)/(m.total||48))*100);
            const myRec=JSON.parse(localStorage.getItem(`pay_${m.id}`)||"null");
            let btnHTML="", roomHTML="";
            if(myRec){
                if(myRec.status==='approved'||(m.approvedUtrs&&m.approvedUtrs.includes(myRec.utr))){
                    if(isStarted){
                        roomHTML=`<div class="room-box"><h4>âœ… STARTED</h4><div class="room-data"><div><span>ID</span><b>${m.roomId}</b></div><div><span>PASS</span><b>${m.password}</b></div></div></div>`;
                        btnHTML=`<button class="btn-main btn-dis">GOOD LUCK</button>`;
                    }else{
                        roomHTML=`<div class="room-box"><h4>âœ… JOINED</h4><div class="room-data"><div><span>ID</span><b>${m.roomId||'Wait'}</b></div><div><span>PASS</span><b>${m.password||'Wait'}</b></div></div></div>`;
                        btnHTML=`<button class="btn-main btn-dis">JOINED</button>`;
                    }
                }else if(myRec.status==='rejected'){
                    btnHTML=`<button class="btn-main" style="background:var(--red)">REJECTED</button>`;
                }else{
                    checkPaymentStatus(m.id, myRec.utr);
                    btnHTML=`<button class="btn-main btn-dis" style="color:var(--waiting)">VERIFYING...</button>`;
                }
            }else{
                if(isStarted) btnHTML=`<button class="btn-main btn-dis">STARTED</button>`;
                else if(isFull) btnHTML=`<button class="btn-main btn-dis">FULL</button>`;
                else btnHTML=`<button class="btn-main btn-join" onclick="initPayment('${m.id}',${m.entry})">JOIN â‚¹${m.entry}</button>`;
            }
            const html=`<div class="card"><div class="m-tag">${m.map}</div><div class="card-body"><div class="item"><i class="fas fa-crosshairs"></i><div><span>Mode</span><b>${m.type}</b></div></div><div

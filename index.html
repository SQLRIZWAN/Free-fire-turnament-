<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>SQL TOURNAMENT PRO - WALLET EDITION</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #00ff88; --gold: #ffd700; --bg: #050505; --card: #121212; --border: #222; --red: #ff4444; --muted:#888; --waiting:#ffae00; --glass: rgba(20,20,20,0.95); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: 'Poppins', sans-serif; overflow-x: hidden; }
        .allow-select, .room-data b { user-select: text !important; cursor: text; }

        /* Header */
        header { background: #000; padding: 15px; border-bottom: 2px solid var(--gold); text-align: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 20px rgba(255, 215, 0, 0.1); }
        .header-title { color: var(--gold); font-weight: 800; font-size: 0.95rem; margin: 0; letter-spacing: 0.5px; text-transform: uppercase; }
        .header-sub { color: var(--accent); font-size: 0.7rem; display: block; margin-top: 2px; }
        .menu-btn { position: absolute; right: 20px; top: 18px; color: var(--gold); font-size: 1.4rem; cursor: pointer; }

        /* Tabs */
        .tabs { display: flex; gap:8px; margin: 12px; background: #111; border-radius: 12px; border:1px solid var(--border); padding:6px; align-items:center; }
        .tab { flex: 1; padding: 10px; border: none; background: none; color: var(--muted); font-weight: 700; font-size: 0.8rem; cursor: pointer; transition: 0.2s; text-align:center; border-radius:10px; }
        .tab.active { background: var(--accent); color: #000; box-shadow: 0 0 10px var(--accent); }
        .small-btn { padding:6px 12px; font-size:0.75rem; border-radius:8px; border:1px solid #333; background:#0b0b0b; color:#ccc; cursor:pointer; font-weight:600; }
        
        /* Grid */
        #app-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 15px; padding: 10px 12px 90px 12px; }

        /* Match Card */
        .card { background: var(--card); border-radius: 18px; border:1px solid var(--border); overflow: hidden; position: relative; transition: transform 0.2s; }
        .m-tag { position: absolute; top: 12px; right: 15px; font-size: 0.65rem; background:#000; padding:4px 8px; border:1px solid var(--accent); border-radius:6px; color:var(--accent); font-weight:800; }
        .card-body { padding: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items:center; }
        .item { display:flex; gap:10px; align-items:center; }
        .item i { color: var(--gold); font-size:1rem; width:20px; text-align:center; }
        .item div span { display:block; font-size:0.6rem; color:var(--muted); text-transform:uppercase; }
        .item div b { font-size:0.95rem; color:#fff; }
        .win-green { color: var(--accent); text-shadow: 0 0 5px rgba(0,255,136,0.5); }
        .entry-gold { color: var(--gold); }

        .timer-box { background:#080808; padding:10px; text-align:center; border-top:1px solid #222; border-bottom:1px solid #222; }
        .countdown { font-family: monospace; font-size:1.2rem; color:var(--waiting); font-weight:900; letter-spacing:1px; }
        .card-footer { padding:14px; }
        .slots { display:flex; justify-content:space-between; font-size:0.75rem; margin-bottom:8px; font-weight:800; }
        .bar { height:8px; background:#222; border-radius:12px; overflow:hidden; margin-bottom:12px; }
        .fill { height:100%; background:linear-gradient(90deg, var(--accent), #008f4c); transition:1s ease; }

        .btn-main { width:100%; padding:14px; border-radius:12px; border:none; font-weight:900; font-size:1rem; cursor:pointer; transition:0.2s; text-transform:uppercase; letter-spacing:0.5px; }
        .btn-join { background:var(--accent); color:#000; box-shadow:0 0 15px rgba(0,255,136,0.2); }
        .btn-dis { background:#222; color:var(--muted); cursor:not-allowed; border:1px solid #333; }

        /* Room Box */
        .room-box { background: rgba(0, 255, 136, 0.05); border:1px dashed var(--accent); padding:15px; border-radius:12px; text-align:center; animation:fadeIn .5s; margin-bottom:10px; }
        .room-data { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
        .room-data div { background:#000; padding:10px; border-radius:8px; border:1px solid #333; }
        .room-data div b { font-size:1rem; color:#fff; font-family:monospace; user-select: text !important; }

        /* Side Menu */
        #side-menu { position: fixed; top:0; right:-100%; width:300px; height:100%; background:#0a0a0a; z-index:5000; transition:0.4s cubic-bezier(0.4, 0, 0.2, 1); border-left:1px solid var(--gold); display:flex; flex-direction:column; }
        #side-menu.active { right:0; box-shadow: -10px 0 50px rgba(0,0,0,0.8); }
        .menu-header { padding:20px; border-bottom:1px solid #222; display:flex; align-items:center; gap:15px; background:#000; }
        .menu-dp { width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid var(--gold); }
        .menu-items { padding:10px; overflow-y:auto; flex:1; }
        .menu-link { display:flex; align-items:center; gap:15px; padding:16px; color:#ddd; text-decoration:none; border-bottom:1px solid #1a1a1a; font-weight:600; font-size:0.95rem; transition:0.2s; }
        .menu-footer { padding:20px; border-top:1px solid #222; text-align:center; background:#000; }
        .close-menu { position:absolute; top:15px; right:15px; color:var(--red); font-size:1.8rem; cursor:pointer; }

        /* Modals */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 6000; display:none; align-items:center; justify-content:center; padding:15px; backdrop-filter: blur(5px); }
        .modal-ui { background:#111; width:100%; max-width:480px; padding:25px; border-radius:20px; border:1px solid var(--gold); color:#fff; position:relative; box-shadow: 0 0 30px rgba(255,215,0,0.15); }
        .pay-opt { display:flex; align-items:center; gap:15px; padding:12px; background:#1a1a1a; border-radius:12px; text-decoration:none; color:#fff; border:1px solid #333; font-weight:600; margin-bottom:10px; }
        input, textarea { width:100%; background:#050505; border:1px solid #333; color:#fff; padding:12px; border-radius:10px; outline:none; margin-bottom:10px; }

        /* Wallet & Stats */
        .stats-box { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:20px; }
        .stat-item { background:#0b0b0b; padding:10px 5px; border-radius:10px; border:1px solid #222; text-align:center; }
        .stat-lbl { font-size:0.6rem; color:#888; text-transform:uppercase; display:block; margin-bottom:4px; font-weight:700; }
        .stat-val { font-size:1rem; font-weight:800; }
        .st-gold { color:var(--gold); font-size:1.1rem; }
        .st-red { color:var(--red); }
        .st-green { color:var(--accent); }

        /* Wallet Actions */
        .wallet-actions { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px; }
        .w-btn { border:none; padding:12px; border-radius:10px; font-weight:800; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; }
        .w-add { background:var(--accent); color:#000; }
        .w-with { background:#222; color:var(--red); border:1px solid var(--red); }
        
        .fund-chip { background:#1a1a1a; border:1px solid #333; color:#fff; padding:8px 15px; border-radius:20px; cursor:pointer; font-size:0.9rem; }
        .fund-chip:hover { border-color:var(--gold); background:#222; }

        /* Profile */
        .profile-head { background: linear-gradient(180deg, #1a1a1a, #050505); padding:20px; border-radius:16px; text-align:center; border:1px solid #333; position:relative; margin-bottom:20px; }
        .p-img-cont { position:relative; width:80px; height:80px; margin:0 auto 10px; }
        .p-img { width:100%; height:100%; border-radius:50%; object-fit:cover; border:2px solid var(--accent); }
        .p-edit { position:absolute; bottom:0; right:0; background:var(--gold); color:#000; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.8rem; cursor:pointer; border:2px solid #000; }

        /* History & Results */
        .result-card { background:#121212; padding:0; border-radius:16px; border:1px solid #222; margin-bottom:15px; overflow:hidden; }
        .r-head { padding:12px; background:#080808; border-bottom:1px solid #222; display:flex; justify-content:space-between; align-items:center; }
        .r-body { padding:15px; }
        .winner-box { background: linear-gradient(45deg, #ffd70010, transparent); border-left:3px solid var(--gold); padding:10px; margin-bottom:10px; }
        
        /* Comments Overlay */
        #comment-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 7000; display: none; flex-direction: column; }
        .cp-header { padding:15px; border-bottom:1px solid #222; display:flex; align-items:center; gap:15px; background:#080808; }
        .cp-body { flex:1; overflow-y:auto; padding:15px; padding-bottom:80px; }
        .cp-footer { position: absolute; bottom: 0; left: 0; width: 100%; background: #111; padding: 10px; border-top: 1px solid #333; display: flex; gap: 10px; }
        .cp-item { margin-bottom:15px; display:flex; gap:10px; }
        .cp-dp { width:35px; height:35px; border-radius:50%; background:#222; object-fit:cover; }
        .cp-box { background:#1a1a1a; padding:8px 12px; border-radius:12px; max-width:85%; }
        
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:none} }
    </style>
</head>
<body>

    <header>
        <p class="header-title">FREE FIRE DAILY TOURNAMENT</p>
        <span class="header-sub">JOIN PLAY &amp; WIN REAL MONEY ðŸ’°</span>
        <div class="menu-btn" onclick="toggleMenu(true)"><i class="fas fa-bars-staggered"></i></div>
    </header>

    <div class="tabs">
        <button class="tab active" id="tab-live" onclick="switchTab('live')">LIVE MATCHES</button>
        <button class="tab" id="tab-my" onclick="switchTab('my')">MY HISTORY</button>
        <button class="tab" id="tab-result" onclick="switchTab('result')">RESULTS</button>
    </div>

    <div id="side-menu">
        <div class="close-menu" onclick="toggleMenu(false)">&times;</div>
        <div class="menu-header">
            <img id="menu-user-dp" src="https://img.icons8.com/color/96/user-male-circle.png" class="menu-dp">
            <div>
                <div id="menu-user-name" style="font-weight:bold; color:#fff;">Guest User</div>
                <div style="font-size:0.7rem; color:var(--accent);">Welcome Gamer</div>
            </div>
        </div>
        <div class="menu-items">
            <a href="#" class="menu-link" onclick="location.reload(); toggleMenu(false)"><i class="fas fa-home"></i> Home</a>
            <a href="https://chat.whatsapp.com/JR7wAllMf4SAyILFHDQClQ" target="_blank" class="menu-link"><i class="fab fa-whatsapp"></i> WhatsApp Group</a>
            <a href="#" class="menu-link" onclick="showRules(); toggleMenu(false)"><i class="fas fa-shield-halved"></i> Rules & Policy</a>
            <a href="#" id="menu-auth-btn" class="menu-link" onclick="openAuthModal('login'); toggleMenu(false)"><i class="fas fa-sign-in-alt"></i> Login / Register</a>
        </div>
        <div class="menu-footer">
            <button id="menu-logout-btn" onclick="confirmLogout()" class="btn-main" style="background:#222; color:var(--red); padding:10px;">LOGOUT</button>
        </div>
    </div>

    <main id="app-content"></main>

    <div id="add-fund-modal" class="modal">
        <div class="modal-ui">
            <h3 style="color:var(--gold); text-align:center;">ADD MONEY TO WALLET</h3>
            <input type="number" id="fund-amount" placeholder="Enter Amount (e.g. 100)" style="text-align:center; font-size:1.5rem; color:var(--accent); font-weight:bold;">
            
            <div style="display:flex; gap:10px; justify-content:center; margin-bottom:15px;">
                <div class="fund-chip" onclick="setFund(50)">â‚¹50</div>
                <div class="fund-chip" onclick="setFund(100)">â‚¹100</div>
                <div class="fund-chip" onclick="setFund(200)">â‚¹200</div>
                <div class="fund-chip" onclick="setFund(500)">â‚¹500</div>
            </div>

            <div style="margin-bottom:15px;">
                <a id="fund-g" href="#" class="pay-opt"><img src="https://img.icons8.com/color/48/google-pay.png"> Google Pay</a>
                <a id="fund-p" href="#" class="pay-opt"><img src="https://img.icons8.com/color/48/phone-pe.png"> PhonePe</a>
                <a id="fund-y" href="#" class="pay-opt"><img src="https://img.icons8.com/color/48/paytm.png"> Paytm</a>
            </div>

            <input type="text" id="fund-utr" class="allow-select" placeholder="Enter 12 Digit UTR / Ref No" style="text-align:center; font-weight:bold;">
            <input type="file" id="fund-ss" accept="image/*">
            
            <div style="margin-top:15px; display:flex; gap:10px;">
                <button class="btn-main btn-join" id="fund-submit-btn" onclick="submitAddFund()">SUBMIT REQUEST</button>
                <button onclick="document.getElementById('add-fund-modal').style.display='none'" class="btn-main" style="background:#222;">CANCEL</button>
            </div>
        </div>
    </div>

    <div id="withdraw-modal" class="modal">
        <div class="modal-ui">
            <h3 style="color:var(--red); text-align:center;">WITHDRAW MONEY</h3>
            <p style="text-align:center; color:#888; font-size:0.8rem;">Minimum: â‚¹50 | Maximum: â‚¹10,000</p>
            <div style="text-align:center; margin-bottom:10px; color:var(--gold);">Available: â‚¹<span id="withdraw-avail-bal">0</span></div>

            <input type="number" id="with-amount" placeholder="Amount to Withdraw" style="text-align:center; font-size:1.2rem;">
            <input type="text" id="with-upi" placeholder="Your UPI ID (e.g. 90xx@ybl)" style="text-align:center;">
            
            <div style="margin-top:15px; display:flex; gap:10px;">
                <button class="btn-main" style="background:var(--red); color:#fff;" id="with-submit-btn" onclick="submitWithdraw()">CONFIRM WITHDRAW</button>
                <button onclick="document.getElementById('withdraw-modal').style.display='none'" class="btn-main" style="background:#222;">CANCEL</button>
            </div>
        </div>
    </div>

    <div id="pay-modal" class="modal">
        <div class="modal-ui">
            <h3 style="color:var(--gold); text-align:center; margin-bottom:5px;">JOIN MATCH</h3>
            <h1 id="modal-amt" style="color:var(--accent); text-align:center; margin:0 0 15px 0;">â‚¹0</h1>

            <div id="wallet-pay-sec" style="background:#1a1a1a; padding:15px; border-radius:12px; border:1px solid var(--accent); margin-bottom:15px; text-align:center;">
                <div style="color:#aaa; font-size:0.8rem;">YOUR WALLET BALANCE</div>
                <div style="font-size:1.2rem; font-weight:bold; color:var(--gold); margin-bottom:8px;">â‚¹<span id="pay-wallet-bal">0</span></div>
                <button id="btn-pay-wallet" class="btn-main btn-join" onclick="joinWithWallet()">PAY FROM WALLET (INSTANT)</button>
                <div id="wallet-error" style="color:var(--red); font-size:0.7rem; margin-top:5px; display:none;">Insufficient Balance. Add Money first.</div>
            </div>

            <div style="text-align:center; color:#666; font-size:0.8rem; margin:10px 0;">--- OR PAY VIA UPI ---</div>

            <div style="margin-bottom:15px;">
                <a id="g-link" href="#" class="pay-opt"><img src="https://img.icons8.com/color/48/google-pay.png"> Google Pay</a>
                <a id="p-link" href="#" class="pay-opt"><img src="https://img.icons8.com/color/48/phone-pe.png"> PhonePe</a>
                <a id="y-link" href="#" class="pay-opt"><img src="https://img.icons8.com/color/48/paytm.png"> Paytm</a>
            </div>

            <input type="text" id="utr-input" class="allow-select" placeholder="Enter 12 Digit UTR" style="text-align:center;">
            <input type="file" id="utr-ss" accept="image/*">

            <div style="margin-top:15px; display:flex; gap:10px;">
                <button class="btn-main" style="background:#333; color:#fff;" id="submit-pay-btn" onclick="processPayment()">SUBMIT UTR</button>
                <button onclick="closeModal()" class="btn-main" style="background:#222;">CANCEL</button>
            </div>
        </div>
    </div>

    <div id="auth-modal" class="modal">
        <div class="modal-ui">
            <h2 id="auth-title" style="color:var(--gold); text-align:center;">LOGIN</h2>
            <div id="auth-forms"></div>
            <button id="auth-submit-btn" class="btn-main btn-join" style="margin-top:15px;" onclick="submitAuth()">LOGIN</button>
            <p id="auth-toggle-msg" style="text-align:center; margin-top:15px; color:#888; cursor:pointer;" onclick="toggleAuthMode()">New user? Register</p>
            <button onclick="document.getElementById('auth-modal').style.display='none'" style="position:absolute; top:15px; right:15px; background:none; border:none; color:#555; font-size:1.5rem;">&times;</button>
        </div>
    </div>
    
    <div id="comment-page">
        <div class="cp-header"><i class="fas fa-arrow-left" onclick="closeCommentPage()" style="color:#fff;"></i> <b>Comments</b></div>
        <div class="cp-body" id="cp-list"></div>
        <div class="cp-footer">
            <input type="text" id="cp-input" placeholder="Write comment..." style="margin:0; border-radius:20px;">
            <button onclick="postRealComment()" style="background:var(--accent); border:none; padding:10px; border-radius:50%;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <input type="file" id="hidden-dp-input" accept="image/*" style="display:none;" onchange="handleProfileUpdate(this)">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, query, where, orderBy, limit, getDocs, doc, setDoc, getDoc, updateDoc, increment, arrayUnion } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBvObxADcAior6R_or9O6UmWsFT8do1GkI",
            authDomain: "sqladmin-ff04d.firebaseapp.com",
            projectId: "sqladmin-ff04d",
            storageBucket: "sqladmin-ff04d.firebasestorage.app",
            messagingSenderId: "539086978850",
            appId: "1:539086978850:web:261e6a0cf3c9a2aa29ef7b"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let activeTab = 'live';
        let currentAuthMode = 'login';
        let activeMatchId = null;
        let activeEntryFee = 0;
        let currentResultIdForComments = null;

        async function uploadToCloudinary(file){
            if(!file) return "";
            const fd = new FormData(); fd.append("file", file); fd.append("upload_preset", "sql_admin"); fd.append("folder", "sql_users");
            try { const res = await fetch("https://api.cloudinary.com/v1_1/debp1kjtm/image/upload", { method:"POST", body: fd }); const data = await res.json(); return data.secure_url || ""; } catch(e) { return ""; }
        }

        function loadSession(){ try { return JSON.parse(localStorage.getItem('sql_session') || "null"); } catch { return null; } }
        function saveSession(data){ localStorage.setItem('sql_session', JSON.stringify(data)); updateMenuUI(); }
        
        // --- AUTH ---
        window.openAuthModal = (mode) => { document.getElementById('auth-modal').style.display='flex'; currentAuthMode=mode; renderAuthForm(); };
        window.toggleAuthMode = () => { currentAuthMode = currentAuthMode==='login'?'register':'login'; renderAuthForm(); };
        function renderAuthForm(){
            const ui = document.getElementById('auth-forms');
            const title = document.getElementById('auth-title');
            const btn = document.getElementById('auth-submit-btn');
            if(currentAuthMode==='login'){
                title.innerText="LOGIN"; btn.innerText="LOGIN NOW";
                ui.innerHTML=`<input id="login_phone" type="number" placeholder="Phone"><input id="login_pass" type="password" placeholder="Password">`;
            } else {
                title.innerText="REGISTER"; btn.innerText="CREATE ACCOUNT";
                ui.innerHTML=`<input id="reg_name" placeholder="Full Name"><input id="reg_phone" type="number" placeholder="Phone"><input id="reg_gaming" placeholder="Gaming Name"><input id="reg_pass" type="password" placeholder="Password">`;
            }
        }
        window.submitAuth = async () => {
            const btn=document.getElementById('auth-submit-btn'); btn.disabled=true; btn.innerText="Processing...";
            try {
                if(currentAuthMode==='register'){
                    const name=document.getElementById('reg_name').value.trim(), phone=document.getElementById('reg_phone').value.trim(), gaming=document.getElementById('reg_gaming').value.trim(), pass=document.getElementById('reg_pass').value.trim();
                    if(!name||!phone||!pass) throw "Fill details";
                    const snap = await getDoc(doc(db,"users",phone)); if(snap.exists()) throw "Already registered";
                    const data = { name, phone, gamingName:gaming, password:pass, balance:0, totalProfit:0, totalLoss:0, dpUrl:"" };
                    await setDoc(doc(db,"users",phone), data); saveSession(data);
                } else {
                    const phone=document.getElementById('login_phone').value.trim(), pass=document.getElementById('login_pass').value.trim();
                    const snap = await getDoc(doc(db,"users",phone)); if(!snap.exists()) throw "User not found";
                    const data=snap.data(); if(data.password!==pass) throw "Wrong Pass";
                    saveSession(data);
                }
                document.getElementById('auth-modal').style.display='none'; renderUI();
            } catch(e){ alert(e); } finally { btn.disabled=false; }
        };
        window.confirmLogout = () => { if(confirm("Logout?")){ localStorage.removeItem('sql_session'); location.reload(); } };
        function updateMenuUI(){
            const s=loadSession(); const dp=document.getElementById('menu-user-dp');
            if(s){ dp.src=s.dpUrl||"https://img.icons8.com/color/96/user-male-circle.png"; document.getElementById('menu-user-name').innerText=s.name; document.getElementById('menu-auth-btn').style.display='none'; }
        }

        // --- MAIN UI ---
        window.switchTab = (t) => { activeTab=t; document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active')); document.getElementById(`tab-${t}`).classList.add('active'); renderUI(); };
        window.toggleMenu = (s) => document.getElementById('side-menu').classList.toggle('active', s);
        window.showRules = () => alert("1. No Hacks\n2. Wallet Join is Instant\n3. Withdraw within 24hrs");

        function renderUI(){
            const c=document.getElementById('app-content'); c.innerHTML="";
            if(activeTab==='live') renderLive(c);
            else if(activeTab==='my') renderHistory(c);
            else if(activeTab==='result') renderResults(c);
        }

        // 1. LIVE MATCHES
        function renderLive(c){
            onSnapshot(collection(db,"matches"), snap=>{
                if(activeTab!=='live') return;
                c.innerHTML=""; const matches=[]; snap.forEach(d=>matches.push({id:d.id, ...d.data()}));
                matches.sort((a,b)=>a.startTime-b.startTime);
                
                matches.forEach(m=>{
                    const now=Date.now(), start=m.startTime||0, isStarted=now>start;
                    const myRec = JSON.parse(localStorage.getItem(`pay_${m.id}`)||"null");
                    let btnHTML = ""; let roomHTML="";

                    // Check if joined via Wallet or Manual approved
                    const isJoined = (myRec && myRec.status==='approved') || (m.approvedUtrs && myRec && m.approvedUtrs.includes(myRec.utr));

                    if(isJoined){
                        if(isStarted) roomHTML=`<div class="room-box"><h4>MATCH STARTED</h4><div class="room-data"><div><span>ID</span><b>${m.roomId}</b></div><div><span>PASS</span><b>${m.password}</b></div></div></div>`;
                        else roomHTML=`<div class="room-box"><h4>JOINED âœ…</h4><div class="room-data"><div><span>ID</span><b>${m.roomId||'Wait'}</b></div><div><span>PASS</span><b>${m.password||'Wait'}</b></div></div></div>`;
                        btnHTML=`<button class="btn-main btn-dis">JOINED</button>`;
                    } else if(myRec && myRec.status==='pending'){
                        checkStatus(m.id, myRec.utr);
                        btnHTML=`<button class="btn-main btn-dis">VERIFYING...</button>`;
                    } else {
                        if(isStarted) btnHTML=`<button class="btn-main btn-dis">STARTED</button>`;
                        else btnHTML=`<button class="btn-main btn-join" onclick="initPayment('${m.id}', ${m.entry})">JOIN â‚¹${m.entry}</button>`;
                    }

                    c.innerHTML += `
                    <div class="card">
                        <div class="m-tag">${m.map}</div>
                        <div class="card-body">
                            <div class="item"><i class="fas fa-trophy"></i><div><span>Win</span><b class="win-green">â‚¹${m.win}</b></div></div>
                            <div class="item"><i class="fas fa-ticket-alt"></i><div><span>Entry</span><b class="entry-gold">â‚¹${m.entry}</b></div></div>
                            <div class="item"><i class="fas fa-clock"></i><div><span>Time</span><b>${new Date(start).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</b></div></div>
                        </div>
                        <div class="timer-box"><div class="countdown" data-time="${start}">00:00:00</div></div>
                        <div class="card-footer">
                            <div class="slots"><span>Filled: ${m.joined||0}/${m.total||48}</span></div>
                            <div class="bar"><div class="fill" style="width:${Math.min(100,((m.joined||0)/(m.total||48))*100)}%"></div></div>
                            ${roomHTML} ${btnHTML}
                        </div>
                    </div>`;
                });
            });
        }

        // 2. HISTORY & WALLET (DEEP LOGIC)
        async function renderHistory(c){
            const s=loadSession();
            if(!s) { c.innerHTML=`<div style="text-align:center;padding:50px;">Please Login</div>`; return; }
            
            // Fetch Fresh Data for Wallet
            let user = s;
            try { const snap = await getDoc(doc(db,"users",s.phone)); if(snap.exists()){ user=snap.data(); saveSession(user); } } catch(e){}

            c.innerHTML = `
            <div class="profile-head">
                <div class="p-img-cont"><img src="${user.dpUrl||'https://img.icons8.com/color/96/user-male-circle.png'}" class="p-img"><div class="p-edit" onclick="document.getElementById('hidden-dp-input').click()"><i class="fas fa-pencil"></i></div></div>
                <h3>${user.name}</h3>
                <div style="color:var(--accent);">${user.phone}</div>
                
                <div class="stats-box" style="margin-top:15px;">
                    <div class="stat-item"><span class="stat-lbl">Wallet</span><div class="stat-val st-gold">â‚¹${user.balance||0}</div></div>
                    <div class="stat-item"><span class="stat-lbl">Invest</span><div class="stat-val st-red">â‚¹${user.totalLoss||0}</div></div>
                    <div class="stat-item"><span class="stat-lbl">Won</span><div class="stat-val st-green">â‚¹${user.totalProfit||0}</div></div>
                </div>

                <div class="wallet-actions">
                    <button class="w-btn w-add" onclick="document.getElementById('add-fund-modal').style.display='flex'"><i class="fas fa-plus-circle"></i> ADD MONEY</button>
                    <button class="w-btn w-with" onclick="openWithdrawModal()"><i class="fas fa-university"></i> WITHDRAW</button>
                </div>
            </div>
            <h4 style="margin:10px 0; color:#888;">Transaction History</h4>
            <div id="hist-list">Loading...</div>`;

            // Load Transactions (Wallet & Matches)
            const q = query(collection(db,"payments"), where("payer.phone","==",s.phone), orderBy("timestamp","desc"), limit(20));
            const snap = await getDocs(q);
            const list = document.getElementById('hist-list'); list.innerHTML="";
            
            if(snap.empty) list.innerHTML="<div style='text-align:center;color:#444'>No transactions</div>";

            snap.forEach(d=>{
                const p = d.data();
                let color = p.status==='approved'?'var(--accent)':'var(--waiting)';
                let msg = p.matchId ? `Match Join #${p.matchId.slice(-4)}` : (p.type==='deposit'?'Wallet Deposit':'Wallet Withdraw');
                
                list.innerHTML += `
                <div class="result-card" style="padding:15px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <b style="color:#fff;">${msg}</b>
                        <div style="font-size:0.7rem; color:#666;">${new Date(p.timestamp).toLocaleString()}</div>
                        <div style="font-size:0.7rem; color:${color}; text-transform:uppercase;">${p.status}</div>
                    </div>
                    <div style="font-weight:bold; font-size:1.1rem; color:${p.type==='deposit'?'var(--accent)':'#fff'}">${p.type==='deposit'?'+':'-'} ${p.amount || 0}</div>
                </div>`;
            });
        }

        // --- WALLET FUNCTIONS ---
        window.setFund = (n) => document.getElementById('fund-amount').value = n;
        window.submitAddFund = async () => {
            const amt = parseInt(document.getElementById('fund-amount').value);
            const utr = document.getElementById('fund-utr').value;
            const file = document.getElementById('fund-ss').files[0];
            const btn = document.getElementById('fund-submit-btn');

            if(!amt || amt<10 || !utr || !file) return alert("Invalid details");
            btn.disabled=true; btn.innerText="Uploading...";
            
            const s = loadSession();
            const ssUrl = await uploadToCloudinary(file);
            
            // Add Request to Payments (Type: Deposit)
            await addDoc(collection(db,"payments"), {
                type: 'deposit', amount: amt, utr: utr, ss: ssUrl,
                payer: { name: s.name, phone: s.phone },
                status: 'pending', timestamp: Date.now()
            });

            alert("Request Submitted! Balance will update after Admin Approval.");
            document.getElementById('add-fund-modal').style.display='none';
            btn.disabled=false; btn.innerText="SUBMIT REQUEST";
        };

        window.openWithdrawModal = async () => {
            const s = loadSession();
            const snap = await getDoc(doc(db,"users",s.phone));
            const bal = snap.exists() ? snap.data().balance : 0;
            document.getElementById('withdraw-avail-bal').innerText = bal;
            document.getElementById('withdraw-modal').style.display='flex';
        };

        window.submitWithdraw = async () => {
            const amt = parseInt(document.getElementById('with-amount').value);
            const upi = document.getElementById('with-upi').value;
            const s = loadSession();
            
            const snap = await getDoc(doc(db,"users",s.phone));
            const bal = snap.data().balance || 0;

            if(amt < 50 || amt > 10000) return alert("Limit: â‚¹50 - â‚¹10,000");
            if(amt > bal) return alert("Insufficient Balance");
            if(!upi) return alert("Enter UPI ID");

            if(!confirm(`Withdraw â‚¹${amt}?`)) return;

            // DEDUCT BALANCE INSTANTLY (Secure)
            await updateDoc(doc(db,"users",s.phone), {
                balance: increment(-amt),
                totalWithdraw: increment(amt)
            });

            // Add Record
            await addDoc(collection(db,"payments"), {
                type: 'withdraw', amount: amt, utr: 'WAITING',
                payer: { name: s.name, phone: s.phone, upi: upi },
                status: 'pending', timestamp: Date.now()
            });

            alert("Withdrawal Request Sent! Amount deducted.");
            document.getElementById('withdraw-modal').style.display='none';
            renderUI();
        };

        // --- PAYMENT & JOINING LOGIC ---
        window.initPayment = async (mid, entry) => {
            const s=loadSession(); if(!s) return openAuthModal('login');
            activeMatchId=mid; activeEntryFee=entry;
            
            // Update Wallet UI in Modal
            const snap = await getDoc(doc(db,"users",s.phone));
            const bal = snap.exists() ? snap.data().balance : 0;
            document.getElementById('pay-wallet-bal').innerText = bal;
            
            const btnW = document.getElementById('btn-pay-wallet');
            const err = document.getElementById('wallet-error');
            
            if(bal >= entry){
                btnW.disabled = false; btnW.style.opacity = 1;
                err.style.display = 'none';
            } else {
                btnW.disabled = true; btnW.style.opacity = 0.5;
                err.style.display = 'block';
            }

            document.getElementById('modal-amt').innerText="â‚¹"+entry;
            document.getElementById('pay-modal').style.display='flex';

            const upi = `upi://pay?pa=rizwanhasan90122778623@ybl&am=${entry}&tn=Match_${mid}`;
            document.getElementById('g-link').href=upi; document.getElementById('p-link').href=upi; document.getElementById('y-link').href=upi;
        };
        window.closeModal = () => document.getElementById('pay-modal').style.display='none';

        // 1. JOIN VIA WALLET (INSTANT)
        window.joinWithWallet = async () => {
            const s = loadSession();
            if(!confirm(`Pay â‚¹${activeEntryFee} from Wallet?`)) return;

            const btn = document.getElementById('btn-pay-wallet');
            btn.innerText = "Processing...";

            try {
                // Deduct Balance
                await updateDoc(doc(db,"users",s.phone), {
                    balance: increment(-activeEntryFee),
                    totalLoss: increment(activeEntryFee) // Initially count as invest/loss
                });

                // Generate Wallet UTR
                const wUtr = "WAL" + Date.now();

                // Add Payment Record (Approved)
                await addDoc(collection(db,"payments"), {
                    matchId: activeMatchId, utr: wUtr, status: 'approved', method: 'wallet',
                    amount: activeEntryFee, payer: { name: s.name, phone: s.phone },
                    timestamp: Date.now()
                });

                // Update Match Joined
                await updateDoc(doc(db,"matches",activeMatchId), {
                    joined: increment(1),
                    approvedUtrs: arrayUnion(wUtr)
                });

                localStorage.setItem(`pay_${activeMatchId}`, JSON.stringify({status:'approved', utr:wUtr}));
                alert("Joined Successfully!");
                closeModal();
                renderUI();

            } catch(e) { alert("Error: " + e); }
        };

        // 2. JOIN VIA MANUAL UPLOAD
        window.processPayment = async () => {
            const utr = document.getElementById('utr-input').value;
            const file = document.getElementById('utr-ss').files[0];
            if(!utr || !file) return alert("Provide UTR & Screenshot");

            const btn = document.getElementById('submit-pay-btn'); btn.innerText="Uploading...";
            const s = loadSession();
            const url = await uploadToCloudinary(file);
            
            const pData = { matchId:activeMatchId, utr, ss:url, amount:activeEntryFee, payer:{name:s.name, phone:s.phone}, status:'pending', timestamp:Date.now() };
            await addDoc(collection(db,"payments"), pData);
            localStorage.setItem(`pay_${activeMatchId}`, JSON.stringify(pData));
            
            alert("Submitted for Verification"); closeModal();
            btn.innerText="SUBMIT UTR"; renderUI();
        };

        // 3. RESULTS (With Admin Auto-Scan Logic Placeholder)
        // Note: The actual "Deep Scan" happens when Admin UPLOADS result. 
        // Since this is client code, we render results. 
        // However, I have added the logic below (commented) on how the system updates wallets 
        // based on your Point 1, effectively treating the Firestore as the Source of Truth.
        
        async function renderResults(c){
            const q = query(collection(db,"results"), orderBy("timestamp","desc"));
            const snap = await getDocs(q);
            c.innerHTML = "";
            snap.forEach(d=>{
                const r = d.data();
                c.innerHTML += `
                <div class="result-card">
                    <div class="r-head"><span>${r.title}</span><span style="font-size:0.7rem; color:#666">${new Date(r.timestamp).toLocaleDateString()}</span></div>
                    ${r.image ? `<img src="${r.image}" style="width:100%">` : ''}
                    <div class="r-body">
                        <div class="winner-box">WINNER: <b style="color:var(--accent)">${r.winnerName}</b></div>
                        <div style="display:flex; gap:10px;">
                            <button onclick="openComments('${d.id}')" class="small-btn"><i class="fas fa-comment"></i> Comments</button>
                        </div>
                    </div>
                </div>`;
            });
        }

        // --- COMMENTS ---
        window.openComments = (rid) => { 
            currentResultIdForComments = rid; 
            document.getElementById('comment-page').style.display='flex';
            onSnapshot(query(collection(db,"result_comments"), where("rid","==",rid), orderBy("time")), snap=>{
                const l = document.getElementById('cp-list'); l.innerHTML="";
                snap.forEach(d=>{ 
                    const k=d.data(); 
                    l.innerHTML+=`<div class="cp-item"><img src="${k.dp}" class="cp-dp"><div class="cp-box"><b style="color:var(--gold)">${k.name}</b><br>${k.text}</div></div>`; 
                });
            });
        };
        window.closeCommentPage = () => document.getElementById('comment-page').style.display='none';
        window.postRealComment = async () => {
            const t = document.getElementById('cp-input').value; const s = loadSession();
            if(t && s){ await addDoc(collection(db,"result_comments"), { rid:currentResultIdForComments, name:s.name, dp:s.dpUrl, text:t, time:Date.now() }); document.getElementById('cp-input').value=""; }
        };

        // --- TIMER ---
        setInterval(()=>{ document.querySelectorAll('.countdown').forEach(e=>{ 
            const d=e.dataset.time-Date.now(); 
            e.innerText=d>0?`${Math.floor(d/3600000)}h : ${Math.floor((d%3600000)/60000)}m`:"LIVE"; 
        })}, 1000);

        // --- DEEP LOGIC ADMIN FUNCTION (Concept) ---
        // This function would be called by the Admin Panel when Result is Declared.
        // I included it here so you can see the logic you asked for in Point 1.
        /*
        async function adminDeclareResult(matchId, winnerPhone, winAmount){
            // 1. Get All Players who paid & were approved
            const q = query(collection(db,"payments"), where("matchId","==",matchId), where("status","==","approved"));
            const snaps = await getDocs(q);
            
            snaps.forEach(async (docSnap) => {
                const payData = docSnap.data();
                const userPhone = payData.payer.phone;
                
                // 2. Logic: Winner gets Prize, Losers just keep their 'Total Loss' (already added on join)
                if(userPhone === winnerPhone){
                    await updateDoc(doc(db,"users",userPhone), {
                        balance: increment(winAmount),       // Add Prize
                        totalProfit: increment(winAmount),   // Record Profit
                        // Note: entry fee was already deducted/added to loss on join
                    });
                }
            });
        }
        */

        // Helper for manual verify
        function checkStatus(mid, utr){
            onSnapshot(query(collection(db,"payments"), where("utr","==",utr)), s=>{
                s.forEach(d=>{ 
                    if(d.data().status==='approved') { localStorage.setItem(`pay_${mid}`, JSON.stringify({status:'approved', utr})); renderUI(); }
                });
            });
        }

        updateMenuUI(); renderUI();
    </script>
</body>
          </html>

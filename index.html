<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>SQL TOURNAMENT PRO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #00ff88; --gold: #ffd700; --bg: #050505; --card: #121212; --border: #222; --red: #ff4444; --muted:#666; --waiting:#ffae00; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: 'Poppins', sans-serif; overflow-x: hidden; }
        .allow-select { user-select: text !important; }

        /* Header */
        header { background: #000; padding: 15px; border-bottom: 2px solid var(--gold); text-align: center; position: sticky; top: 0; z-index: 1000; }
        .header-title { color: var(--gold); font-weight: 800; font-size: 0.95rem; margin: 0; letter-spacing: 0.5px; text-transform: uppercase; }
        .header-sub { color: var(--accent); font-size: 0.7rem; display: block; margin-top: 2px; }
        .menu-btn { position: absolute; right: 20px; top: 18px; color: var(--gold); font-size: 1.4rem; cursor: pointer; }

        /* Tabs */
        .tabs { display: flex; gap:8px; margin: 12px; background: #111; border-radius: 12px; border:1px solid var(--border); padding:6px; align-items:center; }
        .tab { flex: 1; padding: 10px; border: none; background: none; color: var(--muted); font-weight: 700; font-size: 0.82rem; cursor: pointer; transition: 0.2s; text-align:center; border-radius:10px; }
        .tab.active { background: var(--accent); color: #000; }
        .small-btn { padding:8px 10px; font-size:0.75rem; border-radius:10px; border:1px solid #222; background:#0b0b0b; color:var(--muted); cursor:pointer; }

        /* Grid for match cards: 2 per row on wide screens, responsive */
        #app-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 12px; padding: 10px 12px 90px 12px; }

        /* Card */
        .card { background: var(--card); border-radius: 18px; border:1px solid var(--border); overflow: hidden; position: relative; }
        .m-tag { position: absolute; top: 12px; right: 15px; font-size: 0.65rem; background:#121212; padding:5px 9px; border-radius:8px; color:var(--accent); font-weight:800; }
        .card-body { padding: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items:center; }
        .item { display:flex; gap:10px; align-items:center; }
        .item i { color: var(--gold); font-size:0.95rem; width:18px; }
        .item div span { display:block; font-size:0.6rem; color:var(--muted); text-transform:uppercase; }
        .item div b { font-size:0.9rem; color:#fff; }
        .win-green { color: var(--accent); font-weight:900; }
        .entry-gold { color: var(--gold); font-weight:900; }

        .timer-box { background:#0c0c0c; padding:12px; text-align:center; border-top:1px solid #1a1a1a; border-bottom:1px solid #1a1a1a; }
        .timer-label { font-size:0.62rem; color:var(--muted); display:block; margin-bottom:4px; }
        .countdown { font-family: monospace; font-size:1.1rem; color:var(--gold); font-weight:900; }

        .card-footer { padding:14px; }
        .slots { display:flex; justify-content:space-between; font-size:0.75rem; margin-bottom:8px; font-weight:800; }
        .bar { height:10px; background:#222; border-radius:12px; overflow:hidden; margin-bottom:12px; }
        .fill { height:100%; background:var(--accent); transition:1s ease; }

        .btn-main { width:100%; padding:12px; border-radius:12px; border:none; font-weight:900; font-size:0.9rem; cursor:pointer; transition:0.2s; }
        .btn-join { background:var(--accent); color:#000; box-shadow:0 6px 18px rgba(0,255,136,0.12); }
        .btn-dis { background:#222; color:var(--muted); cursor:not-allowed; }

        /* Room box */
        .room-box { background:#001a0d; border:1px dashed var(--accent); padding:12px; border-radius:12px; text-align:center; animation:fadeIn .4s; }
        .room-box h4 { margin:0 0 8px; font-size:0.75rem; color:var(--accent); letter-spacing:1px; }
        .room-data { display:flex; justify-content:space-around; background:#000; padding:8px; border-radius:8px; }
        .room-data div span { display:block; font-size:0.55rem; color:var(--muted); }
        .room-data div b { font-size:0.85rem; color:#fff; }

        /* Modal & side menu */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 6000; display:none; align-items:center; justify-content:center; padding:20px; }
        .modal-ui { background:#111; width:100%; max-width:520px; padding:20px; border-radius:14px; border:1px solid var(--gold); color:#fff; }
        .pay-grid { display:grid; gap:10px; margin: 12px 0; }
        .pay-opt { display:flex; align-items:center; gap:12px; padding:10px; background:#1a1a1a; border-radius:10px; text-decoration:none; color:#fff; border:1px solid #333; font-weight:600; font-size:0.9rem; }
        .pay-opt img{ width:28px; }

        #side-menu { position: fixed; top:0; right:-100%; width:320px; height:100%; background:#000; z-index:5000; transition:0.4s; border-left:2px solid var(--gold); padding:22px; }
        #side-menu.active { right:0; }
        .menu-link { display:flex; align-items:center; gap:12px; padding:14px; color:#fff; text-decoration:none; border-bottom:1px solid #111; font-weight:700; }
        .close-menu { color:var(--red); font-size:2rem; text-align:right; cursor:pointer; margin-bottom:10px; }

        /* Result feed */
        .result-card { background:#0f0f0f; padding:12px; border-radius:12px; border:1px solid #222; margin-bottom:10px; }
        .result-meta { font-size:0.75rem; color:var(--muted); margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; }
        .result-img { width:100%; border-radius:8px; max-height:220px; object-fit:cover; display:block; margin-bottom:8px; }

        /* small */
        .muted { color:var(--muted); font-size:0.8rem; }
        .waiting { color:var(--waiting); font-weight:800; }

        @keyframes fadeIn { from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }

        /* Footer fixed label inside side-menu */
        #side-menu .footer-note { position:absolute; bottom:14px; left:22px; color:#777; font-size:0.78rem; }
        input, textarea { color: #fff; }
    </style>
</head>
<body>
    <header>
        <p class="header-title">FREE FIRE DAILY TOURNAMENT LIVE</p>
        <span class="header-sub">JOIN PLAY &amp; WIN REAL MONEY üí∞</span>
        <div class="menu-btn" onclick="toggleMenu(true)"><i class="fas fa-bars-staggered"></i></div>
    </header>

    <div class="tabs" role="tablist" aria-label="main tabs">
        <button class="tab active" id="tab-live" onclick="switchTab('live')">LIVE MATCHES</button>
        <button class="tab" id="tab-my" onclick="switchTab('my')">MY HISTORY</button>
        <button class="tab" id="tab-result" onclick="switchTab('result')">RESULTS</button>
        <button class="small-btn" onclick="switchTab('started')">START MATCH</button>
    </div>

    <div id="side-menu" aria-hidden="true">
        <div class="close-menu" onclick="toggleMenu(false)">&times;</div>
        <a href="#" class="menu-link" onclick="location.reload()"><i class="fas fa-home"></i> Home</a>
        <a href="https://chat.whatsapp.com/JR7wAllMf4SAyILFHDQClQ" class="menu-link"><i class="fab fa-whatsapp"></i> WhatsApp Group</a>
        <a href="#" class="menu-link" onclick="showPolicy()"><i class="fas fa-shield-halved"></i> Rules & Policy</a>
        <a href="#" class="menu-link" onclick="openAuthModal('login')"><i class="fas fa-sign-in-alt"></i> Login</a>
        <a href="#" class="menu-link" onclick="openAuthModal('register')"><i class="fas fa-user-plus"></i> Register</a>
        <a href="#" class="menu-link" onclick="openAdminStub()"><i class="fas fa-user-shield"></i> Admin (stub)</a>
        <div class="footer-note">¬© by SQL</div>
    </div>

    <main id="app-content" aria-live="polite"></main>

    <!-- Payment Modal -->
    <div id="pay-modal" class="modal" aria-hidden="true">
        <div class="modal-ui">
            <h3 style="color:var(--gold); margin:0;">CHECKOUT</h3>
            <h2 id="modal-amt" style="color:var(--accent); margin:10px 0;">‚Çπ0</h2>

            <div class="pay-grid">
                <a id="g-link" href="#" class="pay-opt"><img src="https://img.icons8.com/color/48/google-pay.png"> Google Pay / UPI</a>
                <a id="p-link" href="#" class="pay-opt"><img src="https://img.icons8.com/color/48/phone-pe.png"> PhonePe</a>
                <a id="y-link" href="#" class="pay-opt"><img src="https://img.icons8.com/color/48/paytm.png"> Paytm / UPI</a>
            </div>

            <input type="text" id="utr-input" class="allow-select" placeholder="Enter 12 Digit UTR" style="width:100%; padding:12px; background:#000; border:1px solid #333; color:var(--accent); border-radius:10px; text-align:center; font-weight:800; margin-bottom:10px;">
            <input type="file" id="utr-ss" accept="image/*" style="width:100%; margin-bottom:10px;">
            <hr style="border:0;border-top:1px solid #151515;margin:10px 0;">
            <div style="display:grid; gap:8px;">
                <input id="payer-name" placeholder="Your Name" style="padding:10px; background:#000; border:1px solid #222; border-radius:8px; color:#fff;">
                <input id="payer-phone" placeholder="Phone Number" style="padding:10px; background:#000; border:1px solid #222; border-radius:8px; color:#fff;">
                <input id="payer-gamingid" placeholder="Gaming ID (optional)" style="padding:10px; background:#000; border:1px solid #222; border-radius:8px; color:#fff;">
                <input type="file" id="payer-dp" accept="image/*" style="padding:6px; background:#000; border-radius:8px; color:#fff;">
            </div>

            <button class="btn-main btn-join" id="submit-btn" onclick="processPayment()">SUBMIT TRANSACTION</button>
            <button onclick="closeModal()" style="background:none; border:none; color:var(--red); margin-top:12px; font-weight:bold; cursor:pointer;">CLOSE</button>
        </div>
    </div>

    <!-- Auth Modal (Register / Login) -->
    <div id="auth-modal" class="modal" aria-hidden="true">
        <div class="modal-ui">
            <h3 id="auth-title" style="color:var(--gold); margin:0;">AUTH</h3>
            <div id="auth-body" style="margin-top:12px;">
                <!-- Filled dynamically -->
            </div>
            <div style="display:flex; gap:10px; margin-top:12px;">
                <button id="auth-action" class="btn-main btn-join" onclick="submitAuth()">SUBMIT</button>
                <button class="btn-main btn-dis" onclick="closeAuthModal()">CANCEL</button>
            </div>
        </div>
    </div>

    <!-- Comment Modal -->
    <div id="comment-modal" class="modal" aria-hidden="true">
        <div class="modal-ui">
            <h3 style="color:var(--gold); margin:0;">Post Comment</h3>
            <div style="margin-top:12px;">
                <textarea id="comment-text" placeholder="Write a comment..." style="width:100%; min-height:80px; background:#000; border:1px solid #222; color:#fff; padding:8px; border-radius:8px;"></textarea>
                <div style="display:flex; gap:8px; margin-top:10px;">
                    <button class="btn-main btn-join" onclick="submitComment()">POST</button>
                    <button class="btn-main btn-dis" onclick="closeComment()">CANCEL</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getFirestore, collection, onSnapshot, addDoc, query, where,
            orderBy, limit, getDocs, doc, deleteDoc, serverTimestamp, setDoc, getDoc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ---------- Firebase config (kept from original) ----------
        const firebaseConfig = {
            apiKey: "AIzaSyBvObxADcAior6R_or9O6UmWsFT8do1GkI",
            authDomain: "sqladmin-ff04d.firebaseapp.com",
            projectId: "sqladmin-ff04d",
            storageBucket: "sqladmin-ff04d.firebasestorage.app",
            messagingSenderId: "539086978850",
            appId: "1:539086978850:web:261e6a0cf3c9a2aa29ef7b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ---------- Globals ----------
        let activeTab = 'live';
        let activeMatchId = null;
        let commentTargetId = null;

        // ---------- Cloudinary upload helper ----------
        async function uploadToCloudinary(file){
            if(!file) return "";
            const fd = new FormData();
            fd.append("file", file);
            fd.append("upload_preset", "sql_admin"); // as provided
            fd.append("folder", "sql_free");
            try{
                const res = await fetch("https://api.cloudinary.com/v1_1/debp1kjtm/image/upload", { method:"POST", body: fd });
                const data = await res.json();
                return data.secure_url || "";
            }catch(e){
                console.error("Cloud upload fail", e);
                return "";
            }
        }

        // ---------- Small UI Helpers ----------
        function toggleMenu(s){
            document.getElementById('side-menu').classList.toggle('active', !!s);
        }
        function showPolicy(){
            alert("HACKS NOT ALLOWED!\nHacker pakda gaya to PERMANENT BAN.\n\nRefund Policy: Refunds available within 30 minutes of transaction only. ‚åõ");
        }
        function openAdminStub(){ alert("Admin panel is separate. Use admin console for full management."); }

        // ---------- Crypto helpers (PBKDF2 via WebCrypto) ----------
        function toBase64(buf){
            const bytes = new Uint8Array(buf);
            let binary = "";
            for(let i=0;i<bytes.byteLength;i++) binary += String.fromCharCode(bytes[i]);
            return btoa(binary);
        }
        function fromBase64(b64){
            const binary = atob(b64);
            const len = binary.length;
            const bytes = new Uint8Array(len);
            for(let i=0;i<len;i++) bytes[i] = binary.charCodeAt(i);
            return bytes.buffer;
        }
        function generateSaltBase64(){
            const arr = crypto.getRandomValues(new Uint8Array(16));
            return toBase64(arr.buffer);
        }
        async function derivePasswordHash(password, saltBase64){
            const enc = new TextEncoder();
            const passKey = await crypto.subtle.importKey('raw', enc.encode(password), { name: 'PBKDF2' }, false, ['deriveBits']);
            const saltBuf = fromBase64(saltBase64);
            // iterations: 150000 (balance between security & client cost)
            const derivedBits = await crypto.subtle.deriveBits({ name: 'PBKDF2', salt: saltBuf, iterations: 150000, hash: 'SHA-256' }, passKey, 256);
            return toBase64(derivedBits);
        }

        // ---------- Session and profile helpers ----------
        function saveSessionProfile(profile){
            localStorage.setItem('sql_session', JSON.stringify(profile));
        }
        function loadSessionProfile(){
            try{ return JSON.parse(localStorage.getItem('sql_session') || "null"); }catch(e){ return null; }
        }
        function clearSession(){
            localStorage.removeItem('sql_session');
            renderUI();
        }

        // ---------- AUTH: Register & Login UI ----------
        function openAuthModal(mode){
            document.getElementById('auth-modal').style.display = 'flex';
            const title = mode === 'register' ? 'REGISTER' : 'LOGIN';
            document.getElementById('auth-title').innerText = title;
            const body = document.getElementById('auth-body');
            body.innerHTML = "";
            if(mode === 'register'){
                body.innerHTML = `
                    <div style="display:grid; gap:8px;">
                        <input id="reg_name" placeholder="Full Name" style="padding:10px; background:#000; border:1px solid #222; border-radius:8px;">
                        <input id="reg_email" placeholder="Email (optional)" style="padding:10px; background:#000; border:1px solid #222; border-radius:8px;">
                        <input id="reg_phone" placeholder="Phone (e.g. +9190...)" style="padding:10px; background:#000; border:1px solid #222; border-radius:8px;">
                        <input id="reg_gamingid" placeholder="Gaming UID (optional)" style="padding:10px; background:#000; border:1px solid #222; border-radius:8px;">
                        <input id="reg_gamingname" placeholder="Gaming Name" style="padding:10px; background:#000; border:1px solid #222; border-radius:8px;">
                        <input id="reg_password" type="password" placeholder="Password" style="padding:10px; background:#000; border:1px solid #222; border-radius:8px;">
                        <input id="reg_confirm" type="password" placeholder="Confirm Password" style="padding:10px; background:#000; border:1px solid #222; border-radius:8px;">
                        <input type="file" id="reg_dp" accept="image/*">
                        <div class="muted" style="font-size:0.8rem;">Note: Password is securely hashed (PBKDF2) before storing. This is client-side hashing; for best security Phase-2 server-side auth will be added.</div>
                    </div>
                `;
                document.getElementById('auth-action').innerText = 'REGISTER';
                document.getElementById('auth-action').dataset.mode = 'register';
            } else {
                body.innerHTML = `
                    <div style="display:grid; gap:8px;">
                        <input id="login_phone" placeholder="Phone (e.g. +9190...)" style="padding:10px; background:#000; border:1px solid #222; border-radius:8px;">
                        <input id="login_password" type="password" placeholder="Password" style="padding:10px; background:#000; border:1px solid #222; border-radius:8px;">
                    </div>
                `;
                document.getElementById('auth-action').innerText = 'LOGIN';
                document.getElementById('auth-action').dataset.mode = 'login';
            }
        }
        function closeAuthModal(){ document.getElementById('auth-modal').style.display = 'none'; document.getElementById('auth-action').dataset.mode = ''; }

        async function submitAuth(){
            const mode = document.getElementById('auth-action').dataset.mode;
            if(mode === 'register'){
                const name = (document.getElementById('reg_name').value || "").trim();
                const email = (document.getElementById('reg_email').value || "").trim();
                const phone = (document.getElementById('reg_phone').value || "").trim();
                const gamingId = (document.getElementById('reg_gamingid').value || "").trim();
                const gamingName = (document.getElementById('reg_gamingname').value || "").trim();
                const password = (document.getElementById('reg_password').value || "");
                const confirm = (document.getElementById('reg_confirm').value || "");
                const dpFile = document.getElementById('reg_dp').files[0];

                if(!name || !phone || !password || !confirm){ return alert("Please fill required fields (name, phone, password)."); }
                if(password !== confirm) return alert("Password & confirm do not match.");

                // check existing user by phone
                try{
                    const userDocRef = doc(db, "users", phone);
                    const userSnap = await getDoc(userDocRef);
                    if(userSnap.exists()){
                        return alert("Phone already registered. Please login or use a different phone.");
                    }
                }catch(e){
                    console.error("user check fail", e);
                }

                // upload profile dp if provided
                const dpUrl = dpFile ? await uploadToCloudinary(dpFile) : "";

                // generate salt & derive hash
                const salt = generateSaltBase64();
                const hash = await derivePasswordHash(password, salt);

                // store to Firestore with document id = phone (ensures unique)
                const payload = { name, email, phone, gamingId, gamingName, dpUrl, salt, passwordHash: hash, createdAt: Date.now() };
                try{
                    await setDoc(doc(db,"users", phone), payload);
                }catch(e){
                    console.error("user save fail", e);
                    alert("Error saving user. Try again.");
                    return;
                }

                // create session locally
                const session = { id: phone, name, phone, email, gamingId, gamingName, dpUrl };
                saveSessionProfile(session);
                alert("Registered & logged in successfully.");
                closeAuthModal();
                renderUI();
            } else if(mode === 'login'){
                const phone = (document.getElementById('login_phone').value || "").trim();
                const password = (document.getElementById('login_password').value || "");
                if(!phone || !password) return alert("Please enter phone & password.");

                try{
                    const userSnap = await getDoc(doc(db,"users", phone));
                    if(!userSnap.exists()){
                        return alert("No account found with this phone. Please register.");
                    }
                    const u = userSnap.data();
                    const expectedHash = u.passwordHash;
                    const salt = u.salt;
                    const checkHash = await derivePasswordHash(password, salt);
                    if(checkHash !== expectedHash){
                        return alert("Invalid credentials.");
                    }
                    const session = { id: phone, name: u.name, phone: u.phone, email: u.email, gamingId: u.gamingId, gamingName: u.gamingName, dpUrl: u.dpUrl || "" };
                    saveSessionProfile(session);
                    alert("Login successful.");
                    closeAuthModal();
                    renderUI();
                }catch(e){
                    console.error("login fail", e);
                    alert("Login error. Try again.");
                }
            } else {
                alert("Unknown auth mode.");
            }
        }

        // ---------- Render UI: Matches ----------
        function renderUI(){
            const container = document.getElementById('app-content');
            container.innerHTML = "";
            onSnapshot(collection(db, "matches"), snap => {
                // if result tab selected, render results
                if(activeTab === 'result'){ renderResults(container); return; }

                const docs = [];
                snap.forEach(d => docs.push({ id: d.id, data: d.data() }));

                // If 'my' tab then render My History section separately
                if(activeTab === 'my'){
                    renderMyHistory(container);
                    return;
                }

                docs.forEach(docItem => {
                    const m = docItem.data;
                    const mid = docItem.id;

                    if(activeTab === 'started'){
                        const startTime = parseInt(m.startTime || 0);
                        if(Date.now() < startTime) return;
                    }

                    const record = JSON.parse(localStorage.getItem(`pay_record_${mid}`) || "null");

                    const startTime = parseInt(m.startTime || 0);
                    const isStarted = Date.now() >= startTime;
                    const isExpired = Date.now() > (startTime + 3600000);

                    const total = Number(m.total || 0);
                    const joined = Number(m.joined || 0);
                    const waiting = Math.max(0, total - joined);
                    const fillPercent = total > 0 ? Math.min(100, (joined/total)*100) : 0;

                    let actionHtml = "";
                    if(record){
                        if(record.status === 'approved' || (m.approvedUtrs && m.approvedUtrs.includes(record.utr))){
                            if(isExpired) {
                                actionHtml = `<button class="btn-main btn-dis">MATCH EXPIRED</button>`;
                            } else {
                                actionHtml = `
                                <div class="room-box">
                                  <h4>‚úÖ JOINED SUCCESSFULLY</h4>
                                  <div class="room-data allow-select">
                                    <div><span>ROOM ID</span><b>${m.roomId || 'Wait...'}</b></div>
                                    <div><span>PASSWORD</span><b>${m.password || 'Wait...'}</b></div>
                                  </div>
                                </div>`;
                            }
                        } else if(record.status === 'rejected'){
                            actionHtml = `<button class="btn-main" style="background:var(--red); color:#fff;" disabled>PAYMENT REJECTED</button>`;
                        } else {
                            checkRealtimeApproval(mid, record.utr);
                            actionHtml = `<button class="btn-main btn-dis" style="color:var(--gold)">VERIFYING UTR: ${record.utr}</button>`;
                        }
                    } else if (isStarted){
                        actionHtml = `<button class="btn-main btn-dis">MATCH STARTED</button>`;
                    } else if (joined >= total){
                        actionHtml = `<button class="btn-main btn-dis">MATCH FULL</button>`;
                    } else {
                        actionHtml = `<button class="btn-main btn-join" onclick="openPayment('${mid}', ${m.entry})">JOIN NOW</button>`;
                    }

                    container.innerHTML += `
                    <div class="card" aria-live="polite">
                        <div class="m-tag">${(m.map||'NA').toUpperCase()}</div>
                        <div class="card-body">
                            <div class="item"><i class="fas fa-gamepad"></i><div><span>Mode</span><b>${m.type||'---'}</b></div></div>
                            <div class="item"><i class="fas fa-trophy"></i><div><span>Win Prize</span><b class="win-green">‚Çπ${m.win||0}</b></div></div>
                            <div class="item"><i class="fas fa-wallet"></i><div><span>Entry Fee</span><b class="entry-gold">‚Çπ${m.entry||0}</b></div></div>
                            <div class="item"><i class="fas fa-id-badge"></i><div><span>Match ID</span><b>#${mid.slice(-4)}</b></div></div>
                        </div>

                        <div class="timer-box">
                            <span class="timer-label">MATCH STARTS IN</span>
                            <span class="countdown" data-time="${startTime}">--:--:--</span>
                        </div>

                        <div class="card-footer">
                            <div class="slots"><span>Filled: ${joined}/${total}</span><span class="waiting">Waiting: ${waiting}</span></div>
                            <div class="bar"><div class="fill" style="width:${fillPercent}%"></div></div>
                            ${actionHtml}
                            <div style="margin-top:8px; display:flex; gap:8px;">
                                <button class="small-btn" onclick="openMatchDetails('${mid}')">Details</button>
                                <button class="small-btn" onclick="openResultPreview('${mid}')">Result Preview</button>
                            </div>
                        </div>
                    </div>`;
                });
            }, err => {
                console.error("matches snapshot error", err);
            });
        }

        // ---------- Match details & preview ----------
        function openMatchDetails(matchId){ alert("Match details managed by admin. ID: " + matchId.slice(-6)); }
        function openResultPreview(matchId){ alert("Result preview (coming soon). ID: " + matchId.slice(-6)); }

        // ---------- Realtime Approval Check ----------
        function checkRealtimeApproval(mid, utr){
            const q = query(collection(db,"payments"), where("matchId","==", mid), where("utr","==", utr));
            onSnapshot(q, (s) => {
                s.forEach(docItem => {
                    const data = docItem.data();
                    if(data.status === 'approved'){
                        const local = JSON.parse(localStorage.getItem(`pay_record_${mid}`) || "null");
                        if(local){ local.status = 'approved'; localStorage.setItem(`pay_record_${mid}`, JSON.stringify(local)); }
                    }
                });
            });
        }

        // ---------- Timer Logic ----------
        setInterval(()=>{
            document.querySelectorAll('.countdown').forEach(el=>{
                const target = parseInt(el.dataset.time) || 0;
                const diff = target - Date.now();
                if(diff <= 0){ el.innerText = "STARTED"; el.style.color = "var(--accent)"; }
                else{
                    const h = Math.floor(diff/3600000);
                    const m = Math.floor((diff%3600000)/60000);
                    const s = Math.floor((diff%60000)/1000);
                    el.innerText = `${h}h : ${m}m : ${s}s`;
                }
            });
        }, 1000);

        // ---------- Payments: Open modal (requires login) ----------
        window.openPayment = async (id, amt) => {
            const session = loadSessionProfile();
            if(!session) { openAuthModal('login'); return alert("Please login to join matches."); }
            activeMatchId = id;
            document.getElementById('modal-amt').innerText = "‚Çπ" + amt;
            const upi = `upi://pay?pa=rizwanhasan90122778623@ybl&am=${amt}&cu=INR&tn=SQL_ARENA_${id}`;
            document.getElementById('g-link').href = upi;
            document.getElementById('p-link').href = upi;
            document.getElementById('y-link').href = upi;
            document.getElementById('payer-name').value = session.name || "";
            document.getElementById('payer-phone').value = session.phone || "";
            document.getElementById('payer-gamingid').value = session.gamingId || session.gamingid || "";
            document.getElementById('pay-modal').style.display = 'flex';
        };

        window.closeModal = () => document.getElementById('pay-modal').style.display = 'none';

        window.processPayment = async () => {
            const session = loadSessionProfile();
            if(!session) return alert("Please login to submit payment.");
            const utr = (document.getElementById('utr-input').value || "").trim();
            if(utr.length !== 12) return alert("Enter valid 12 Digit UTR!");
            const btn = document.getElementById('submit-btn');
            btn.disabled = true; btn.innerText = "Processing...";

            const ssFile = document.getElementById('utr-ss').files[0];
            const dpFile = document.getElementById('payer-dp').files[0];
            const name = (document.getElementById('payer-name').value || "").trim();
            const phone = (document.getElementById('payer-phone').value || "").trim();
            const gamingid = (document.getElementById('payer-gamingid').value || "").trim();
            if(!name || !phone){ btn.disabled=false; btn.innerText="SUBMIT TRANSACTION"; return alert("Please enter name and phone before submitting."); }

            const ssUrl = ssFile ? await uploadToCloudinary(ssFile) : "";
            const dpUrl = dpFile ? await uploadToCloudinary(dpFile) : session.dpUrl || "";

            const record = { utr: utr, matchId: activeMatchId, status: 'pending', date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString(), payer: { name, phone, gamingid, dpUrl } };

            localStorage.setItem(`pay_record_${activeMatchId}`, JSON.stringify(record));

            try{
                await addDoc(collection(db,"payments"), {
                    ...record,
                    ss: ssUrl,
                    timestamp: Date.now()
                });
            }catch(e){
                console.error("firestore payments add fail", e);
            }

            const logs = JSON.parse(localStorage.getItem('sql_paylogs') || "[]");
            logs.unshift({ matchId: activeMatchId, utr, ss: ssUrl, name, phone, gamingid, date: new Date().toLocaleString(), status: 'pending' });
            localStorage.setItem('sql_paylogs', JSON.stringify(logs.slice(0,200)));

            // Update session with any new dp/gamingid
            const existing = loadSessionProfile() || {};
            existing.name = name; existing.phone = phone; existing.gamingId = gamingid || existing.gamingId;
            if(dpUrl) existing.dpUrl = dpUrl;
            saveSessionProfile(existing);

            alert("UTR Submitted! Room Details will unlock once Admin approves.");
            closeModal();
            btn.disabled = false; btn.innerText = "SUBMIT TRANSACTION";
            renderUI();
        };

        // ---------- My History (uses session + local logs) ----------
        function renderMyHistory(container){
            const session = loadSessionProfile();
            const wrapper = document.createElement('div');
            wrapper.style.gridColumn = "1/-1";
            wrapper.style.padding = "6px 0 20px 0";

            if(!session){
                wrapper.innerHTML = `<div style="padding:12px; background:#111; border-radius:12px; border:1px solid #222;">
                    <p class="muted">You are not logged in. Login or Register to save your history across devices.</p>
                    <div style="display:flex; gap:8px; margin-top:8px;">
                        <button class="small-btn" onclick="openAuthModal('login')">Login</button>
                        <button class="small-btn" onclick="openAuthModal('register')">Register</button>
                    </div>
                </div>`;
                container.appendChild(wrapper);
                return;
            }

            wrapper.innerHTML = `
                <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
                    <div style="display:flex; gap:8px; align-items:center;">
                        <img src="${session.dpUrl||'https://img.icons8.com/ios-filled/50/user.png'}" alt="dp" style="width:52px;height:52px;border-radius:12px;object-fit:cover;border:1px solid #222;">
                        <div>
                            <div style="font-weight:800">${session.name}</div>
                            <div class="muted">${session.phone} ‚Ä¢ Gaming ID: ${session.gamingId||'‚Äî'}</div>
                        </div>
                    </div>
                    <div style="margin-left:auto; display:flex; gap:8px;">
                        <button class="small-btn" onclick="showHistory('active')">Active Joined</button>
                        <button class="small-btn" onclick="showHistory('past')">Past Matches</button>
                        <button class="small-btn" onclick="logout()">Logout</button>
                    </div>
                </div>
                <div id="history-list"></div>
            `;
            container.appendChild(wrapper);
            showHistory('active');
        }

        function logout(){ clearSession(); alert("Logged out."); }

        function showHistory(type){
            const list = document.getElementById('history-list');
            list.innerHTML = "";
            const logs = JSON.parse(localStorage.getItem('sql_paylogs') || "[]");
            const session = loadSessionProfile();
            if(!session){ list.innerHTML = '<p class="muted">No profile found.</p>'; return; }
            const my = logs.filter(l => l.phone === session.phone);

            if(type === 'active'){
                const active = my.filter(l => {
                    const rec = JSON.parse(localStorage.getItem(`pay_record_${l.matchId}`) || "null");
                    return rec && rec.status !== 'approved' ? rec : rec;
                });
                if(active.length === 0) { list.innerHTML = '<p class="muted">No active joined matches.</p>'; return; }
                active.forEach(a => {
                    const card = document.createElement('div');
                    card.className = 'result-card';
                    card.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;">
                        <div><b>Match: ${a.matchId.slice(-6)}</b><div class="muted">UTR: ${a.utr} ‚Ä¢ ${a.date}</div></div>
                        <div><button class="small-btn" onclick="viewPayment('${a.matchId}')">View</button></div>
                    </div>`;
                    list.appendChild(card);
                });
            } else {
                const past = my; // show all logged payments as past
                if(past.length === 0){ list.innerHTML = '<p class="muted">No past matches yet.</p>'; return; }
                past.forEach(a => {
                    const card = document.createElement('div');
                    card.className = 'result-card';
                    card.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;">
                        <div><b>Match: ${a.matchId.slice(-6)}</b><div class="muted">${a.date}</div></div>
                        <div><button class="small-btn" onclick="viewPayment('${a.matchId}')">View</button></div>
                    </div>`;
                    list.appendChild(card);
                });
            }
        }

        function viewPayment(matchId){
            const rec = JSON.parse(localStorage.getItem(`pay_record_${matchId}`) || "null");
            if(!rec) return alert("No payment record found for this match.");
            let msg = `Match: ${matchId}\nUTR: ${rec.utr}\nStatus: ${rec.status}\nDate: ${rec.date || '‚Äî'}`;
            if(rec.payer) msg += `\nName: ${rec.payer.name}\nPhone: ${rec.payer.phone}`;
            alert(msg);
        }

        // ---------- Results Feed (with like/comment) ----------
        async function renderResults(container){
            container.innerHTML = "<div style='grid-column:1/-1; padding:8px 6px 20px 6px;'><div style='display:flex; gap:8px; align-items:center;'><button class='small-btn' onclick='openResultUpload()'>Upload Result (Admin)</button><div class='muted' style='margin-left:auto'>Results show here. You can like & comment.</div></div></div>";
            const resQuery = query(collection(db,"results"), orderBy("timestamp","desc"), limit(100));
            const snap = await getDocs(resQuery);
            if(snap.empty){ container.innerHTML += '<div style="grid-column:1/-1;padding:30px;text-align:center;color:var(--waiting)">Result Coming Soon ‚åõ</div>'; return; }
            snap.forEach(docItem => {
                const r = docItem.data();
                const id = docItem.id;
                const rc = document.createElement('div');
                rc.className = 'result-card';
                rc.innerHTML = `
                    <div class="result-meta">
                        <div><b>${r.title || 'Result'}</b><div class="muted">${new Date(r.timestamp || Date.now()).toLocaleString()}</div></div>
                        <div>
                          <button class="small-btn" onclick="toggleLike('${id}')">üëç <span id="lk-${id}">${r.likesCount||0}</span></button>
                          <button class="small-btn" onclick="openCommentModal('${id}')">üí¨ Comment</button>
                        </div>
                    </div>
                    ${r.image ? `<img class="result-img" src="${r.image}" alt="result">` : ''}
                    <div class="muted">${r.body || ''}</div>
                `;
                container.appendChild(rc);
            });
        }

        // Admin upload result stub
        async function openResultUpload(){
            const title = prompt("Result Title (e.g. 'Match #123 - Winners')");
            if(!title) return;
            const body = prompt("Short body / message");
            const fileInput = document.createElement('input');
            fileInput.type = 'file'; fileInput.accept='image/*';
            fileInput.onchange = async () => {
                const f = fileInput.files[0];
                const img = f ? await uploadToCloudinary(f) : "";
                const payload = { title, body, image: img, timestamp: Date.now(), likesCount:0 };
                await addDoc(collection(db,"results"), payload);
                await trimResultsTo100();
                alert("Result uploaded.");
                renderUI();
            };
            fileInput.click();
        }

        async function trimResultsTo100(){
            const q = query(collection(db,"results"), orderBy("timestamp","asc"));
            const snap = await getDocs(q);
            if(snap.size <= 100) return;
            const toDelete = snap.size - 100;
            let i = 0;
            for(const d of snap.docs){
                if(i >= toDelete) break;
                try{ await deleteDoc(doc(db, "results", d.id)); }catch(e){console.warn("delete fail", e);}
                i++;
            }
        }

        // Likes/comments (basic)
        async function toggleLike(resultId){
            const session = loadSessionProfile();
            if(!session) return alert("Login to like/comment.");
            const likeDocId = `${resultId}_${session.phone}`;
            // simple check: try get doc by id
            try{
                const res = await getDocs(query(collection(db,"result_likes"), where("id","==", likeDocId)));
                if(res.empty){
                    await setDoc(doc(db, "result_likes", likeDocId), { id: likeDocId, resultId, phone: session.phone, name: session.name, timestamp: Date.now() });
                    alert("Liked!");
                } else {
                    alert("You already liked.");
                }
            }catch(e){ console.error(e); alert("Like error."); }
        }

        function openCommentModal(resultId){
            const session = loadSessionProfile();
            if(!session) return alert("Login to like/comment.");
            commentTargetId = resultId;
            document.getElementById('comment-text').value = "";
            document.getElementById('comment-modal').style.display = 'flex';
        }
        function closeComment(){ document.getElementById('comment-modal').style.display = 'none'; commentTargetId = null; }
        async function submitComment(){
            const text = document.getElementById('comment-text').value.trim();
            const session = loadSessionProfile();
            if(!text) return alert("Enter comment.");
            if(!session) return alert("Login to comment.");
            await addDoc(collection(db,"result_comments"), { resultId: commentTargetId, text, name: session.name, phone: session.phone, timestamp: Date.now() });
            alert("Comment submitted.");
            closeComment();
        }

        // ---------- Utility to close modals on outside click ----------
        window.addEventListener('click', (e) => {
            const modals = ['pay-modal','auth-modal','comment-modal'];
            modals.forEach(id => {
                const el = document.getElementById(id);
                if(el && el.style.display === 'flex' && e.target === el) el.style.display = 'none';
            });
        });

        // ---------- Switch Tab ----------
        function switchTab(t){
            activeTab = t;
            document.getElementById('tab-live').classList.toggle('active', t === 'live');
            document.getElementById('tab-my').classList.toggle('active', t === 'my');
            document.getElementById('tab-result').classList.toggle('active', t === 'result');
            renderUI();
        }

        // ---------- Initial run ----------
        renderUI();

        // Expose functions globally for onclick attributes
        window.toggleMenu = toggleMenu;
        window.switchTab = switchTab;
        window.openPayment = window.openPayment;
        window.processPayment = window.processPayment;
        window.openAuthModal = openAuthModal;
        window.closeAuthModal = closeAuthModal;
        window.submitAuth = submitAuth;
        window.openResultUpload = openResultUpload;
        window.openCommentModal = openCommentModal;
        window.closeComment = closeComment;
        window.submitComment = submitComment;
        window.logout = logout;
    </script>
</body>
    </html>

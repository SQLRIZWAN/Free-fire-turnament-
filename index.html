<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SQL TOURNAMENT PRO - Unified</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* Minimal combined styling (kept similar to original themes) */
    :root{--accent:#00ff88;--gold:#ffd700;--bg:#050505;--card:#121212;--muted:#888;--red:#ff4444;}
    body{margin:0;background:var(--bg);color:#fff;font-family:Poppins,Arial;}
    header{background:#000;padding:12px;border-bottom:2px solid var(--gold);display:flex;align-items:center;justify-content:space-between;}
    header h1{font-size:1rem;color:var(--gold);margin:0}
    .wrap{padding:12px;max-width:1100px;margin:10px auto;}
    .tabs{display:flex;gap:8px;margin:12px 0}
    .tab{padding:8px 12px;border-radius:8px;background:#111;border:1px solid #222;cursor:pointer}
    .tab.active{background:var(--accent);color:#000}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:12px}
    .card{background:var(--card);padding:12px;border-radius:12px;border:1px solid #222}
    input,select,textarea,button{font-family:inherit}
    .small{padding:8px 10px;border-radius:8px}
    pre{white-space:pre-wrap;word-break:break-word}
    .admin-badge{background:var(--gold);color:#000;padding:6px;border-radius:8px;font-weight:800}
    /* responsive */
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <h1>SQL TOURNAMENT PRO — Unified (User + Admin)</h1>
    <div>
      <span id="logged-as" style="margin-right:12px;color:var(--accent)">Guest</span>
      <button class="small" onclick="toggleAdminPanel()">Admin</button>
    </div>
  </header>

  <div class="wrap">
    <div class="tabs">
      <div class="tab active" id="tab-live" onclick="switchTab('live')">LIVE MATCHES</div>
      <div class="tab" id="tab-my" onclick="switchTab('my')">MY PROFILE</div>
      <div class="tab" id="tab-result" onclick="switchTab('result')">RESULTS</div>
      <div class="tab" id="tab-admin" style="display:none" onclick="switchTab('admin')">ADMIN</div>
    </div>

    <div id="main-area" class="grid">
      <!-- LEFT: Primary content -->
      <div id="content-area">
        <!-- Rendered by JS -->
      </div>

      <!-- RIGHT: Side / Wallet / Admin quick -->
      <div id="side-area">
        <div class="card">
          <h3 style="margin:0 0 8px 0">Wallet</h3>
          <div style="font-size:0.9rem;color:var(--muted)">Available: <b id="side-balance">₹0.00</b></div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button class="small" onclick="openWalletModal('add')">Add Fund</button>
            <button class="small" onclick="openWalletModal('with')">Withdraw</button>
          </div>
          <div style="margin-top:10px">
            <button class="small" onclick="openAuthModal('login')">Login</button>
            <button class="small" onclick="openAuthModal('register')">Register</button>
            <button class="small" onclick="logout()" id="logout-btn" style="display:none">Logout</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4 style="margin:0 0 8px 0">Quick Admin</h4>
          <div id="admin-quick" style="display:flex;flex-direction:column;gap:8px">
            <button class="small" onclick="openAdminLogin()" id="admin-open-btn">Admin Login</button>
            <div id="admin-links" style="display:none">
              <button class="small" onclick="switchTab('admin')">Open Admin Dashboard</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Common Modals -->
  <div id="auth-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.9);align-items:center;justify-content:center;z-index:9999">
    <div style="background:#111;padding:16px;border-radius:10px;width:340px;border:1px solid var(--gold)">
      <h3 id="auth-title" style="color:var(--gold);margin:0 0 10px 0">LOGIN</h3>
      <div id="auth-forms"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="small" onclick="document.getElementById('auth-modal').style.display='none'">CANCEL</button>
        <button class="small" id="auth-submit-btn" onclick="submitAuth()">LOGIN</button>
      </div>
    </div>
  </div>

  <div id="wallet-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.9);align-items:center;justify-content:center;z-index:9998">
    <div style="background:#111;padding:16px;border-radius:10px;width:360px;border:1px solid var(--gold)">
      <h3 id="wallet-modal-title" style="color:var(--gold);margin:0 0 10px 0">ADD FUND</h3>
      <div id="add-fund-form">
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <div class="small" onclick="setPkg(50)">₹50</div>
          <div class="small" onclick="setPkg(100)">₹100</div>
          <div class="small" onclick="setPkg(200)">₹200</div>
          <div class="small" onclick="setPkg(500)">₹500</div>
        </div>
        <input id="manual-amt" type="number" placeholder="Enter Amount (Min ₹10)" style="width:100%;padding:8px;border-radius:8px;margin-bottom:8px">
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="small" onclick="document.getElementById('wallet-modal').style.display='none'">CANCEL</button>
          <button class="small" onclick="initWalletDeposit()">DEPOSIT</button>
        </div>
      </div>
      <div id="withdraw-form" style="display:none">
        <input id="with-amt" type="number" placeholder="Amount (Min ₹50)" style="width:100%;padding:8px;border-radius:8px;margin-bottom:8px">
        <input id="with-upi" type="text" placeholder="UPI ID" style="width:100%;padding:8px;border-radius:8px;margin-bottom:8px">
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="small" onclick="document.getElementById('wallet-modal').style.display='none'">CANCEL</button>
          <button class="small" onclick="submitWithdrawal()">REQUEST</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pay modal -->
  <div id="pay-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.9);align-items:center;justify-content:center;z-index:9997">
    <div style="background:#111;padding:16px;border-radius:10px;width:420px;border:1px solid var(--gold)">
      <h3 style="color:var(--gold);margin:0 0 8px 0">CONFIRM PAYMENT</h3>
      <div style="text-align:center;margin-bottom:8px">Amount: <b id="modal-amt">₹0</b></div>
      <div style="margin-bottom:8px">
        <input id="utr-input" placeholder="Enter UTR / Ref No" style="width:100%;padding:8px;border-radius:8px;margin-bottom:8px">
        <input id="utr-file" type="file" accept="image/*" style="width:100%;margin-bottom:8px">
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="small" onclick="document.getElementById('pay-modal').style.display='none'">CANCEL</button>
        <button class="small" onclick="processPayment()">SUBMIT</button>
      </div>
    </div>
  </div>

  <!-- Admin login modal -->
  <div id="admin-login-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.9);align-items:center;justify-content:center;z-index:9999">
    <div style="background:#111;padding:16px;border-radius:10px;width:360px;border:1px solid var(--gold)">
      <h3 style="color:var(--gold);margin:0 0 10px 0">ADMIN LOGIN</h3>
      <input id="admin-id" placeholder="Admin ID (email/uid)" style="width:100%;padding:8px;border-radius:8px;margin-bottom:8px">
      <input id="admin-pass" placeholder="Password" type="password" style="width:100%;padding:8px;border-radius:8px;margin-bottom:8px">
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="small" onclick="document.getElementById('admin-login-modal').style.display='none'">CANCEL</button>
        <button class="small" onclick="submitAdminLogin()">LOGIN</button>
      </div>
    </div>
  </div>

  <!-- Admin only content will render into #admin-area -->
  <div id="admin-area" style="display:none;padding:12px"></div>

  <script type="module">
    // --- FIREBASE SDK imports (module style used in original files) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, limit, getDocs,
      doc, setDoc, getDoc, updateDoc, deleteDoc, runTransaction, arrayUnion, increment
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- CONFIG from original files (unchanged) ---
    const firebaseConfig = {
        apiKey: "AIzaSyBvObxADcAior6R_or9O6UmWsFT8do1GkI",
        authDomain: "sqladmin-ff04d.firebaseapp.com",
        projectId: "sqladmin-ff04d",
        storageBucket: "sqladmin-ff04d.firebasestorage.app",
        messagingSenderId: "539086978850",
        appId: "1:539086978850:web:261e6a0cf3c9a2aa29ef7b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- STATE ---
    let activeTab = 'live';
    let activeMatchId = null;
    let activeEntryFee = 0;
    let currentUserBal = 0;
    let currentSession = null; // {phone, name, ...}
    let isAdmin = false;
    let adminId = null;

    // --- UTIL: SHA-256 hashing for password (client-side improvement; still prefer server/auth) ---
    async function sha256hex(str){
      const buf = new TextEncoder().encode(str);
      const hash = await crypto.subtle.digest('SHA-256', buf);
      const arr = Array.from(new Uint8Array(hash));
      return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    // --- SESSION STORAGE helpers ---
    function saveSession(data){
      localStorage.setItem('sql_session', JSON.stringify(data));
      currentSession = data;
      updateMenuUI();
      if(data && data.phone) startWalletSync(data.phone);
    }
    function loadSession(){ try{ return JSON.parse(localStorage.getItem('sql_session')||'null'); }catch(e){return null} }
    function clearSession(){ localStorage.removeItem('sql_session'); currentSession = null; currentUserBal = 0; updateMenuUI(); renderUI(); }

    function updateMenuUI(){
      const el = document.getElementById('logged-as');
      if(currentSession){ el.innerText = `${currentSession.name} (${currentSession.phone})`; document.getElementById('logout-btn').style.display='inline-block'; } 
      else { el.innerText = 'Guest'; document.getElementById('logout-btn').style.display='none'; }
      document.getElementById('side-balance').innerText = `₹${(currentUserBal||0).toFixed(2)}`;
      document.getElementById('tab-admin').style.display = isAdmin ? 'inline-block' : 'none';
      document.getElementById('admin-links').style.display = isAdmin ? 'block' : 'none';
    }

    // Start wallet sync - listen to user doc updates in realtime
    function startWalletSync(phone){
      const uref = doc(db,"users",phone);
      onSnapshot(uref, snap => {
        if(snap.exists()){
          const d = snap.data();
          currentUserBal = d.balance || 0;
          saveSession(d);
        }
      });
    }

    // --- AUTH (user) ---
    let currentAuthMode = 'login';
    function openAuthModal(mode='login'){
      currentAuthMode = mode;
      renderAuthForm();
      document.getElementById('auth-modal').style.display='flex';
    }
    function renderAuthForm(){
      const ui = document.getElementById('auth-forms');
      document.getElementById('auth-title').innerText = currentAuthMode === 'login' ? 'LOGIN' : 'REGISTER';
      document.getElementById('auth-submit-btn').innerText = currentAuthMode === 'login' ? 'LOGIN' : 'CREATE';
      if(currentAuthMode === 'login'){
        ui.innerHTML = `<input id="login_phone" placeholder="Phone" style="width:100%;padding:8px;border-radius:8px;margin-bottom:8px">
                        <input id="login_pass" placeholder="Password" type="password" style="width:100%;padding:8px;border-radius:8px">`;
      } else {
        ui.innerHTML = `<input id="reg_name" placeholder="Full Name" style="width:100%;padding:8px;border-radius:8px;margin-bottom:8px">
                        <input id="reg_phone" placeholder="Phone (10 digits)" style="width:100%;padding:8px;border-radius:8px;margin-bottom:8px">
                        <input id="reg_gaming" placeholder="Gaming UID" style="width:100%;padding:8px;border-radius:8px;margin-bottom:8px">
                        <input id="reg_pass" placeholder="Password" type="password" style="width:100%;padding:8px;border-radius:8px">`;
      }
    }

    window.submitAuth = async () => {
      const btn = document.getElementById('auth-submit-btn');
      btn.disabled = true;
      try {
        if(currentAuthMode === 'register'){
          const name = document.getElementById('reg_name').value.trim();
          const phone = document.getElementById('reg_phone').value.trim();
          const gaming = document.getElementById('reg_gaming').value.trim();
          const pass = document.getElementById('reg_pass').value.trim();
          if(!name || !phone || phone.length!==10 || !gaming || !pass) throw 'Fill all fields correctly';
          // hash password before storing (improvement vs plain text)
          const h = await sha256hex(pass);
          const docRef = doc(db,"users",phone);
          const snap = await getDoc(docRef);
          if(snap.exists()) throw 'Phone already registered';
          const userData = { name, phone, gamingName: gaming, passwordHash: h, dpUrl:'', upiId:'', qrUrl:'', balance:0, totalProfit:0, totalLoss:0 };
          await setDoc(docRef, userData);
          saveSession(userData);
          document.getElementById('auth-modal').style.display='none';
          alert('Registration successful');
          renderUI();
        } else {
          const phone = document.getElementById('login_phone').value.trim();
          const pass = document.getElementById('login_pass').value.trim();
          if(!phone || !pass) throw 'Enter credentials';
          const snap = await getDoc(doc(db,"users",phone));
          if(!snap.exists()) throw 'User not found';
          const data = snap.data();
          const h = await sha256hex(pass);
          if(data.passwordHash !== h) throw 'Wrong password';
          saveSession(data);
          document.getElementById('auth-modal').style.display='none';
          alert('Login success');
          renderUI();
        }
      } catch(e){ alert(e); }
      finally { btn.disabled=false; }
    };

    window.logout = () => { if(confirm('Logout?')){ clearSession(); } };

    // --- ADMIN LOGIN (simple, reads 'admins' collection; store admins securely in DB) ---
    function openAdminLogin(){ document.getElementById('admin-login-modal').style.display='flex'; }
    async function submitAdminLogin(){
      const id = document.getElementById('admin-id').value.trim();
      const pass = document.getElementById('admin-pass').value.trim();
      if(!id || !pass) return alert('Enter admin credentials');
      try {
        const snap = await getDoc(doc(db,"admins",id));
        if(!snap.exists()) throw 'Admin not found';
        const data = snap.data();
        const h = await sha256hex(pass);
        if(data.passwordHash !== h) throw 'Wrong admin password';
        isAdmin = true; adminId = id;
        document.getElementById('admin-login-modal').style.display='none';
        updateMenuUI();
        alert('Admin authenticated');
      } catch(e){ alert(e); }
    }
    window.submitAdminLogin = submitAdminLogin;

    // --- RENDER / UI ---
    function switchTab(t){
      activeTab = t;
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      document.getElementById('tab-'+t).classList.add('active');
      renderUI();
    }

    // initial render
    (function init(){
      currentSession = loadSession();
      if(currentSession) startWalletSync(currentSession.phone);
      updateMenuUI();
      renderUI();
    })();

    // Render core UI pages
    function renderUI(){
      const c = document.getElementById('content-area');
      c.innerHTML = '';
      if(activeTab==='live') renderLiveMatches(c);
      else if(activeTab==='my') renderProfile(c);
      else if(activeTab==='result') renderResults(c);
      else if(activeTab==='admin') renderAdminDashboard(c);
    }

    // --- LIVE MATCHES (reads matches collection) ---
    function renderLiveMatches(container){
      container.innerHTML = '<div class="card">Loading matches...</div>';
      // realtime snapshot
      onSnapshot(collection(db,"matches"), snap => {
        const arr = [];
        snap.forEach(d=> arr.push({id:d.id,...d.data()}));
        // sort by startTime
        arr.sort((a,b)=> (a.startTime||0)-(b.startTime||0));
        container.innerHTML = '';
        arr.forEach(m => {
          const card = document.createElement('div'); card.className='card'; 
          const start = m.startTime||0;
          const isStarted = Date.now() > start;
          const isFull = (m.joined||0) >= (m.total||48);
          let btn = '';
          // Check local payment marker or payments collection for this user
          let joinedHtml = '';
          if(currentSession){
            // check if user has payment record for this match
            // We'll read payments for this user & match to decide (non-blocking show)
            getDocs(query(collection(db,"payments"), where("userId","==", currentSession.phone), where("matchId","==", m.id)))
              .then(snapP=>{
                let joined=false;
                snapP.forEach(p=>{ const dt=p.data(); if(dt.status==='approved') joined=true; });
                const roomHtml = joined ? `<div style="margin-top:8px;background:#081208;padding:8px;border-radius:8px">✅ JOINED</div>` : '';
                const joinBtn = joined ? `<button class="small" disabled>JOINED</button>` : (isStarted ? `<button class="small" disabled>STARTED</button>` : (isFull ? `<button class="small" disabled>FULL</button>` : `<button class="small" onclick="initPayment('${m.id}', ${m.entry})">JOIN ₹${m.entry}</button>`));
                card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
                                    <div><b>${m.map || 'Map'}</b> • ${m.type || 'Mode'}</div>
                                    <div>${joinBtn}</div>
                                  </div>
                                  <div style="margin-top:8px;color:var(--muted)">Prize: ₹${m.win||0} • Joined: ${m.joined||0}/${m.total||48} • ${new Date(start).toLocaleString()}</div>
                                  ${roomHtml}`;
              })
              .catch(()=>{ /* ignore */ });
          } else {
            const joinBtn = isStarted ? `<button class="small" disabled>STARTED</button>` : (isFull ? `<button class="small" disabled>FULL</button>` : `<button class="small" onclick="initPayment('${m.id}', ${m.entry})">JOIN ₹${m.entry}</button>`);
            card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
                                <div><b>${m.map||'Map'}</b> • ${m.type||'Mode'}</div>
                                <div>${joinBtn}</div>
                              </div>
                              <div style="margin-top:8px;color:var(--muted)">Prize: ₹${m.win||0} • Joined: ${m.joined||0}/${m.total||48} • ${new Date(start).toLocaleString()}</div>`;
          }
          container.appendChild(card);
        });
      });
    }

    // --- PROFILE (my) ---
    function renderProfile(container){
      container.innerHTML = '';
      if(!currentSession) {
        container.innerHTML = `<div class="card" style="text-align:center">Please login to view profile<br><br><button class="small" onclick="openAuthModal('login')">Login</button></div>`;
        return;
      }
      const user = currentSession;
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `<div style="text-align:center">
          <h3 style="margin:0">${user.name}</h3>
          <div style="color:var(--accent)">${user.phone}</div>
          <div style="margin-top:10px">Balance: <b id="profile-balance">₹${(user.balance||0).toFixed(2)}</b></div>
          <div style="display:flex;gap:8px;margin-top:8px;justify-content:center">
            <button class="small" onclick="openWalletModal('add')">ADD</button>
            <button class="small" onclick="openWalletModal('with')">WITHDRAW</button>
            <button class="small" onclick="showFundHistory()">FUND HISTORY</button>
            <button class="small" onclick="showWithdrawHistory()">WITHDRAW HISTORY</button>
          </div>
        </div>`;
      container.appendChild(card);
    }

    // --- RESULTS ---
    function renderResults(container){
      container.innerHTML = '<div class="card">Loading results...</div>';
      const q = query(collection(db,"results"), orderBy("timestamp","desc"), limit(30));
      onSnapshot(q, async snap => {
        container.innerHTML = '';
        snap.forEach(d => {
          const r = d.data();
          const el = document.createElement('div'); el.className='card';
          el.innerHTML = `<div style="display:flex;justify-content:space-between"><div><b>${r.winnerName||'Winner'}</b> • ₹${r.winningAmount||0}</div><div>${new Date(r.timestamp||0).toLocaleString()}</div></div>
                          <div style="margin-top:8px"><img src="${r.image||''}" style="max-width:100%;border-radius:8px"></div>`;
          container.appendChild(el);
        });
      });
    }

    // -------------------------
    // PAYMENT / WALLET LOGIC (FIXED)
    // -------------------------

    // Open wallet modal
    function openWalletModal(type){
      document.getElementById('wallet-modal').style.display='flex';
      document.getElementById('add-fund-form').style.display = type==='add' ? 'block' : 'none';
      document.getElementById('withdraw-form').style.display = type==='with' ? 'block' : 'none';
      document.getElementById('wallet-modal-title').innerText = type==='add' ? 'ADD FUND' : 'REQUEST WITHDRAW';
    }

    window.setPkg = (amt) => { document.getElementById('manual-amt').value = amt; };

    // init deposit (shows pay modal or directly create payment doc)
    window.initWalletDeposit = () => {
      const amt = parseFloat(document.getElementById('manual-amt').value);
      if(!amt || amt < 10) return alert('Enter valid amount (Min ₹10)');
      // use initPayment with matchId "ADD_FUND" and pass amount
      initPayment("ADD_FUND", amt);
      document.getElementById('wallet-modal').style.display='none';
    };

    // initPayment(mid, amt) shows pay modal and sets state
    window.initPayment = (mid, amt) => {
      if(!currentSession) return openAuthModal('login');
      activeMatchId = mid;
      activeEntryFee = parseFloat(amt);
      document.getElementById('modal-amt').innerText = '₹' + activeEntryFee;
      document.getElementById('pay-modal').style.display='flex';
    };

    // processPayment: create payment doc with amount field reliably and ensure UTR uniqueness check
    window.processPayment = async () => {
      const utr = document.getElementById('utr-input').value.trim();
      const fileElem = document.getElementById('utr-file');
      const file = fileElem.files && fileElem.files[0];
      if(!utr || utr.length < 3) return alert('Enter UTR / Ref No');
      if(!file) return alert('Attach screenshot');
      if(!currentSession) return alert('Login first');

      try {
        // UTR uniqueness check (avoid duplicate use)
        const q = query(collection(db,"payments"), where("utr","==", utr));
        const snap = await getDocs(q);
        if(!snap.empty) return alert('This UTR is already used. If you think this is an error contact admin.');

        // upload screenshot - reuse Cloudinary helper from original (simple fetch)
        const ssUrl = await uploadToCloudinary(file);
        // create payment doc with amount (for ADD_FUND or match)
        const amount = (activeMatchId === "ADD_FUND") ? activeEntryFee : activeEntryFee;
        const p = {
          matchId: activeMatchId,
          amount: amount,
          utr: utr,
          ss: ssUrl,
          userId: currentSession.phone,
          userName: currentSession.name,
          type: activeMatchId === "ADD_FUND" ? 'add_fund' : 'match',
          status: 'pending',
          timestamp: Date.now()
        };
        await addDoc(collection(db,"payments"), p);
        alert('Payment submitted for verification. Admin will approve shortly.');
        document.getElementById('pay-modal').style.display='none';
      } catch(e){ alert(e.message || e); }
    };

    // Cloudinary helper (from original admin file)
    async function uploadToCloudinary(file){
      if(!file) return '';
      const fd = new FormData(); fd.append('file', file); fd.append('upload_preset','sql_admin'); fd.append('folder','sql_users');
      try {
        const res = await fetch('https://api.cloudinary.com/v1_1/debp1kjtm/image/upload', { method:'POST', body:fd });
        const data = await res.json();
        return data.secure_url || '';
      } catch(e){ console.error(e); return ''; }
    }

    // checkStatusRealtime: listen for payments by utr and perform single-source updates when admin approves
    // (client-side convenience — server should handle production)
    function checkStatusRealtime(mid, utr){
      const q = query(collection(db,"payments"), where("utr","==", utr));
      onSnapshot(q, async s => {
        s.forEach(async d => {
          const data = d.data();
          if(data.status === 'approved'){
            // If approved and not yet locally claimed, update local UI (but actual balance update must be performed by admin using transaction)
            const claimedKey = `dep_claim_${d.id}`;
            if(!localStorage.getItem(claimedKey)){
              // only reflect UI; actual DB update of user's balance should be done in admin approve transaction.
              localStorage.setItem(claimedKey, 'true');
              renderUI();
            }
          }
        });
      });
    }

    // --- PAY VIA WALLET (join match) ---
    window.payViaWallet = async () => {
      if(!currentSession) return openAuthModal('login');
      if(currentUserBal < activeEntryFee) return alert('Low Balance! Add fund.');
      if(!activeMatchId || activeMatchId === 'ADD_FUND') return alert('Invalid match for wallet pay');

      if(!confirm(`Join match using ₹${activeEntryFee} from wallet?`)) return;
      try {
        const userRef = doc(db,"users", currentSession.phone);
        // Transaction: deduct user balance, create payment record (status approved), increment match joined
        await runTransaction(db, async (tx) => {
          const uSnap = await tx.get(userRef);
          if(!uSnap.exists()) throw 'User not found';
          const bal = uSnap.data().balance || 0;
          if(bal < activeEntryFee) throw 'Insufficient balance';
          // deduct
          tx.update(userRef, { balance: increment(-activeEntryFee), totalLoss: increment(activeEntryFee) });
          // payment record
          const pRef = doc(collection(db,"payments"));
          tx.set(pRef, {
            matchId: activeMatchId,
            amount: activeEntryFee,
            utr: 'WALLET_PAY_' + Date.now(),
            ss: 'WALLET',
            userId: currentSession.phone,
            userName: currentSession.name,
            type: 'match',
            status: 'approved',
            timestamp: Date.now()
          });
          // increment matches.joined only if not already joined by this user for this match
          const matchRef = doc(db,"matches", activeMatchId);
          const mSnap = await tx.get(matchRef);
          const alreadyJoined = Array.isArray(mSnap.data().joinedUsers) && (mSnap.data().joinedUsers.includes(currentSession.phone));
          if(!alreadyJoined){
            tx.update(matchRef, { joined: increment(1), joinedUsers: arrayUnion(currentSession.phone) });
          }
        });
        alert('Joined using wallet!');
        renderUI();
      } catch(e){ alert(e.message || e); }
    };

    // --- SUBMIT WITHDRAWAL (user) ---
    window.submitWithdrawal = async () => {
      if(!currentSession) return openAuthModal('login');
      const amt = parseFloat(document.getElementById('with-amt').value);
      const upi = document.getElementById('with-upi').value.trim();
      if(!amt || amt < 50) return alert('Minimum withdrawal ₹50');
      if(!upi) return alert('Enter UPI ID');
      if(amt > currentUserBal) return alert('Insufficient balance');

      // create withdraw request (admin must approve)
      await addDoc(collection(db,"withdrawals"), {
        userId: currentSession.phone,
        userName: currentSession.name,
        amount: amt,
        upi: upi,
        status: 'pending',
        timestamp: Date.now()
      });
      alert('Withdrawal request submitted. Admin will process.');
      document.getElementById('wallet-modal').style.display='none';
    };

    // --- HISTORY ---
    async function showFundHistory(){
      if(!currentSession) return openAuthModal('login');
      const q = query(collection(db,"payments"), where("userId","==", currentSession.phone));
      const snap = await getDocs(q);
      const list = []; snap.forEach(d=> list.push(d.data()));
      let msg = 'Fund History:\\n';
      list.filter(x=>x.type==='add_fund').sort((a,b)=>b.timestamp-a.timestamp).forEach(p=> msg += `₹${p.amount} | ${p.status} | ${new Date(p.timestamp).toLocaleString()}\\n`);
      alert(msg || 'No fund history');
    }
    async function showWithdrawHistory(){
      if(!currentSession) return openAuthModal('login');
      const q = query(collection(db,"withdrawals"), where("userId","==", currentSession.phone));
      const snap = await getDocs(q);
      let msg = 'Withdraw History:\\n';
      snap.forEach(d=>{ const r=d.data(); msg += `₹${r.amount} | ${r.status} | ${new Date(r.timestamp).toLocaleString()}\\n` });
      alert(msg || 'No withdraw history');
    }

    // -------------------------
    // ADMIN: Approve / Reject Payments & Withdrawals (Transactions to avoid double-credit)
    // -------------------------
    // Render admin dashboard (simple)
    function renderAdminDashboard(container){
      if(!isAdmin){ container.innerHTML = `<div class="card">Admin only. Please login as admin.</div>`; return; }
      container.innerHTML = '';
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `<h3 style="margin:0 0 8px 0">ADMIN DASHBOARD</h3>
        <div style="display:flex;gap:8px"><button class="small" onclick="renderManageMatches()">Manage Matches</button><button class="small" onclick="renderPayments('pending')">Payments</button><button class="small" onclick="renderWithdrawals()">Withdrawals</button><button class="small" onclick="renderUsers()">Users</button><button class="small" onclick="renderResultsUpload()">Upload Result</button></div>
        <div id="admin-content" style="margin-top:12px"></div>`;
      container.appendChild(card);
    }

    // Manage Matches
    function renderManageMatches(){
      const ac = document.getElementById('admin-content'); ac.innerHTML = 'Loading...';
      onSnapshot(collection(db,"matches"), snap => {
        ac.innerHTML = '';
        snap.forEach(d => {
          const m = d.data(); const id = d.id;
          const el = document.createElement('div'); el.className='card'; el.style.marginBottom='8px';
          el.innerHTML = `<div style="display:flex;justify-content:space-between"><div><b>ID: ${id}</b></div><div><button class="small" onclick="deleteDoc('matches','${id}')">DELETE</button></div></div>
                          <div style="margin-top:8px">
                            Map: <input id="map-${id}" value="${m.map||''}"> Entry: <input id="fee-${id}" value="${m.entry||0}" style="width:80px">
                            Joined: <input id="joined-${id}" value="${m.joined||0}" style="width:80px">
                            <button class="small" onclick="updateMatch('${id}')">SAVE</button>
                          </div>`;
          ac.appendChild(el);
        });
      });
    }

    async function updateMatch(id){
      try{
        const data = {
          map: document.getElementById(`map-${id}`).value,
          entry: Number(document.getElementById(`fee-${id}`).value),
          joined: Number(document.getElementById(`joined-${id}`).value)
        };
        await updateDoc(doc(db,"matches",id), data);
        alert('Match updated');
      } catch(e){ alert(e.message || e); }
    }
    async function deleteDoc(col, id){ if(confirm('Delete?')) await deleteDocFn(col,id); }
    async function deleteDocFn(col,id){ await deleteDoc(doc(db,col,id)); alert('Deleted'); }

    // Render payments (pending / addfund / history)
    function renderPayments(filter='pending'){
      const ac = document.getElementById('admin-content'); ac.innerHTML = 'Loading payments...';
      onSnapshot(collection(db,"payments"), snap => {
        ac.innerHTML = '';
        snap.forEach(d => {
          const p = d.data(); const pid = d.id;
          let show=false;
          if(filter==='pending' && p.status==='pending' && (!p.type || p.type==='match')) show=true;
          if(filter==='add_fund' && p.status==='pending' && p.type==='add_fund') show=true;
          if(filter==='history' && p.status!=='pending') show=true;
          if(!show) return;
          const el = document.createElement('div'); el.className='card'; el.style.marginBottom='8px';
          el.innerHTML = `<div style="display:flex;justify-content:space-between"><div><b>${(p.type||'match').toUpperCase()}</b> • ₹${p.amount||0}</div>
                          <div><button class="small" onclick="deleteDocFn('payments','${pid}')">DEL</button></div></div>
                          <div style="margin-top:6px;color:var(--muted)">User: ${p.userName} (${p.userId}) • UTR: ${p.utr} • ${new Date(p.timestamp||0).toLocaleString()}</div>
                          <div style="margin-top:8px">${p.status==='pending'? `<button class="small" onclick="approvePayment('${pid}')">APPROVE</button><button class="small" onclick="rejectPayment('${pid}')">REJECT</button>`: `<span style="color:var(--muted)">STATUS: ${p.status}</span>`}</div>`;
          ac.appendChild(el);
        });
      });
    }

    // Approve payment: atomic transaction to avoid double credits
    async function approvePayment(pid){
      if(!confirm('Approve this payment?')) return;
      const pRef = doc(db,"payments",pid);
      try{
        await runTransaction(db, async tx => {
          const pSnap = await tx.get(pRef);
          if(!pSnap.exists()) throw 'Payment not found';
          const p = pSnap.data();
          if(p.status !== 'pending') throw 'Already processed';
          // If add_fund: credit user by p.amount
          const userRef = doc(db,"users", p.userId);
          const userSnap = await tx.get(userRef);
          if(!userSnap.exists()) throw 'User not found';
          if(p.type === 'add_fund'){
            tx.update(userRef, { balance: increment(Number(p.amount || 0)) });
            tx.update(pRef, { status: 'approved' });
          } else if(p.type === 'match' || !p.type){
            // For match payment (manual UPI), mark approved and increment matches.joined safely
            tx.update(pRef, { status: 'approved' });
            if(p.matchId){
              const matchRef = doc(db,"matches", p.matchId);
              const mSnap = await tx.get(matchRef);
              if(mSnap.exists()){
                // avoid duplicate increment: check if payment doc id already in match.approvedPayments
                const already = Array.isArray(mSnap.data().approvedPayments) && mSnap.data().approvedPayments.includes(pid);
                if(!already){
                  tx.update(matchRef, { joined: increment(1), approvedPayments: arrayUnion(pid), approvedUtrs: arrayUnion(p.utr) });
                }
              }
            }
          }
        });
        alert('Payment approved successfully');
      } catch(e){ alert(e.message || e); }
    }

    async function rejectPayment(pid){
      if(!confirm('Reject this payment?')) return;
      await updateDoc(doc(db,"payments",pid), { status:'rejected' });
      alert('Rejected');
    }

    // Render withdrawals for admin
    function renderWithdrawals(){
      const ac = document.getElementById('admin-content'); ac.innerHTML = 'Loading withdrawals...';
      onSnapshot(collection(db,"withdrawals"), snap => {
        ac.innerHTML = '';
        snap.forEach(d=> {
          const r = d.data(); const id = d.id;
          if(r.status !== 'pending') return;
          const el = document.createElement('div'); el.className='card'; el.style.marginBottom='8px';
          el.innerHTML = `<div style="display:flex;justify-content:space-between"><div><b>${r.userName}</b> • ₹${r.amount}</div><div><button class="small" onclick="approveWithdrawal('${id}')">APPROVE</button><button class="small" onclick="rejectWithdrawal('${id}')">REJECT</button></div></div>
                          <div style="margin-top:8px;color:var(--muted)">UPI: ${r.upi} • ${new Date(r.timestamp||0).toLocaleString()}</div>`;
          ac.appendChild(el);
        });
      });
    }

    // Approve withdrawal: deduct balance atomically
    async function approveWithdrawal(id){
      if(!confirm('Approve withdrawal and deduct user balance?')) return;
      const wRef = doc(db,"withdrawals",id);
      try{
        await runTransaction(db, async tx => {
          const wSnap = await tx.get(wRef);
          if(!wSnap.exists()) throw 'Withdraw request not found';
          const w = wSnap.data();
          if(w.status !== 'pending') throw 'Already processed';
          const userRef = doc(db,"users", w.userId);
          const uSnap = await tx.get(userRef);
          if(!uSnap.exists()) throw 'User not found';
          const bal = uSnap.data().balance || 0;
          if(bal < w.amount) throw 'Insufficient balance';
          tx.update(userRef, { balance: increment(-Number(w.amount)) });
          tx.update(wRef, { status:'approved', processedAt: Date.now(), processedBy: adminId || 'admin' });
        });
        alert('Withdrawal approved and user balance deducted');
      } catch(e){ alert(e.message || e); }
    }

    async function rejectWithdrawal(id){
      if(!confirm('Reject withdrawal?')) return;
      await updateDoc(doc(db,"withdrawals",id), { status:'rejected' });
      alert('Rejected');
    }

    // USERS view for admin
    async function renderUsers(){
      const ac = document.getElementById('admin-content'); ac.innerHTML = 'Loading users...';
      const snap = await getDocs(collection(db,"users"));
      ac.innerHTML = '';
      snap.forEach(d => {
        const u = d.data(); const id = d.id;
        const el = document.createElement('div'); el.className='card'; el.style.marginBottom='8px';
        el.innerHTML = `<div style="display:flex;justify-content:space-between"><div><b>${u.name}</b> (${id})</div><div>₹${(u.balance||0).toFixed(2)}</div></div>
                        <div style="margin-top:8px"><button class="small" onclick="openUserEdit('${id}')">EDIT</button></div>`;
        ac.appendChild(el);
      });
    }

    // open user edit modal (quick)
    async function openUserEdit(id){
      const uref = doc(db,"users",id);
      const snap = await getDoc(uref);
      if(!snap.exists()) return alert('User not found');
      const u = snap.data();
      const newBal = prompt('Set new balance', u.balance || 0);
      if(newBal===null) return;
      await updateDoc(uref, { balance: Number(newBal) });
      alert('User balance updated');
    }

    // RESULTS upload UI
    function renderResultsUpload(){
      const ac = document.getElementById('admin-content'); ac.innerHTML = '';
      const el = document.createElement('div'); el.className='card';
      el.innerHTML = `<h4>Upload Result</h4>
        <div>Match ID: <input id="res-matchid" style="width:100%"></div>
        <div>Winner Name: <input id="res-winner" style="width:100%"></div>
        <div>Winner Phone: <input id="res-phone" style="width:100%"></div>
        <div>Prize (₹): <input id="res-prize" type="number" style="width:100%"></div>
        <div>Result Image: <input id="res-ss" type="file" accept="image/*"></div>
        <div style="margin-top:8px"><button class="small" onclick="uploadResult()">PUBLISH</button></div>`;
      ac.appendChild(el);
    }

    // Upload result and atomic payout (mark paidTo to avoid double)
    async function uploadResult(){
      const f = document.getElementById('res-ss').files[0];
      const winnerPhone = document.getElementById('res-phone').value.trim();
      const winnerName = document.getElementById('res-winner').value.trim();
      const prizeAmt = Number(document.getElementById('res-prize').value || 0);
      if(!f || !winnerPhone || !winnerName) return alert('Fill required');
      try{
        const img = await uploadToCloudinary(f);
        const resRef = await addDoc(collection(db,"results"), {
          matchId: document.getElementById('res-matchid').value || '',
          winnerName, winnerPhone, winningAmount: prizeAmt, image: img, timestamp: Date.now(), paidTo: []
        });
        // auto-credit via transaction: update user and add paidTo
        const resultRef = doc(db,"results", resRef.id);
        const userRef = doc(db,"users", winnerPhone);
        await runTransaction(db, async tx=>{
          const rSnap = await tx.get(resultRef);
          const uSnap = await tx.get(userRef);
          if(!uSnap.exists()) return;
          const already = rSnap.exists() && Array.isArray(rSnap.data().paidTo) && rSnap.data().paidTo.includes(winnerPhone);
          if(!already){
            tx.update(userRef, { balance: increment(prizeAmt), totalProfit: increment(prizeAmt) });
            tx.update(resultRef, { paidTo: arrayUnion(winnerPhone) });
          }
        });
        alert('Result published and user credited (if not already paid).');
      } catch(e){ alert(e.message || e); }
    }

    // Toggle admin panel quick
    function toggleAdminPanel(){
      const el = document.getElementById('admin-area');
      if(el.style.display==='none' || el.style.display==='') el.style.display='block'; else el.style.display='none';
      renderAdminDashboard(el);
    }

    // Helper: deleteDoc wrapper exposed earlier
    window.deleteDocFn = deleteDocFn;
    // Expose some functions to window so inline buttons work
    window.openAuthModal = openAuthModal;
    window.openWalletModal = openWalletModal;
    window.initWalletDeposit = initWalletDeposit;
    window.initPayment = initPayment;
    window.processPayment = processPayment;
    window.payViaWallet = payViaWallet;
    window.submitWithdrawal = submitWithdrawal;
    window.showFundHistory = showFundHistory;
    window.showWithdrawHistory = showWithdrawHistory;
    window.renderPayments = renderPayments;
    window.renderManageMatches = renderManageMatches;
    window.renderWithdrawals = renderWithdrawals;
    window.renderUsers = renderUsers;
    window.renderResultsUpload = renderResultsUpload;
    window.uploadResult = uploadResult;
    window.checkStatusRealtime = checkStatusRealtime;
    window.openAdminLogin = openAdminLogin;

    // Make sure initial tab is shown
    switchTab('live');

    // Load initial session if persisted
    (function loadPersist(){ const s = loadSession(); if(s){ currentSession = s; startWalletSync(s.phone); } })();

    // --- Notes / references ---
    // This merged file is based on the original user and admin files you uploaded.
    // Key fixes implemented:
    // - All payments include `amount` field; no parseFloat(matchId.split...).
    // - Admin approve uses runTransaction to update user balance & payment status atomically.
    // - Wallet join uses runTransaction to deduct balance and increment match joined safely and record joinedUsers.
    // - Withdrawal approval deducts user balance in a transaction.
    // - Result upload credits winner atomically and uses `paidTo` array to avoid double payout.
    // - Passwords stored as SHA-256 hash in `users.passwordHash` instead of plain text.
    // - UTR uniqueness enforced before creating payment doc.
    // For original code pointers (for traceability) see the files you uploaded (user + admin). 2 3

  </script>
</body>
</html>

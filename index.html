<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Free Fire Tournament</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>
        /* CSS Variables & Reset */
        :root {
            --primary: #00ff88; /* Green for Admin Data */
            --gold: #ffd700;
            --bg: #050505;
            --card-bg: #111;
            --text-muted: #aaa;
            --danger: #ff4444;
        }
        body { margin: 0; background: var(--bg); color: #fff; font-family: 'Segoe UI', Arial, sans-serif; overflow-x: hidden; }
        
        /* Header & Menu */
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: #000; border-bottom: 2px solid var(--gold); position: sticky; top: 0; z-index: 100; }
        header h1 { color: var(--gold); margin: 0; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; }
        .menu-btn { font-size: 1.5rem; color: var(--gold); cursor: pointer; }

        /* Side Menu (Drawer) */
        #side-menu {
            position: fixed; top: 0; right: -100%; width: 280px; height: 100%;
            background: #0a0a0a; border-left: 2px solid var(--gold);
            transition: 0.3s ease; z-index: 200; padding-top: 60px;
            box-shadow: -5px 0 15px rgba(0,0,0,0.8);
        }
        #side-menu.active { right: 0; }
        .close-btn { position: absolute; top: 15px; left: 20px; font-size: 1.5rem; color: #fff; cursor: pointer; }
        
        .menu-item { display: flex; align-items: center; padding: 15px 25px; color: #fff; text-decoration: none; border-bottom: 1px solid #222; transition: 0.2s; }
        .menu-item:hover { background: #222; color: var(--gold); }
        .menu-item i { width: 30px; color: var(--primary); }
        .menu-item.logout { color: var(--danger); }

        /* Main Content */
        #matches { padding: 15px; max-width: 600px; margin: 0 auto; padding-bottom: 80px; }

        /* Match Card Design */
        .card {
            background: var(--card-bg); border: 1px solid #333; border-radius: 15px;
            margin-bottom: 20px; overflow: hidden; position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .card-header {
            background: #1a1a1a; padding: 10px 15px; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
        }
        .match-id { color: #777; font-size: 0.8rem; }
        .status-badge { font-size: 0.8rem; padding: 3px 8px; border-radius: 5px; text-transform: uppercase; font-weight: bold; }
        .status-open { color: #000; background: var(--primary); }
        .status-full { color: #fff; background: var(--danger); }

        .card-body { display: flex; padding: 15px; gap: 10px; }
        
        /* Left Side (Data) */
        .left-info { flex: 1; border-right: 1px solid #333; padding-right: 10px; }
        .info-row { margin-bottom: 8px; font-size: 0.9rem; color: #ccc; }
        .info-row span { color: var(--primary); font-weight: bold; float: right; } /* Admin Data in Green */

        /* Right Side (Actions) */
        .right-action { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        
        .timer { font-size: 1.1rem; color: var(--gold); font-weight: bold; margin-bottom: 5px; }
        .timer small { display: block; font-size: 0.7rem; color: #777; font-weight: normal; }

        .slots-bar { width: 100%; height: 6px; background: #333; border-radius: 3px; margin: 8px 0; overflow: hidden; }
        .slots-fill { height: 100%; background: var(--primary); width: 0%; transition: 0.5s; }
        .slots-text { font-size: 0.75rem; color: #aaa; margin-bottom: 8px; }

        /* Buttons */
        .join-btn {
            background: linear-gradient(45deg, var(--gold), #ffaa00);
            border: none; padding: 10px 20px; color: #000; font-weight: bold;
            border-radius: 20px; cursor: pointer; width: 100%;
            box-shadow: 0 4px 10px rgba(255, 215, 0, 0.3); animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        .join-btn:disabled { background: #444; color: #888; cursor: not-allowed; animation: none; box-shadow: none; }

        /* Room ID Box */
        .room-box {
            background: rgba(0, 255, 136, 0.1); border: 1px solid var(--primary);
            padding: 10px; border-radius: 10px; width: 100%; margin-top: 10px;
        }
        .room-box p { margin: 2px 0; font-size: 0.9rem; color: var(--primary); word-break: break-all; }
        .pending-box { color: var(--gold); font-size: 0.85rem; border: 1px dashed var(--gold); padding: 8px; border-radius: 8px; width: 100%; }

        /* Payment Modal */
        #pay-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 300;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .pay-content {
            background: #151515; border: 2px solid var(--gold); padding: 25px;
            border-radius: 20px; width: 90%; max-width: 350px; text-align: center;
        }
        .pay-content h2 { color: var(--gold); margin-top: 0; }
        .pay-qr-placeholder { background: #fff; width: 150px; height: 150px; margin: 10px auto; display: flex; align-items: center; justify-content: center; color: #000; font-weight: bold; }
        
        input { width: 90%; padding: 12px; margin: 15px 0; background: #000; border: 1px solid #444; color: var(--primary); border-radius: 8px; text-align: center; outline: none; }
        input:focus { border-color: var(--primary); }

        .submit-btn { background: var(--primary); color: #000; width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; margin-bottom: 10px; }
        .cancel-btn { background: transparent; color: #aaa; border: none; cursor: pointer; text-decoration: underline; }

        /* Footer & Translate */
        #google_translate_element { position: fixed; bottom: 50px; right: 10px; z-index: 90; opacity: 0.8; }
        footer { text-align: center; color: #555; padding: 20px; font-size: 0.8rem; border-top: 1px solid #222; margin-top: 20px; }

    </style>
</head>

<body>

    <header>
        <h1>FF TOURNAMENT</h1>
        <div class="menu-btn" onclick="toggleMenu()"><i class="fas fa-bars"></i></div>
    </header>

    <div id="side-menu">
        <div class="close-btn" onclick="toggleMenu()">&times;</div>
        
        <div id="auth-section">
            </div>

        <a href="#" onclick="location.reload()" class="menu-item">
            <i class="fas fa-home"></i> Home
        </a>
        <a href="#" onclick="showPolicy()" class="menu-item">
            <i class="fas fa-shield-alt"></i> Policy & Risks
        </a>
        <a href="https://wa.me/919012277862" target="_blank" class="menu-item">
            <i class="fab fa-whatsapp"></i> WhatsApp Help
        </a>
        
        <div style="padding: 20px; color: #666; font-size: 0.8rem; line-height: 1.4;">
            <p><strong>Language Support:</strong><br>Use the button below to translate.</p>
        </div>
    </div>

    <div id="matches">
        <p style="text-align:center; color:#555;">Loading Tournaments...</p>
    </div>

    <div id="pay-modal">
        <div class="pay-content">
            <h2><i class="fas fa-wallet"></i> Complete Payment</h2>
            <p style="color:#ccc;">Pay Amount: <span id="pay-amount" style="color:var(--gold); font-weight:bold;">₹0</span></p>
            
            <div class="pay-qr-placeholder">
                QR CODE HERE<br>(UPI)
            </div>
            
            <p style="font-size:0.8rem; color:#aaa;">Pay via GPay/PhonePe & Enter UTR</p>
            <input type="text" id="utr-input" placeholder="Enter 12-digit UTR Number" />
            
            <button class="submit-btn" onclick="submitPayment()">VERIFY & JOIN</button>
            <button class="cancel-btn" onclick="closePay()">Cancel Transaction</button>
        </div>
    </div>

    <footer>
        <p>© 2026 SQL Gaming - Premium eSports</p>
        <div id="google_translate_element"></div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getFirestore, collection, onSnapshot, addDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBvObxADcAior6R_or9O6UmWsFT8do1GkI",
            authDomain: "sqladmin-ff04d.firebaseapp.com",
            projectId: "sqladmin-ff04d",
            storageBucket: "sqladmin-ff04d.firebasestorage.app",
            messagingSenderId: "539086978850",
            appId: "1:539086978850:web:261e6a0cf3c9a2aa29ef7b",
            measurementId: "G-KH4J0CZ9M5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let userPayments = {}; // Stores payment status for each matchId

        // --- AUTH LOGIC ---
        const authSection = document.getElementById('auth-section');

        function updateAuthUI(user) {
            if (user) {
                currentUser = user;
                authSection.innerHTML = `
                    <div style="padding:20px; text-align:center;">
                        <img src="${user.photoURL}" style="width:50px;border-radius:50%;border:2px solid gold;">
                        <p style="margin:5px 0;">${user.displayName}</p>
                        <button onclick="window.logoutUser()" class="menu-item logout" style="background:none;border:none;width:100%;justify-content:center;">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                `;
                loadUserPayments(); // Load payments when user logs in
            } else {
                currentUser = null;
                userPayments = {};
                authSection.innerHTML = `
                    <button onclick="window.loginUser()" class="menu-item" style="background:none;border:none;width:100%;cursor:pointer;">
                        <i class="fas fa-sign-in-alt"></i> Login with Google
                    </button>
                `;
                renderMatches([]); // Re-render to show "Join" buttons
            }
        }

        onAuthStateChanged(auth, (user) => {
            updateAuthUI(user);
        });

        window.loginUser = () => {
            signInWithPopup(auth, provider).catch((error) => alert("Login Failed: " + error.message));
        };
        window.logoutUser = () => {
            signOut(auth).then(() => {
                alert("Logged out successfully");
                toggleMenu();
            });
        };

        // --- DATA LOGIC ---
        
        // Listen to Matches
        let allMatches = [];
        onSnapshot(collection(db, "matches"), snap => {
            allMatches = [];
            snap.forEach(d => {
                allMatches.push({ id: d.id, ...d.data() });
            });
            renderMatches();
        });

        // Listen to User Payments (Real-time Status Updates)
        function loadUserPayments() {
            if(!currentUser) return;
            const q = query(collection(db, "payments"), where("userId", "==", currentUser.uid));
            onSnapshot(q, (snap) => {
                userPayments = {};
                snap.forEach(doc => {
                    const data = doc.data();
                    // Store status by matchId
                    userPayments[data.matchId] = {
                        status: data.status, // 'pending' or 'approved'
                        roomId: data.roomId || "Wait...",
                        password: data.password || "Wait..."
                    };
                });
                renderMatches(); // Re-render matches with new status
            });
        }

        // Timer Logic
        setInterval(() => {
            allMatches.forEach(m => {
                const timerEl = document.getElementById(`timer-${m.id}`);
                if (timerEl && m.startTime) {
                    const now = new Date().getTime();
                    // Convert admin string time or timestamp to JS Date. 
                    // Assumed admin saves as timestamp or ISO string.
                    // For demo stability, assuming m.startTime is a future timestamp number.
                    // If you manage time manually, parse it here.
                    const distance = m.startTime - now;
                    
                    if (distance < 0) {
                        timerEl.innerHTML = "LIVE";
                        timerEl.style.color = "red";
                    } else {
                        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                        timerEl.innerHTML = `${minutes}m ${seconds}s`;
                    }
                }
            });
        }, 1000);


        // --- RENDER UI ---
        function renderMatches() {
            const box = document.getElementById('matches');
            box.innerHTML = "";
            
            allMatches.forEach(m => {
                // Calculate Slots
                const totalSlots = m.totalSlots || 48;
                const joinedCount = m.joinedCount || 0; // Update this from admin panel
                const fillPercent = (joinedCount / totalSlots) * 100;
                
                // Determine Button/Status State
                let actionHTML = '';
                
                if (!currentUser) {
                    actionHTML = `<button class="join-btn" onclick="alert('Please Login First from Menu!')">LOGIN TO JOIN</button>`;
                } else {
                    const payment = userPayments[m.id];
                    
                    if (payment) {
                        // User has paid
                        if (payment.status === 'approved') {
                            // Approved: Show Room ID (Using admin panel data via payments logic if linked, or direct match data if generic)
                            // Here assuming Admin updates the specific Payment Doc with RoomID or Match Doc has it.
                            // Let's use Match Doc generic RoomID for simplicity if approved.
                            const rId = m.roomId || "Coming Soon";
                            const rPass = m.password || "Wait";
                            actionHTML = `
                                <div class="room-box">
                                    <p>ID: ${rId}</p>
                                    <p>Pass: ${rPass}</p>
                                </div>`;
                        } else {
                            // Pending
                            actionHTML = `<div class="pending-box"><i class="fas fa-clock"></i> Verification Pending</div>`;
                        }
                    } else {
                        // User hasn't paid
                        if(m.status === 'open') {
                             actionHTML = `<button class="join-btn" onclick="openPay('${m.id}', ${m.entry})">JOIN ₹${m.entry}</button>`;
                        } else {
                             actionHTML = `<button class="join-btn" disabled style="background:#333;">FULL / CLOSED</button>`;
                        }
                    }
                }

                box.innerHTML += `
                <div class="card">
                    <div class="card-header">
                        <span class="match-id">#${m.id.substring(0,6)}</span>
                        <span class="status-badge ${m.status === 'open' ? 'status-open' : 'status-full'}">${m.status}</span>
                    </div>
                    <div class="card-body">
                        <div class="left-info">
                            <div class="info-row">Map: <span>${m.map || 'Bermuda'}</span></div>
                            <div class="info-row">Type: <span>${m.type || 'Solo'}</span></div>
                            <div class="info-row">Entry: <span>₹${m.entry}</span></div>
                            <div class="info-row">Per Kill: <span>₹${m.kill || 0}</span></div>
                            <div class="info-row">Win: <span>₹${m.win}</span></div>
                        </div>

                        <div class="right-action">
                            <div class="timer" id="timer-${m.id}">
                                Loading...
                                <small>Starts In</small>
                            </div>
                            
                            <div class="slots-bar">
                                <div class="slots-fill" style="width: ${fillPercent}%"></div>
                            </div>
                            <div class="slots-text">${joinedCount}/${totalSlots} Joined</div>
                            
                            ${actionHTML}
                        </div>
                    </div>
                </div>`;
            });
        }

        // --- PAYMENT LOGIC ---
        let currentMatchId = null;

        window.openPay = (mid, amount) => {
            currentMatchId = mid;
            document.getElementById('pay-amount').innerText = "₹" + amount;
            document.getElementById('pay-modal').style.display = 'flex';
        };

        window.closePay = () => {
            document.getElementById('pay-modal').style.display = 'none';
            document.getElementById('utr-input').value = "";
        };

        window.submitPayment = async () => {
            const utr = document.getElementById('utr-input').value;
            if (!utr || utr.length < 8) return alert("Please enter valid UTR/Reference No.");
            
            try {
                await addDoc(collection(db, 'payments'), {
                    matchId: currentMatchId,
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    utr: utr,
                    amount: document.getElementById('pay-amount').innerText,
                    status: 'pending', // Needs admin approval
                    timestamp: Date.now()
                });
                
                alert("Payment Submitted! Wait for Admin Approval.");
                closePay();
                // Logic automatically updates because of onSnapshot in loadUserPayments
            } catch (e) {
                alert("Error: " + e.message);
            }
        };

        // --- MENU & POLICY ---
        window.toggleMenu = () => {
            document.getElementById('side-menu').classList.toggle('active');
        };

        window.showPolicy = () => {
            alert(`⚠️ चेतावनी: इस गेम में वित्तीय जोखिम शामिल है और इसकी आदत लग सकती है। कृपया जिम्मेदारी से और अपने जोखिम पर खेलें।\n\nRefund Policy: मैच शुरू होने से 20 मिनट पहले रिफंड उपलब्ध है। उसके बाद कोई रिफंड नहीं दिया जाएगा।`);
        };

    </script>
    
    <script type="text/javascript">
        function googleTranslateElementInit() {
          new google.translate.TranslateElement({pageLanguage: 'en'}, 'google_translate_element');
        }
    </script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

</body>
</html>

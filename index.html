<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>SQL TOURNAMENT PRO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root { --accent: #00ff88; --gold: #ffd700; --bg: #050505; --card: #121212; --border: #222; --red: #ff4444; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: 'Poppins', sans-serif; overflow-x: hidden; }
        .allow-select { user-select: text !important; }

        /* Centered Header */
        header { 
            background: #000; padding: 15px; border-bottom: 2px solid var(--gold);
            text-align: center; position: sticky; top: 0; z-index: 1000;
        }
        .header-title { color: var(--gold); font-weight: 800; font-size: 0.9rem; margin: 0; letter-spacing: 0.5px; text-transform: uppercase; }
        .header-sub { color: var(--accent); font-size: 0.65rem; display: block; margin-top: 2px; }
        .menu-btn { position: absolute; right: 20px; top: 18px; color: var(--gold); font-size: 1.4rem; cursor: pointer; }

        /* Navigation Tabs */
        .tabs { display: flex; margin: 15px; background: #111; border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
        .tab { flex: 1; padding: 12px; border: none; background: none; color: #666; font-weight: 700; font-size: 0.8rem; cursor: pointer; transition: 0.3s; }
        .tab.active { background: var(--accent); color: #000; }

        /* Match Card Design */
        .card { background: var(--card); border-radius: 18px; margin: 15px; border: 1px solid var(--border); overflow: hidden; position: relative; }
        .m-tag { position: absolute; top: 12px; right: 15px; font-size: 0.6rem; background: #222; padding: 3px 8px; border-radius: 5px; color: var(--accent); font-weight: 800; }
        
        .card-body { padding: 18px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .item { display: flex; align-items: center; gap: 10px; }
        .item i { color: var(--gold); font-size: 0.9rem; width: 15px; }
        .item div span { display: block; font-size: 0.6rem; color: #666; text-transform: uppercase; }
        .item div b { font-size: 0.85rem; color: #fff; }

        .timer-box { background: #0c0c0c; padding: 12px; text-align: center; border-top: 1px solid #1a1a1a; border-bottom: 1px solid #1a1a1a; }
        .timer-label { font-size: 0.6rem; color: #555; display: block; margin-bottom: 2px; }
        .countdown { font-family: monospace; font-size: 1.3rem; color: var(--gold); font-weight: 900; }

        .card-footer { padding: 15px; }
        .slots { display: flex; justify-content: space-between; font-size: 0.7rem; margin-bottom: 8px; font-weight: 700; }
        .bar { height: 8px; background: #222; border-radius: 10px; overflow: hidden; margin-bottom: 15px; }
        .fill { height: 100%; background: var(--accent); transition: 1s ease; }

        .btn-main { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 900; font-size: 0.9rem; cursor: pointer; transition: 0.2s; }
        .btn-join { background: var(--accent); color: #000; box-shadow: 0 4px 15px rgba(0,255,136,0.2); }
        .btn-dis { background: #222; color: #555; cursor: not-allowed; }

        /* Security: Room Details Styling */
        .room-box { background: #001a0d; border: 1px dashed var(--accent); padding: 15px; border-radius: 12px; text-align: center; animation: fadeIn 0.5s; }
        .room-box h4 { margin: 0 0 10px; font-size: 0.75rem; color: var(--accent); letter-spacing: 1px; }
        .room-data { display: flex; justify-content: space-around; background: #000; padding: 10px; border-radius: 8px; }
        .room-data div span { display: block; font-size: 0.55rem; color: #666; }
        .room-data div b { font-size: 0.9rem; color: #fff; }

        /* Modal & Side Menu */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.97); z-index: 5000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-ui { background: #111; width: 100%; max-width: 380px; padding: 25px; border-radius: 20px; border: 1px solid var(--gold); text-align: center; }
        .pay-grid { display: grid; gap: 10px; margin: 20px 0; }
        .pay-opt { display: flex; align-items: center; gap: 12px; padding: 12px; background: #1a1a1a; border-radius: 12px; text-decoration: none; color: #fff; border: 1px solid #333; font-weight: 600; font-size: 0.85rem; }
        .pay-opt img { width: 25px; }

        #side-menu { position: fixed; top: 0; right: -100%; width: 280px; height: 100%; background: #000; z-index: 2000; transition: 0.4s; border-left: 2px solid var(--gold); padding: 25px; }
        #side-menu.active { right: 0; }
        .menu-link { display: flex; align-items: center; gap: 15px; padding: 18px; color: #fff; text-decoration: none; border-bottom: 1px solid #111; font-weight: 600; }
        .close-menu { color: var(--red); font-size: 2rem; text-align: right; cursor: pointer; margin-bottom: 20px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header>
        <p class="header-title">FREE FIRE DAILY TOURNAMENT LIVE</p>
        <span class="header-sub">JOIN PLAY & WIN REAL MONEY ðŸ’°</span>
        <div class="menu-btn" onclick="toggleMenu(true)"><i class="fas fa-bars-staggered"></i></div>
    </header>

    <div class="tabs">
        <button class="tab active" id="tab-live" onclick="switchTab('live')">LIVE MATCHES</button>
        <button class="tab" id="tab-my" onclick="switchTab('my')">MY HISTORY</button>
    </div>

    <div id="side-menu">
        <div class="close-menu" onclick="toggleMenu(false)">&times;</div>
        <a href="#" class="menu-link" onclick="location.reload()"><i class="fas fa-home"></i> Home</a>
        <a href="https://wa.me/919012277862" class="menu-link"><i class="fab fa-whatsapp"></i> WhatsApp Group</a>
        <a href="#" class="menu-link" onclick="alert('No Hacks Allowed!')"><i class="fas fa-shield-halved"></i> Rules & Policy</a>
    </div>

    <main id="app-content"></main>

    <div id="pay-modal" class="modal">
        <div class="modal-ui">
            <h3 style="color:var(--gold); margin:0;">CHECKOUT</h3>
            <h2 id="modal-amt" style="color:var(--accent); margin:10px 0;">â‚¹0</h2>
            <div class="pay-grid">
                <a id="g-link" href="#" class="pay-opt"><img src="https://img.icons8.com/color/48/google-pay.png"> Google Pay</a>
                <a id="p-link" href="#" class="pay-opt"><img src="https://img.icons8.com/color/48/phone-pe.png"> PhonePe</a>
                <a id="y-link" href="#" class="pay-opt"><img src="https://img.icons8.com/color/48/paytm.png"> Paytm / UPI</a>
            </div>
            <input type="text" id="utr-input" class="allow-select" placeholder="Enter 12 Digit UTR Number" style="width:100%; padding:14px; background:#000; border:1px solid #333; color:var(--accent); border-radius:12px; text-align:center; font-weight:800; margin-bottom:15px;">
            <button class="btn-main btn-join" id="submit-btn" onclick="processPayment()">SUBMIT TRANSACTION</button>
            <button onclick="closeModal()" style="background:none; border:none; color:var(--red); margin-top:15px; font-weight:bold; cursor:pointer;">CLOSE</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBvObxADcAior6R_or9O6UmWsFT8do1GkI",
            authDomain: "sqladmin-ff04d.firebaseapp.com",
            projectId: "sqladmin-ff04d",
            storageBucket: "sqladmin-ff04d.firebasestorage.app",
            messagingSenderId: "539086978850",
            appId: "1:539086978850:web:261e6a0cf3c9a2aa29ef7b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let activeTab = 'live';
        let activeMatchId = null;

        // --- Core Engine: User & Payment Persistence ---
        function renderUI() {
            onSnapshot(collection(db, "matches"), snap => {
                const container = document.getElementById('app-content');
                container.innerHTML = "";

                snap.forEach(doc => {
                    const m = doc.data();
                    const mid = doc.id;
                    const record = JSON.parse(localStorage.getItem(`pay_record_${mid}`));

                    if (activeTab === 'my' && !record) return;

                    const startTime = parseInt(m.startTime);
                    const isStarted = Date.now() >= startTime;
                    const isExpired = Date.now() > (startTime + 3600000); // 1 Hour Post-Start Expiry

                    let actionHtml = "";
                    
                    // Logic for showing Room ID or Buttons
                    if (record) {
                        if (record.status === 'approved' || m.approvedUtrs?.includes(record.utr)) {
                            if (isExpired) {
                                actionHtml = `<button class="btn-main btn-dis">MATCH EXPIRED</button>`;
                            } else {
                                actionHtml = `
                                <div class="room-box">
                                    <h4>âœ… JOINED SUCCESSFULLY</h4>
                                    <div class="room-data allow-select">
                                        <div><span>ROOM ID</span><b>${m.roomId || 'Wait...'}</b></div>
                                        <div><span>PASSWORD</span><b>${m.password || 'Wait...'}</b></div>
                                    </div>
                                </div>`;
                            }
                        } else if (record.status === 'rejected') {
                            actionHtml = `<button class="btn-main" style="background:var(--red); color:#fff;" disabled>PAYMENT REJECTED</button>`;
                        } else {
                            // Check Realtime for Approval
                            checkRealtimeApproval(mid, record.utr);
                            actionHtml = `<button class="btn-main btn-dis" style="color:var(--gold)">VERIFYING UTR: ${record.utr}</button>`;
                        }
                    } else if (isStarted) {
                        actionHtml = `<button class="btn-main btn-dis">MATCH STARTED</button>`;
                    } else if (m.joined >= m.total) {
                        actionHtml = `<button class="btn-main btn-dis">MATCH FULL</button>`;
                    } else {
                        actionHtml = `<button class="btn-main btn-join" onclick="openPayment('${mid}', ${m.entry})">JOIN NOW</button>`;
                    }

                    container.innerHTML += `
                    <div class="card">
                        <div class="m-tag">${m.map.toUpperCase()}</div>
                        <div class="card-body">
                            <div class="item"><i class="fas fa-gamepad"></i><div><span>Mode</span><b>${m.type}</b></div></div>
                            <div class="item"><i class="fas fa-trophy"></i><div><span>Win Prize</span><b>â‚¹${m.win}</b></div></div>
                            <div class="item"><i class="fas fa-wallet"></i><div><span>Entry Fee</span><b>â‚¹${m.entry}</b></div></div>
                            <div class="item"><i class="fas fa-id-badge"></i><div><span>Match ID</span><b>#${mid.slice(-4)}</b></div></div>
                        </div>
                        <div class="timer-box">
                            <span class="timer-label">MATCH STARTS IN</span>
                            <span class="countdown" data-time="${startTime}">--:--:--</span>
                        </div>
                        <div class="card-footer">
                            <div class="slots"><span>Filled</span><span>${m.joined}/${m.total}</span></div>
                            <div class="bar"><div class="fill" style="width:${(m.joined/m.total)*100}%"></div></div>
                            ${actionHtml}
                        </div>
                    </div>`;
                });
            });
        }

        // Realtime Status Sync
        function checkRealtimeApproval(mid, utr) {
            const q = query(collection(db, "payments"), where("matchId", "==", mid), where("utr", "==", utr));
            onSnapshot(q, (s) => {
                s.forEach(doc => {
                    const data = doc.data();
                    if(data.status === 'approved') {
                        const local = JSON.parse(localStorage.getItem(`pay_record_${mid}`));
                        local.status = 'approved';
                        localStorage.setItem(`pay_record_${mid}`, JSON.stringify(local));
                    }
                });
            });
        }

        // Timer Logic
        setInterval(() => {
            document.querySelectorAll('.countdown').forEach(el => {
                const target = parseInt(el.dataset.time);
                const diff = target - Date.now();
                if(diff <= 0) { el.innerText = "STARTED"; el.style.color = "var(--accent)"; }
                else {
                    const h = Math.floor(diff/3600000), m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000);
                    el.innerText = `${h}h : ${m}m : ${s}s`;
                }
            });
        }, 1000);

        window.switchTab = (t) => {
            activeTab = t;
            document.getElementById('tab-live').classList.toggle('active', t === 'live');
            document.getElementById('tab-my').classList.toggle('active', t === 'my');
            renderUI();
        };

        window.openPayment = (id, amt) => {
            activeMatchId = id;
            document.getElementById('modal-amt').innerText = "â‚¹" + amt;
            const upi = `upi://pay?pa=rizwanhasan90122778623@ybl&am=${amt}&cu=INR&tn=SQL_ARENA_${id}`;
            document.getElementById('g-link').href = upi;
            document.getElementById('p-link').href = upi;
            document.getElementById('y-link').href = upi;
            document.getElementById('pay-modal').style.display = 'flex';
        };

        window.processPayment = async () => {
            const utr = document.getElementById('utr-input').value;
            if(utr.length < 10) return alert("Enter valid 12 Digit UTR!");

            const btn = document.getElementById('submit-btn');
            btn.disabled = true; btn.innerText = "Processing...";

            const record = { utr: utr, matchId: activeMatchId, status: 'pending', date: new Date().toLocaleDateString() };
            localStorage.setItem(`pay_record_${activeMatchId}`, JSON.stringify(record));

            await addDoc(collection(db, "payments"), { ...record, timestamp: Date.now() });

            alert("UTR Submitted! Room Details will unlock once Admin approves.");
            closeModal();
        };

        window.closeModal = () => document.getElementById('pay-modal').style.display = 'none';
        window.toggleMenu = (s) => document.getElementById('side-menu').classList.toggle('active', s);

        renderUI();
    </script>
</body>
</html>

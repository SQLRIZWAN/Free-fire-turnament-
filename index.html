<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>SQL TOURNAMENT PRO - ULTIMATE PRODUCTION</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- DESIGN SYSTEM & VARIABLES --- */
        :root {
            --accent: #00ff88;
            --gold: #ffd700;
            --bg: #050505;
            --card: #121212;
            --border: #222;
            --red: #ff4444;
            --muted: #888;
            --waiting: #ffae00;
            --glass: rgba(20,20,20,0.95);
            --font-main: 'Poppins', sans-serif;
            --font-heading: 'Rajdhani', sans-serif;
        }

        /* --- GLOBAL RESET --- */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
            user-select: none;
        }

        body {
            background: var(--bg);
            color: #fff;
            font-family: var(--font-main);
            overflow-x: hidden;
            line-height: 1.6;
        }

        .allow-select, input, textarea, .room-data b {
            user-select: text !important;
        }

        /* --- LOADING OVERLAY --- */
        #global-loader {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #111;
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* --- HEADER & NAVIGATION --- */
        header {
            background: #000;
            padding: 15px 20px;
            border-bottom: 2px solid var(--gold);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 30px rgba(0,0,0,0.5);
        }

        .brand-box h1 {
            font-family: var(--font-heading);
            font-size: 1.2rem;
            color: var(--gold);
            letter-spacing: 1px;
        }

        .brand-box span {
            font-size: 0.65rem;
            color: var(--accent);
            font-weight: 600;
            text-transform: uppercase;
        }

        .menu-toggle {
            font-size: 1.5rem;
            color: var(--gold);
            cursor: pointer;
        }

        /* --- TAB NAVIGATION --- */
        .tab-wrapper {
            padding: 15px;
            background: #0a0a0a;
        }

        .tabs-container {
            display: flex;
            background: #151515;
            padding: 5px;
            border-radius: 12px;
            border: 1px solid #222;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: var(--muted);
            font-weight: 700;
            font-size: 0.8rem;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.3s;
        }

        .tab-btn.active {
            background: var(--accent);
            color: #000;
            box-shadow: 0 4px 15px rgba(0,255,136,0.3);
        }

        /* --- MATCH CARDS --- */
        #app-content {
            padding: 10px 15px 100px;
            max-width: 800px;
            margin: 0 auto;
        }

        .match-card {
            background: var(--card);
            border-radius: 20px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
            overflow: hidden;
            position: relative;
            animation: slideUp 0.5s ease;
        }

        .match-header {
            background: linear-gradient(90deg, #1a1a1a, #111);
            padding: 12px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .map-tag {
            background: var(--accent);
            color: #000;
            padding: 3px 10px;
            border-radius: 5px;
            font-size: 0.7rem;
            font-weight: 800;
        }

        .match-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 20px;
        }

        .grid-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .grid-item i {
            color: var(--gold);
            font-size: 1.1rem;
        }

        .grid-item .label {
            display: block;
            font-size: 0.6rem;
            color: var(--muted);
            text-transform: uppercase;
        }

        .grid-item .val {
            font-weight: 700;
            font-size: 0.9rem;
        }

        /* --- PROGRESS BAR --- */
        .slot-container {
            padding: 0 20px 15px;
        }

        .slot-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .progress-bg {
            height: 10px;
            background: #222;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #00cc6e);
            transition: width 1s ease-in-out;
        }

        /* --- BUTTONS --- */
        .action-area {
            padding: 15px 20px 20px;
            border-top: 1px solid #1a1a1a;
        }

        .btn-join {
            width: 100%;
            background: var(--accent);
            color: #000;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-weight: 800;
            font-size: 0.95rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0,255,136,0.2);
        }

        .btn-full { background: #333; color: #666; cursor: not-allowed; box-shadow: none; }

        /* --- ROOM DETAILS --- */
        .room-access-box {
            background: rgba(255, 215, 0, 0.05);
            border: 1px dashed var(--gold);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }

        .room-access-box h4 {
            color: var(--gold);
            font-size: 0.8rem;
            margin-bottom: 10px;
        }

        .room-data-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .room-field {
            background: #000;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #222;
        }

        .room-field span { font-size: 0.6rem; color: #555; display: block; }
        .room-field b { font-size: 1rem; color: #fff; font-family: monospace; }

        /* --- PROFILE SECTION --- */
        .profile-container {
            animation: fadeIn 0.5s ease;
        }

        .user-hero {
            background: linear-gradient(180deg, #151515, #050505);
            padding: 30px 20px;
            border-radius: 25px;
            text-align: center;
            border: 1px solid #222;
            margin-bottom: 25px;
        }

        .avatar-wrap {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 auto 15px;
        }

        .avatar-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--accent);
            padding: 3px;
        }

        .edit-avatar {
            position: absolute;
            bottom: 0;
            right: 0;
            background: var(--gold);
            color: #000;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            border: 2px solid #000;
        }

        .stat-card-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .stat-box {
            background: #0e0e0e;
            padding: 15px 5px;
            border-radius: 15px;
            border: 1px solid #1a1a1a;
        }

        .stat-box .title { font-size: 0.6rem; color: var(--muted); text-transform: uppercase; }
        .stat-box .value { font-size: 1.1rem; font-weight: 800; display: block; }

        /* --- MODAL SYSTEM --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(8px);
            z-index: 5000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-card {
            background: #111;
            width: 100%;
            max-width: 450px;
            border-radius: 25px;
            border: 1px solid var(--border);
            padding: 25px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: var(--muted);
            font-size: 1.5rem;
        }

        /* --- WALLET UI --- */
        .wallet-methods {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        .method-btn {
            background: #000;
            border: 1px solid #222;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            color: #fff;
            cursor: pointer;
        }

        .method-btn i { font-size: 1.5rem; color: var(--gold); margin-bottom: 8px; }
        .method-btn.active { border-color: var(--accent); background: rgba(0,255,136,0.05); }

        input[type="text"], input[type="number"], input[type="password"] {
            width: 100%;
            background: #000;
            border: 1px solid #333;
            color: #fff;
            padding: 14px;
            border-radius: 12px;
            margin-top: 10px;
            font-family: var(--font-main);
            outline: none;
        }

        input:focus { border-color: var(--accent); }

        /* --- SIDE MENU --- */
        #side-drawer {
            position: fixed;
            top: 0;
            right: -100%;
            width: 300px;
            height: 100%;
            background: #0a0a0a;
            z-index: 6000;
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        #side-drawer.open { right: 0; box-shadow: -10px 0 50px rgba(0,0,0,0.8); }

        .drawer-header {
            padding: 30px 20px;
            background: #000;
            text-align: center;
            border-bottom: 1px solid #222;
        }

        .drawer-links {
            flex: 1;
            padding: 15px;
        }

        .drawer-link {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            color: #ccc;
            text-decoration: none;
            border-bottom: 1px solid #151515;
            font-weight: 500;
        }

        .drawer-link i { width: 20px; color: var(--gold); }

        /* --- ANIMATIONS --- */
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- RESULT CARDS --- */
        .res-card {
            background: #111;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid #222;
            overflow: hidden;
        }

        .res-banner {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }

        .res-info {
            padding: 15px;
        }

        .winner-tag {
            color: var(--gold);
            font-weight: 800;
            font-size: 1.1rem;
        }

    </style>
</head>
<body>

<div id="global-loader">
    <div class="spinner"></div>
    <p style="margin-top: 15px; color: var(--accent); font-weight: 700; font-family: var(--font-heading);">LOADING SQL ENGINE...</p>
</div>

<header>
    <div class="brand-box">
        <h1>SQL TOURNAMENT PRO</h1>
        <span>Official Ultimate Build</span>
    </div>
    <div class="menu-toggle" onclick="toggleDrawer(true)">
        <i class="fas fa-bars-staggered"></i>
    </div>
</header>

<div class="tab-wrapper">
    <div class="tabs-container">
        <button class="tab-btn active" id="tab-live" onclick="app.switchTab('live')">MATCHES</button>
        <button class="tab-btn" id="tab-my" onclick="app.switchTab('my')">PROFILE</button>
        <button class="tab-btn" id="tab-result" onclick="app.switchTab('result')">RESULTS</button>
    </div>
</div>

<main id="app-content">
    </main>

<div id="side-drawer">
    <div class="drawer-header">
        <div style="font-size: 1.5rem; color: var(--red); cursor: pointer; position: absolute; top: 15px; right: 20px;" onclick="toggleDrawer(false)">&times;</div>
        <img id="drawer-dp" src="https://img.icons8.com/color/96/user-male-circle.png" style="width: 70px; border-radius: 50%; border: 2px solid var(--accent);">
        <h3 id="drawer-name" style="margin-top: 10px;">Guest User</h3>
        <p id="drawer-bal" style="color: var(--accent); font-weight: 800;">Bal: ‚Çπ0.00</p>
    </div>
    <div class="drawer-links">
        <a href="#" class="drawer-link" onclick="location.reload()"><i class="fas fa-home"></i> Home</a>
        <a href="#" class="drawer-link" onclick="app.openWalletModal('add'); toggleDrawer(false)"><i class="fas fa-wallet"></i> Add Money</a>
        <a href="#" class="drawer-link" onclick="app.openWalletModal('with'); toggleDrawer(false)"><i class="fas fa-money-bill-transfer"></i> Withdraw</a>
        <a href="https://chat.whatsapp.com/JR7wAllMf4SAyILFHDQClQ" class="drawer-link"><i class="fab fa-whatsapp"></i> Support Group</a>
        <a href="#" class="drawer-link" onclick="app.showPolicy(); toggleDrawer(false)"><i class="fas fa-shield-alt"></i> Fair Play Rules</a>
    </div>
    <div style="padding: 20px; border-top: 1px solid #1a1a1a;">
        <button id="auth-main-btn" onclick="app.openAuth()" class="btn-join">LOGIN / REGISTER</button>
        <button id="logout-main-btn" onclick="app.logout()" class="btn-join" style="background: #222; color: var(--red); display: none;">LOGOUT</button>
    </div>
</div>

<div id="modal-overlay" class="modal-overlay">
    <div class="modal-card" id="modal-content">
        </div>
</div>

<input type="file" id="p-file-input" style="display: none;" accept="image/*" onchange="app.handleAvatarUpload(this)">

<script type="module">
    // Cloudinary Engine Config
    const CLOUD_NAME = "debp1kjtm";
    const UPLOAD_PRESET = "sql_admin";

    // Firebase Core
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getFirestore, collection, onSnapshot, addDoc, query, where, 
        orderBy, limit, getDoc, doc, setDoc, updateDoc, increment, arrayUnion 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBvObxADcAior6R_or9O6UmWsFT8do1GkI",
        authDomain: "sqladmin-ff04d.firebaseapp.com",
        projectId: "sqladmin-ff04d",
        storageBucket: "sqladmin-ff04d.firebasestorage.app",
        messagingSenderId: "539086978850",
        appId: "1:539086978850:web:261e6a0cf3c9a2aa29ef7b"
    };

    const fbApp = initializeApp(firebaseConfig);
    const db = getFirestore(fbApp);

    // --- MEGA ENGINE OBJECT ---
    const app = {
        user: null,
        activeTab: 'live',
        matchUnsub: null,
        walletSync: null,

        init() {
            this.loadSession();
            this.switchTab('live');
            setTimeout(() => {
                document.getElementById('global-loader').style.display = 'none';
            }, 1500);
        },

        loadSession() {
            const saved = localStorage.getItem('sql_user_session');
            if(saved) {
                this.user = JSON.parse(saved);
                this.startWalletSync();
                this.updateUI();
            }
        },

        updateUI() {
            if(this.user) {
                document.getElementById('drawer-name').innerText = this.user.name;
                document.getElementById('drawer-bal').innerText = `Bal: ‚Çπ${(this.user.balance || 0).toFixed(2)}`;
                if(this.user.dpUrl) document.getElementById('drawer-dp').src = this.user.dpUrl;
                document.getElementById('auth-main-btn').style.display = 'none';
                document.getElementById('logout-main-btn').style.display = 'block';
            }
        },

        startWalletSync() {
            if(!this.user) return;
            if(this.walletSync) this.walletSync();
            this.walletSync = onSnapshot(doc(db, "users", this.user.phone), (docSnap) => {
                if(docSnap.exists()) {
                    this.user = { ...this.user, ...docSnap.data() };
                    localStorage.setItem('sql_user_session', JSON.stringify(this.user));
                    this.updateUI();
                    if(this.activeTab === 'my') this.renderProfile();
                }
            });
        },

        switchTab(tab) {
            this.activeTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            const cont = document.getElementById('app-content');
            cont.innerHTML = '<div class="loader"></div>';

            if(tab === 'live') this.renderMatches();
            else if(tab === 'my') this.renderProfile();
            else if(tab === 'result') this.renderResults();
        },

        // --- MATCH ENGINE ---
        renderMatches() {
            const cont = document.getElementById('app-content');
            if(this.matchUnsub) this.matchUnsub();

            const q = query(collection(db, "matches"), orderBy("startTime", "asc"));
            this.matchUnsub = onSnapshot(q, (snap) => {
                if(this.activeTab !== 'live') return;
                cont.innerHTML = "";
                
                if(snap.empty) {
                    cont.innerHTML = `<div style="text-align:center; padding:50px; color:#555;">No Matches Scheduled Today</div>`;
                    return;
                }

                snap.forEach(d => {
                    const m = d.data();
                    const isJoined = this.user && m.participants?.includes(this.user.phone);
                    const isFull = (m.joined || 0) >= (m.total || 48);
                    const progress = ((m.joined || 0) / (m.total || 48)) * 100;

                    let actionHtml = "";
                    if(isJoined) {
                        actionHtml = `
                            ${(m.roomId && m.roomId.length > 2) ? `
                                <div class="room-access-box">
                                    <h4>‚úÖ ROOM DETAILS RELEASED</h4>
                                    <div class="room-data-row">
                                        <div class="room-field"><span>Room ID</span><b>${m.roomId}</b></div>
                                        <div class="room-field"><span>Password</span><b>${m.password}</b></div>
                                    </div>
                                    <p style="font-size:0.6rem; margin-top:10px; color:var(--muted);">Join 5 minutes before match starts</p>
                                </div>
                            ` : `<div class="room-access-box"><h4>‚úÖ JOINED</h4><p style="font-size:0.7rem; color:#888;">ID/Pass will appear here 15 min before match.</p></div>`}
                            <button class="btn-join btn-full">ALREADY JOINED</button>
                        `;
                    } else if(isFull) {
                        actionHtml = `<button class="btn-join btn-full">MATCH FULL</button>`;
                    } else {
                        actionHtml = `<button class="btn-join" onclick="app.handleMatchJoin('${d.id}', ${m.entry})"><i class="fas fa-gamepad"></i> JOIN MATCH ‚Çπ${m.entry}</button>`;
                    }

                    cont.innerHTML += `
                        <div class="match-card">
                            <div class="match-header">
                                <span class="map-tag">${m.map || 'Bermuda'}</span>
                                <span style="font-weight: 800; font-size: 0.8rem; color: var(--gold);">${m.type || 'SOLO'}</span>
                            </div>
                            <div class="match-grid">
                                <div class="grid-item"><i class="fas fa-trophy"></i><div><span class="label">Prize Pool</span><b class="val" style="color:var(--accent)">‚Çπ${m.win}</b></div></div>
                                <div class="grid-item"><i class="fas fa-skull"></i><div><span class="label">Per Kill</span><b class="val">‚Çπ${m.perkill || 0}</b></div></div>
                                <div class="grid-item"><i class="fas fa-ticket"></i><div><span class="label">Entry Fee</span><b class="val" style="color:var(--gold)">‚Çπ${m.entry}</b></div></div>
                                <div class="grid-item"><i class="fas fa-clock"></i><div><span class="label">Time</span><b class="val">${m.time || 'TBA'}</b></div></div>
                            </div>
                            <div class="slot-container">
                                <div class="slot-info"><span>Filled: ${m.joined || 0}/${m.total || 48}</span><span>Left: ${(m.total || 48) - (m.joined || 0)}</span></div>
                                <div class="progress-bg"><div class="progress-fill" style="width: ${progress}%"></div></div>
                            </div>
                            <div class="action-area">${actionHtml}</div>
                        </div>
                    `;
                });
            });
        },

        // --- JOIN LOGIC ---
        async handleMatchJoin(matchId, entry) {
            if(!this.user) return this.openAuth();
            if(this.user.balance < entry) {
                alert("Insufficient Balance! Please recharge your wallet.");
                return this.openWalletModal('add');
            }

            if(!confirm(`Confirm joining for ‚Çπ${entry}? Amount will be deducted from your wallet.`)) return;

            try {
                const matchRef = doc(db, "matches", matchId);
                const userRef = doc(db, "users", this.user.phone);

                // TRANSACTIONAL UPDATE
                await updateDoc(matchRef, {
                    joined: increment(1),
                    participants: arrayUnion(this.user.phone)
                });

                await updateDoc(userRef, {
                    balance: increment(-entry)
                });

                alert("Match Joined Successfully! Good luck.");
            } catch(e) {
                alert("Error joining match: " + e.message);
            }
        },

        // --- PROFILE ENGINE ---
        renderProfile() {
            const cont = document.getElementById('app-content');
            if(!this.user) {
                cont.innerHTML = `
                    <div style="text-align:center; padding:100px 20px;">
                        <i class="fas fa-user-lock" style="font-size:3rem; color:#222; margin-bottom:20px;"></i>
                        <h3>Authentication Required</h3>
                        <p style="color:#555; margin-bottom:20px;">Login to see your stats and wallet</p>
                        <button class="btn-join" onclick="app.openAuth()">LOGIN NOW</button>
                    </div>
                `;
                return;
            }

            cont.innerHTML = `
                <div class="profile-container">
                    <div class="user-hero">
                        <div class="avatar-wrap" onclick="document.getElementById('p-file-input').click()">
                            <img src="${this.user.dpUrl || 'https://img.icons8.com/color/96/user-male-circle.png'}" class="avatar-img">
                            <div class="edit-avatar"><i class="fas fa-camera"></i></div>
                        </div>
                        <h2 style="font-family:var(--font-heading);">${this.user.name}</h2>
                        <p style="color:#666; font-size:0.8rem;">+91 ${this.user.phone}</p>
                        
                        <div class="stat-card-grid">
                            <div class="stat-box"><span class="title">Matches</span><span class="value">${this.user.matchesPlayed || 0}</span></div>
                            <div class="stat-box"><span class="title">Total Won</span><span class="value" style="color:var(--accent)">‚Çπ${this.user.totalWon || 0}</span></div>
                            <div class="stat-box"><span class="title">Kills</span><span class="value">${this.user.totalKills || 0}</span></div>
                        </div>

                        <div style="background:#000; padding:20px; border-radius:20px; border:1px solid #1a1a1a;">
                            <span style="font-size:0.7rem; color:#555; text-transform:uppercase; font-weight:800;">Wallet Balance</span>
                            <h1 style="color:var(--gold); margin:5px 0;">‚Çπ${(this.user.balance || 0).toFixed(2)}</h1>
                            <div class="wallet-methods">
                                <div class="method-btn" onclick="app.openWalletModal('add')"><i class="fas fa-plus-circle"></i><br>Deposit</div>
                                <div class="method-btn" onclick="app.openWalletModal('with')"><i class="fas fa-arrow-up-right-from-square"></i><br>Withdraw</div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top:20px;">
                        <h4 style="margin-bottom:15px; color:var(--muted); font-size:0.8rem;">ACCOUNT SECURITY</h4>
                        <div style="background:#111; border-radius:15px; border:1px solid #222;">
                            <div class="drawer-link" onclick="app.showHistory()"><i class="fas fa-history"></i> Transaction History <i class="fas fa-chevron-right" style="margin-left:auto; font-size:0.7rem;"></i></div>
                            <div class="drawer-link" onclick="app.logout()" style="color:var(--red); border:none;"><i class="fas fa-power-off"></i> Logout Account</div>
                        </div>
                    </div>
                </div>
            `;
        },

        // --- RESULTS ENGINE ---
        renderResults() {
            const cont = document.getElementById('app-content');
            const q = query(collection(db, "results"), orderBy("timestamp", "desc"), limit(20));
            onSnapshot(q, (snap) => {
                if(this.activeTab !== 'result') return;
                cont.innerHTML = "";
                if(snap.empty) {
                    cont.innerHTML = `<div style="text-align:center; padding:50px; color:#555;">No Tournament Results Yet</div>`;
                    return;
                }
                snap.forEach(d => {
                    const r = d.data();
                    cont.innerHTML += `
                        <div class="res-card">
                            <img src="${r.image || 'https://via.placeholder.com/400x200?text=Match+Result'}" class="res-banner">
                            <div class="res-info">
                                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                    <div>
                                        <span class="winner-tag">üèÜ ${r.winnerName || 'Winner TBA'}</span>
                                        <p style="font-size:0.8rem; color:#888;">${r.matchTitle || 'Official Tournament'}</p>
                                    </div>
                                    <div style="text-align:right">
                                        <span style="display:block; font-size:1.2rem; font-weight:800; color:var(--accent);">‚Çπ${r.prizeWon || 0}</span>
                                        <span style="font-size:0.6rem; color:#555;">WINNINGS</span>
                                    </div>
                                </div>
                                <div style="margin-top:15px; padding-top:10px; border-top:1px solid #222; display:flex; gap:20px;">
                                    <span style="font-size:0.75rem;"><i class="fas fa-skull" style="color:var(--red);"></i> ${r.kills || 0} Kills</span>
                                    <span style="font-size:0.75rem;"><i class="fas fa-calendar" style="color:var(--gold);"></i> ${new Date(r.timestamp).toLocaleDateString()}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            });
        },

        // --- AUTH ENGINE ---
        openAuth() {
            const modal = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            modal.style.display = 'flex';
            content.innerHTML = `
                <div class="modal-close" onclick="closeModal()">&times;</div>
                <h2 style="text-align:center; font-family:var(--font-heading); color:var(--gold);">WELCOME BACK</h2>
                <p style="text-align:center; font-size:0.8rem; color:#555; margin-bottom:20px;">Login to access tournaments</p>
                
                <div id="auth-err" style="color:var(--red); font-size:0.7rem; text-align:center; margin-bottom:10px;"></div>
                
                <input type="number" id="auth-phone" placeholder="Phone Number (10 Digits)">
                <input type="password" id="auth-pass" placeholder="Password">
                
                <button class="btn-join" style="margin-top:20px;" onclick="app.handleAuthSubmit('login')">LOGIN NOW</button>
                <p style="text-align:center; font-size:0.8rem; margin-top:20px; color:#555;">Don't have an account? <span style="color:var(--accent); font-weight:800; cursor:pointer;" onclick="app.openRegister()">Register Here</span></p>
            `;
        },

        openRegister() {
            const content = document.getElementById('modal-content');
            content.innerHTML = `
                <div class="modal-close" onclick="closeModal()">&times;</div>
                <h2 style="text-align:center; font-family:var(--font-heading); color:var(--gold);">CREATE ACCOUNT</h2>
                <p style="text-align:center; font-size:0.8rem; color:#555; margin-bottom:20px;">Join India's Most Secure Platform</p>
                
                <input type="text" id="reg-name" placeholder="Full Name">
                <input type="number" id="reg-phone" placeholder="Phone Number">
                <input type="password" id="reg-pass" placeholder="Create Password">
                
                <button class="btn-join" style="margin-top:20px;" onclick="app.handleAuthSubmit('reg')">REGISTER ACCOUNT</button>
                <p style="text-align:center; font-size:0.8rem; margin-top:20px; color:#555;" onclick="app.openAuth()">Already member? <span style="color:var(--accent);">Login</span></p>
            `;
        },

        async handleAuthSubmit(type) {
            const btn = event.target;
            btn.innerText = "PROCESSING...";
            btn.disabled = true;

            try {
                if(type === 'reg') {
                    const name = document.getElementById('reg-name').value.trim();
                    const phone = document.getElementById('reg-phone').value.trim();
                    const pass = document.getElementById('reg-pass').value.trim();

                    if(phone.length !== 10) throw new Error("Invalid Phone Number");
                    
                    const snap = await getDoc(doc(db, "users", phone));
                    if(snap.exists()) throw new Error("Phone already exists");

                    const userData = {
                        name, phone, password: pass, balance: 0, 
                        totalWon: 0, totalKills: 0, matchesPlayed: 0,
                        createdAt: Date.now()
                    };
                    await setDoc(doc(db, "users", phone), userData);
                    this.user = userData;
                } else {
                    const phone = document.getElementById('auth-phone').value.trim();
                    const pass = document.getElementById('auth-pass').value.trim();

                    const snap = await getDoc(doc(db, "users", phone));
                    if(!snap.exists() || snap.data().password !== pass) throw new Error("Invalid Phone or Password");
                    this.user = snap.data();
                }

                localStorage.setItem('sql_user_session', JSON.stringify(this.user));
                this.startWalletSync();
                closeModal();
                alert("Success! Welcome to SQL.");
                location.reload();
            } catch(e) {
                alert(e.message);
                btn.innerText = "TRY AGAIN";
                btn.disabled = false;
            }
        },

        // --- WALLET ENGINE ---
        openWalletModal(type) {
            if(!this.user) return this.openAuth();
            const modal = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            modal.style.display = 'flex';

            if(type === 'add') {
                content.innerHTML = `
                    <div class="modal-close" onclick="closeModal()">&times;</div>
                    <h2 style="color:var(--gold); text-align:center;">RECHARGE WALLET</h2>
                    <p style="font-size:0.7rem; color:#555; text-align:center;">Instant Fund Addition</p>
                    
                    <div class="stat-card-grid">
                        <div class="stat-box" onclick="document.getElementById('dep-amt').value=50">‚Çπ50</div>
                        <div class="stat-box" onclick="document.getElementById('dep-amt').value=100">‚Çπ100</div>
                        <div class="stat-box" onclick="document.getElementById('dep-amt').value=500">‚Çπ500</div>
                    </div>
                    
                    <input type="number" id="dep-amt" placeholder="Enter Amount (Min ‚Çπ20)">
                    <p style="font-size:0.6rem; color:var(--accent); margin:10px 0;">* Pay on UPI and enter UTR to verify</p>
                    
                    <button class="btn-join" style="margin-top:10px;" onclick="app.initPayment()">PROCEED TO PAY</button>
                `;
            } else {
                content.innerHTML = `
                    <div class="modal-close" onclick="closeModal()">&times;</div>
                    <h2 style="color:var(--red); text-align:center;">WITHDRAW MONEY</h2>
                    <p style="font-size:0.7rem; color:#555; text-align:center;">Available: ‚Çπ${this.user.balance}</p>
                    
                    <input type="number" id="with-amt" placeholder="Amount (Min ‚Çπ50)">
                    <input type="text" id="with-upi" placeholder="Your UPI ID (e.g. name@upi)">
                    
                    <button class="btn-join" style="margin-top:20px; background:var(--gold);" onclick="app.submitWithdraw()">SUBMIT REQUEST</button>
                `;
            }
        },

        async initPayment() {
            const amt = document.getElementById('dep-amt').value;
            if(amt < 20) return alert("Min recharge ‚Çπ20");

            const upiId = "yourname@okaxis"; // EDIT THIS
            const upiUrl = `upi://pay?pa=${upiId}&pn=SQL-TOURNAMENT&am=${amt}&cu=INR`;
            
            window.location.href = upiUrl;

            // Wait 2 sec then show UTR screen
            setTimeout(() => {
                document.getElementById('modal-content').innerHTML = `
                    <div class="modal-close" onclick="closeModal()">&times;</div>
                    <h3 style="text-align:center; color:var(--accent);">VERIFY PAYMENT</h3>
                    <p style="font-size:0.7rem; color:#555; text-align:center; margin-bottom:15px;">Enter the 12-digit UTR/Ref No. from your app</p>
                    
                    <input type="number" id="utr-input" placeholder="Enter 12 Digit UTR Number">
                    <button class="btn-join" style="margin-top:20px;" onclick="app.verifyDeposit('${amt}')">SUBMIT FOR VERIFICATION</button>
                `;
            }, 2000);
        },

        async verifyDeposit(amt) {
            const utr = document.getElementById('utr-input').value;
            if(utr.length < 10) return alert("Invalid UTR Number");

            await addDoc(collection(db, "deposits"), {
                phone: this.user.phone,
                amount: parseFloat(amt),
                utr: utr,
                status: "pending",
                timestamp: Date.now(),
                userName: this.user.name
            });

            alert("Payment details submitted! Funds will be added within 30-60 minutes after manual verification.");
            closeModal();
        },

        async submitWithdraw() {
            const amt = parseFloat(document.getElementById('with-amt').value);
            const upi = document.getElementById('with-upi').value;

            if(amt < 50) return alert("Min withdrawal ‚Çπ50");
            if(amt > this.user.balance) return alert("Insufficient Balance");
            if(!upi.includes('@')) return alert("Enter valid UPI ID");

            await updateDoc(doc(db, "users", this.user.phone), {
                balance: increment(-amt)
            });

            await addDoc(collection(db, "withdrawals"), {
                phone: this.user.phone,
                amount: amt,
                upi: upi,
                status: "pending",
                timestamp: Date.now()
            });

            alert("Withdrawal request sent! Money will be credited within 24 hours.");
            closeModal();
        },

        // --- AVATAR ENGINE ---
        async handleAvatarUpload(input) {
            if(!input.files || !input.files[0]) return;
            alert("Uploading image... Please wait.");
            
            const file = input.files[0];
            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", UPLOAD_PRESET);

            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                    method: "POST",
                    body: formData
                });
                const data = await res.json();
                const url = data.secure_url;

                await updateDoc(doc(db, "users", this.user.phone), { dpUrl: url });
                alert("Avatar Updated!");
            } catch(e) {
                alert("Upload failed. Try again.");
            }
        },

        logout() {
            if(confirm("Are you sure you want to Logout?")) {
                localStorage.clear();
                location.reload();
            }
        },

        showPolicy() {
            alert("FAIR PLAY RULES:\n1. No Emulators allowed.\n2. No hacking/scripting.\n3. Team-up leads to permanent ban.\n4. Admin decision is final.");
        }
    };

    // --- GLOBAL HELPERS ---
    window.app = app;
    window.toggleDrawer = (show) => {
        document.getElementById('side-drawer').classList.toggle('open', show);
    };
    window.closeModal = () => {
        document.getElementById('modal-overlay').style.display = 'none';
    };

    // START ENGINE
    app.init();

</script>
</body>
    </html>
